<html><head><title> </title><meta name="description" content=" " /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="preconnect" href="https://fonts.googleapis.com" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" /><link rel="stylesheet" href="tailwind.css?k= " /><script src="scripts/local_settings.js?k= "></script><script>const prod =  ;const plugin_enabled =  ;</script></head><body class="flex h-screen overflow-hidden bg-zinc-950 text-zinc-100 font-sans"><aside
  class="w-64 h-screen bg-zinc-900 text-zinc-400 border-r border-zinc-800/50 flex flex-col flex-shrink-0 select-none">

  <!-- Logo -->
  <div class="h-14 flex items-center px-5 border-b border-zinc-800/30">
    <svg class="w-5 h-5 text-teal-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5">
      </path>
    </svg>
    <span class="text-base font-semibold text-zinc-100">ArchBoard</span>
  </div>

  <!-- Navigation (rendered by JavaScript) -->
  <nav id="sidebar-nav" class="flex-1 overflow-y-auto py-3 px-3 space-y-1">
    <!-- Loading state -->
    <div class="text-zinc-500 text-sm px-2">Loading...</div>
  </nav>

  <!-- User -->
  <div class="border-t border-zinc-800/30 p-3">
    <div class="flex items-center gap-2">
      <div id="user-avatar"
        class="w-7 h-7 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white text-xs font-medium">
        ?
      </div>
      <div class="flex flex-col">
        <span id="user-name" class="text-xs font-medium text-zinc-200">...</span>
        <span id="user-host" class="text-xs text-zinc-500">...@arch</span>
      </div>
    </div>
  </div>

  <script>
    // Navigation data passed from Python
    const archboardNav =  ;
    const currentPage = ' ';
    const username = ' ';

    // Icon SVGs
    const icons = {
      dashboard: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg>`,
      system: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 01-2 2v4a2 2 0 012 2h14a2 2 0 012-2v-4a2 2 0 01-2-2m-2-4h.01M17 16h.01" />
      </svg>`,
      config: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>`,
      default: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>`,
      hyprland: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
      </svg>`,
      waybar: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 14h16M4 14v-4M8 14v-2M12 14v-4M16 14v-2M20 14v-4" />
      </svg>`,
      hyprlock: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>`,
      hypridle: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>`,
      wpaperd: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>`,
      menu: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>`
    };

    function renderSidebar() {
      const nav = document.getElementById('sidebar-nav');
      let html = '';

      archboardNav.forEach(item => {
        if (item.type === 'item') {
          const isActive = currentPage === item.id;
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.default;
          html += `<a href="${item.url}" class="flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 ${isActive ? 'bg-teal-500/10 text-teal-500 font-medium' : 'text-zinc-400 bg-transparent'}">${icon}${item.title}</a>`;
        } else if (item.type === 'group') {
          const isExpanded = item.item_ids && item.item_ids.includes(currentPage);
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.menu;
          const arrowClass = isExpanded ? 'rotate-90' : '';
          const menuClass = isExpanded ? '' : 'hidden';

          html += `
            <div class="pt-2">
              <button onclick="toggleSection('${item.id}-menu', '${item.id}-arrow')" class="flex items-center justify-between w-full gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 text-zinc-400 bg-transparent">
                <div class="flex items-center gap-2">${icon}${item.title}</div>
                <svg id="${item.id}-arrow" class="w-3 h-3 transition-transform duration-200 ${arrowClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
              <div id="${item.id}-menu" class="${menuClass} pl-6 mt-1 space-y-1">
                ${item.items.map(sub => {
            const subActive = currentPage === sub.id;
            const subIcon = sub.icon_svg || icons[sub.icon] || icons.default;
            return `<a href="${sub.url}" class="flex items-center gap-2 pl-10 pr-3 py-2 text-sm rounded-md transition-all duration-150 border-none hover:text-zinc-100 hover:bg-white/5 ${subActive ? 'text-teal-500 bg-white/5 font-medium' : 'text-zinc-500 bg-transparent'}">
              ${subIcon}
              ${sub.title}
            </a>`;
          }).join('')}
              </div>
            </div>`;
        }
      });

      nav.innerHTML = html;
    }

    function toggleSection(menuId, arrowId) {
      const menu = document.getElementById(menuId);
      const arrow = document.getElementById(arrowId);
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        arrow.classList.add('rotate-90');
      } else {
        menu.classList.add('hidden');
        arrow.classList.remove('rotate-90');
      }
    }

    // Get first nav URL (for auto-redirect)
    function getFirstNavUrl() {
      if (!archboardNav || archboardNav.length === 0) return null;
      const first = archboardNav[0];
      if (first.type === 'item') {
        return first.url;
      } else if (first.type === 'group' && first.items && first.items.length > 0) {
        return first.items[0].url;
      }
      return null;
    }

    // Set user info
    document.getElementById('user-avatar').textContent = username[0].toUpperCase();
    document.getElementById('user-name').textContent = username;
    document.getElementById('user-host').textContent = username + '@localhost';

    // Render navigation
    renderSidebar();

    // Auto-redirect from root to first nav item if no 'home' page exists
    if (window.location.pathname === '/' && currentPage === 'home') {
      const homeItem = archboardNav.find(n => n.type === 'item' && n.id === 'home');
      if (!homeItem) {
        const firstUrl = getFirstNavUrl();
        if (firstUrl && firstUrl !== '/') {
          window.location.href = firstUrl;
        }
      }
    }
  </script>
</aside><main class="flex flex-col flex-1 overflow-hidden min-w-0"><header class="flex items-center justify-between px-6 py-4 bg-zinc-950/80 border-b border-zinc-800/50">
    <div class="flex items-center gap-3 text-zinc-100">
        <svg class="w-5 h-5 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span class="text-lg font-medium">Dashboard</span>
    </div>

    <div class="flex items-center gap-3">
        <div onclick="openSearch()"
            class="flex items-center gap-2 px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-500 text-sm hover:border-teal-500 transition-colors cursor-pointer">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <span>Search...</span>
            <kbd class="text-xs px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">⌘K</kbd>
        </div>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Notifications">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
        </button>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Settings">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
</header><div class="flex-1 overflow-y-auto overflow-x-hidden p-6 w-full scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent"><div><div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="flex items-center gap-3 text-xl font-semibold text-zinc-100">
            <svg class="w-6 h-6 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            Welcome,  
        </h1>
        <p class="text-sm text-zinc-500 mt-1">Your Arch Linux configuration manager</p>
    </div>
    <button
        class="inline-flex items-center gap-2 px-5 py-2.5 bg-gradient-to-br from-teal-500 to-teal-600 text-white border-none rounded-lg text-sm font-medium cursor-pointer transition-all duration-150 hover:from-teal-400 hover:to-teal-500 hover:-translate-y-px hover:shadow-lg hover:shadow-teal-500/20">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        New Config
    </button>
</div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">

    <!-- CPU Usage -->
    <div
        class="bg-gradient-to-br from-zinc-900 to-zinc-800/30 border border-zinc-800 rounded-xl p-5 relative transition-all duration-200 hover:border-teal-500 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-teal-500/10">
        <div class="flex items-center justify-between mb-3">
            <span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">CPU Usage</span>
            <div class="w-10 h-10 rounded-lg bg-teal-500/10 flex items-center justify-center text-teal-500">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                </svg>
            </div>
        </div>
        <div id="stat-cpu-value" class="text-3xl font-bold text-zinc-100">--%</div>
        <div class="text-sm text-zinc-500">Overall processor load</div>
        <div class="mt-3 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
            <div id="stat-cpu-bar" class="h-full bg-teal-500 rounded-full transition-all duration-500"
                style="width: 0%"></div>
        </div>
    </div>

    <!-- Memory Usage -->
    <div
        class="bg-gradient-to-br from-zinc-900 to-zinc-800/30 border border-zinc-800 rounded-xl p-5 relative transition-all duration-200 hover:border-teal-500 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-teal-500/10">
        <div class="flex items-center justify-between mb-3">
            <span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">Memory Usage</span>
            <div class="w-10 h-10 rounded-lg bg-teal-500/10 flex items-center justify-center text-teal-500">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
            </div>
        </div>
        <div id="stat-memory-value" class="text-3xl font-bold text-zinc-100">--%</div>
        <div class="text-sm text-zinc-500">RAM utilization</div>
        <div class="mt-3 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
            <div id="stat-memory-bar" class="h-full bg-emerald-500 rounded-full transition-all duration-500"
                style="width: 0%"></div>
        </div>
    </div>

    <!-- Disk Usage -->
    <div
        class="bg-gradient-to-br from-zinc-900 to-zinc-800/30 border border-zinc-800 rounded-xl p-5 relative transition-all duration-200 hover:border-teal-500 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-teal-500/10">
        <div class="flex items-center justify-between mb-3">
            <span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">Disk Usage</span>
            <div class="w-10 h-10 rounded-lg bg-teal-500/10 flex items-center justify-center text-teal-500">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7c-2 0-3 1-3 3z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 4v3m6-3v3" />
                </svg>
            </div>
        </div>
        <div id="stat-disk-value" class="text-3xl font-bold text-zinc-100">--%</div>
        <div id="stat-disk-details" class="text-sm text-zinc-500">-- / -- (-- free)</div>
        <div class="mt-3 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
            <div id="stat-disk-bar" class="h-full bg-amber-500 rounded-full transition-all duration-500"
                style="width: 0%"></div>
        </div>
    </div>

</div><div class="grid grid-cols-2 md:grid-cols-4 gap-3">

    <a href="/hyprland"
        class="group flex items-center gap-4 p-4 bg-zinc-900 border border-zinc-800 rounded-xl text-zinc-400 no-underline transition-all duration-200 hover:bg-teal-500/10 hover:border-teal-500 hover:text-zinc-100">
        <div
            class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center transition-all duration-200 group-hover:text-teal-500 group-hover:scale-110">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
            </svg>
        </div>
        <div>
            <div class="font-medium text-sm">Hyprland</div>
            <div class="text-xs text-zinc-500">Window manager</div>
        </div>
    </a>

    <a href="/waybar"
        class="group flex items-center gap-4 p-4 bg-zinc-900 border border-zinc-800 rounded-xl text-zinc-400 no-underline transition-all duration-200 hover:bg-teal-500/10 hover:border-teal-500 hover:text-zinc-100">
        <div
            class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center transition-all duration-200 group-hover:text-teal-500 group-hover:scale-110">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        </div>
        <div>
            <div class="font-medium text-sm">Waybar</div>
            <div class="text-xs text-zinc-500">Status bar</div>
        </div>
    </a>

    <a href="/hyprlock"
        class="group flex items-center gap-4 p-4 bg-zinc-900 border border-zinc-800 rounded-xl text-zinc-400 no-underline transition-all duration-200 hover:bg-teal-500/10 hover:border-teal-500 hover:text-zinc-100">
        <div
            class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center transition-all duration-200 group-hover:text-teal-500 group-hover:scale-110">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
        </div>
        <div>
            <div class="font-medium text-sm">Hyprlock</div>
            <div class="text-xs text-zinc-500">Lock screen</div>
        </div>
    </a>

    <a href="/hypridle"
        class="group flex items-center gap-4 p-4 bg-zinc-900 border border-zinc-800 rounded-xl text-zinc-400 no-underline transition-all duration-200 hover:bg-teal-500/10 hover:border-teal-500 hover:text-zinc-100">
        <div
            class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center transition-all duration-200 group-hover:text-teal-500 group-hover:scale-110">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </div>
        <div>
            <div class="font-medium text-sm">Hypridle</div>
            <div class="text-xs text-zinc-500">Idle daemon</div>
        </div>
    </a>

</div></div></div><footer
    class="flex items-center justify-between px-6 py-3 bg-zinc-950/90 border-t border-zinc-800/50 text-xs text-zinc-500">
    <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-teal-500 animate-pulse"></span>
            <span>System Online</span>
        </div>
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Last sync: just now</span>
        </div>
    </div>

    <div class="flex gap-4">
        <a href="#" class="hover:text-teal-400 transition-colors">Documentation</a>
        <a href="#" class="hover:text-teal-400 transition-colors">GitHub</a>
        <span class="text-zinc-600">v1.0.0</span>
    </div>
</footer></main><!-- Search Modal (Command Palette) -->
<div id="search-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div id="search-backdrop"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0" aria-hidden="true"
        onclick="closeSearch()"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-start justify-center p-4 text-center sm:p-0 mt-20">
        <div id="search-panel"
            class="relative transform overflow-hidden rounded-xl bg-zinc-900 border border-zinc-800 text-left shadow-2xl transition-all duration-300 scale-95 opacity-0 sm:w-full sm:max-w-2xl ring-1 ring-white/10">
            <!-- Search Input -->
            <div class="relative flex items-center border-b border-zinc-800/50 p-4 sticky top-0 bg-zinc-900 z-10">
                <svg class="h-6 w-6 text-teal-500 pointer-events-none transition-colors duration-200" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="search-input"
                    class="h-full w-full bg-transparent border-0 focus:ring-0 focus:outline-none text-zinc-100 placeholder-zinc-500 pl-4 text-lg font-medium"
                    placeholder="Search settings, commands, pages..." autocomplete="off">
                <div class="ml-auto flex items-center gap-2">
                    <span class="text-xs text-zinc-500 font-medium">ESC</span>
                </div>
            </div>

            <!-- Results -->
            <div id="search-results"
                class="max-h-[60vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-zinc-900">
                <div id="search-empty" class="hidden py-16 text-center">
                    <svg class="mx-auto h-12 w-12 text-zinc-700 mb-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-zinc-500 text-sm">No results found.</p>
                </div>
                <!-- Categories will be grouped or flat list? Flat list with category badges looks modern -->
                <div id="search-list" class="p-2 space-y-1">
                    <!-- Results injected here -->
                </div>
            </div>

            <!-- Footer -->
            <div
                class="bg-zinc-900/80 px-4 py-2.5 border-t border-zinc-800/50 flex justify-between items-center text-xs text-zinc-500 select-none">
                <div class="flex gap-4">
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↑↓</kbd>
                        navigate</span>
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↵</kbd>
                        select</span>
                </div>
                <div class="text-zinc-600">ArchBoard Config</div>
            </div>
        </div>
    </div>
</div>

<!-- Fuse.js -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
    // Search Data
    const searchIndex =  ;
    let fuse;
    let selectedIndex = 0;

    // Elements
    const modal = document.getElementById('search-modal');
    const backdrop = document.getElementById('search-backdrop');
    const panel = document.getElementById('search-panel');
    const input = document.getElementById('search-input');
    const list = document.getElementById('search-list');
    const empty = document.getElementById('search-empty');

    // Initialize
    function initSearch() {
        const options = {
            includeScore: true,
            distance: 100, // Reduced distance for more precise prefix matching
            threshold: 0.3, // Lower threshold = stricter matching
            keys: [
                { name: 'title', weight: 0.5 }, // Title is important
                { name: 'description', weight: 0.3 }, // Description adds context
                { name: 'keywords', weight: 0.4 }, // Keywords match specific terms
                { name: 'category', weight: 0.1 } // Category is lowest priority
            ]
        };
        fuse = new Fuse(searchIndex, options);
    }

    // Toggle Modal
    function openSearch() {
        modal.classList.remove('hidden');
        // Animate in
        requestAnimationFrame(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        });

        input.value = '';
        renderResults([]);
        input.focus();
        document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
        // Animate out
        backdrop.classList.add('opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300); // Match transition duration
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            if (modal.classList.contains('hidden')) {
                openSearch();
            } else {
                closeSearch();
            }
        }

        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeSearch();
        }

        if (!modal.classList.contains('hidden')) {
            const items = list.querySelectorAll('.search-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const selected = items[selectedIndex];
                if (selected) {
                    selected.click();
                }
            }
        }
    });

    // Input Handling
    input.addEventListener('input', (e) => {
        const query = e.target.value;
        if (!query) {
            renderResults([]);
            return;
        }

        const results = fuse.search(query);
        // Take top 20 results for performance
        renderResults(results.slice(0, 20).map(r => r.item));
    });

    // Render
    function renderResults(items) {
        list.innerHTML = '';
        selectedIndex = 0;

        if (items.length === 0 && input.value) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');

        if (items.length === 0 && !input.value) {
            return;
        }

        items.forEach((item, index) => {
            const div = document.createElement('div');
            // Improved item styling
            div.className = `search-item group flex cursor-pointer select-none items-start gap-4 rounded-lg px-4 py-3 transition-colors duration-200`;

            div.onclick = () => {
                let url = item.url;
                if (item.selector) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}highlight=${encodeURIComponent(item.selector)}`;
                }
                window.location.href = url;
            };

            const isFirst = index === 0;

            // Icon based on category? Simplify to a generic arrow for now

            div.innerHTML = `
                <div class="mt-1 flex-none text-zinc-500 group-hover:text-teal-400 transition-colors">
                   ${getCategoryIcon(item.category)}
                </div>
                <div class="flex-auto overflow-hidden">
                    <div class="flex items-center gap-2 mb-0.5">
                        <span class="inline-flex items-center rounded-md bg-zinc-800/50 border border-zinc-700/50 px-1.5 py-0.5 text-[10px] font-medium text-zinc-400 uppercase tracking-wider group-hover:border-teal-500/30 group-hover:text-teal-400 transition-colors">
                            ${item.category}
                        </span>
                    </div>
                    <div class="truncate font-semibold text-sm text-zinc-200 group-hover:text-teal-400 pl-0.5">${item.title}</div>
                    ${item.description ? `<div class="mt-0.5 truncate text-xs text-zinc-500 pl-0.5 group-hover:text-zinc-400">${item.description}</div>` : ''}
                </div>
            `;
            list.appendChild(div);
        });

        if (list.children.length > 0) {
            updateSelection(list.querySelectorAll('.search-item'));
        }
    }

    function getCategoryIcon(category) {
        // Simple mapping for icons
        if (category.toLowerCase().includes('hyprland')) return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" /></svg>`;
        return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`;
    }

    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-zinc-800');
                item.classList.remove('hover:bg-zinc-800'); // Prevent conflict
                // Ensure text colors pop
                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.add('text-teal-400');

                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('bg-zinc-800');
                item.classList.add('hover:bg-zinc-800/50'); // Subtle hover state for non-selected

                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.remove('text-teal-400');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initSearch);
</script><div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 [&.active]:opacity-100 [&.active]:pointer-events-auto" onclick="closeModal()"><div id="modal-content" class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200 [&.active]:scale-100" onclick="event.stopPropagation()"></div></div><div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-2 z-[9999] pointer-events-none"></div><script src="scripts/main.js?k= "></script><script src="scripts/api.js?k= "></script><script src="scripts/renderer.js?k= "></script><script src="scripts/utils.js?k= "></script></body></html>
<html><head><title> </title><meta name="description" content=" " /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="preconnect" href="https://fonts.googleapis.com" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" /><link rel="stylesheet" href="tailwind.css?k= " /><script src="scripts/local_settings.js?k= "></script><script>const prod =  ;const plugin_enabled =  ;</script></head><body class="flex h-screen overflow-hidden bg-zinc-950 text-zinc-100 font-sans"><aside
  class="w-64 h-screen bg-zinc-900 text-zinc-400 border-r border-zinc-800/50 flex flex-col flex-shrink-0 select-none">

  <!-- Logo -->
  <div class="h-14 flex items-center px-5 border-b border-zinc-800/30">
    <svg class="w-5 h-5 text-teal-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5">
      </path>
    </svg>
    <span class="text-base font-semibold text-zinc-100">ArchBoard</span>
  </div>

  <!-- Navigation (rendered by JavaScript) -->
  <nav id="sidebar-nav" class="flex-1 overflow-y-auto py-3 px-3 space-y-1">
    <!-- Loading state -->
    <div class="text-zinc-500 text-sm px-2">Loading...</div>
  </nav>

  <!-- User -->
  <div class="border-t border-zinc-800/30 p-3">
    <div class="flex items-center gap-2">
      <div id="user-avatar"
        class="w-7 h-7 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white text-xs font-medium">
        ?
      </div>
      <div class="flex flex-col">
        <span id="user-name" class="text-xs font-medium text-zinc-200">...</span>
        <span id="user-host" class="text-xs text-zinc-500">...@arch</span>
      </div>
    </div>
  </div>

  <script>
    // Navigation data passed from Python
    const archboardNav =  ;
    const currentPage = ' ';
    const username = ' ';

    // Icon SVGs
    const icons = {
      dashboard: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg>`,
      system: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 01-2 2v4a2 2 0 012 2h14a2 2 0 012-2v-4a2 2 0 01-2-2m-2-4h.01M17 16h.01" />
      </svg>`,
      config: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>`,
      default: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>`,
      hyprland: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
      </svg>`,
      waybar: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 14h16M4 14v-4M8 14v-2M12 14v-4M16 14v-2M20 14v-4" />
      </svg>`,
      hyprlock: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>`,
      hypridle: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>`,
      wpaperd: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>`,
      menu: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>`
    };

    function renderSidebar() {
      const nav = document.getElementById('sidebar-nav');
      let html = '';

      archboardNav.forEach(item => {
        if (item.type === 'item') {
          const isActive = currentPage === item.id;
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.default;
          html += `<a href="${item.url}" class="flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 ${isActive ? 'bg-teal-500/10 text-teal-500 font-medium' : 'text-zinc-400 bg-transparent'}">${icon}${item.title}</a>`;
        } else if (item.type === 'group') {
          const isExpanded = item.item_ids && item.item_ids.includes(currentPage);
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.menu;
          const arrowClass = isExpanded ? 'rotate-90' : '';
          const menuClass = isExpanded ? '' : 'hidden';

          html += `
            <div class="pt-2">
              <button onclick="toggleSection('${item.id}-menu', '${item.id}-arrow')" class="flex items-center justify-between w-full gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 text-zinc-400 bg-transparent">
                <div class="flex items-center gap-2">${icon}${item.title}</div>
                <svg id="${item.id}-arrow" class="w-3 h-3 transition-transform duration-200 ${arrowClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
              <div id="${item.id}-menu" class="${menuClass} pl-6 mt-1 space-y-1">
                ${item.items.map(sub => {
            const subActive = currentPage === sub.id;
            const subIcon = sub.icon_svg || icons[sub.icon] || icons.default;
            return `<a href="${sub.url}" class="flex items-center gap-2 pl-10 pr-3 py-2 text-sm rounded-md transition-all duration-150 border-none hover:text-zinc-100 hover:bg-white/5 ${subActive ? 'text-teal-500 bg-white/5 font-medium' : 'text-zinc-500 bg-transparent'}">
              ${subIcon}
              ${sub.title}
            </a>`;
          }).join('')}
              </div>
            </div>`;
        }
      });

      nav.innerHTML = html;
    }

    function toggleSection(menuId, arrowId) {
      const menu = document.getElementById(menuId);
      const arrow = document.getElementById(arrowId);
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        arrow.classList.add('rotate-90');
      } else {
        menu.classList.add('hidden');
        arrow.classList.remove('rotate-90');
      }
    }

    // Get first nav URL (for auto-redirect)
    function getFirstNavUrl() {
      if (!archboardNav || archboardNav.length === 0) return null;
      const first = archboardNav[0];
      if (first.type === 'item') {
        return first.url;
      } else if (first.type === 'group' && first.items && first.items.length > 0) {
        return first.items[0].url;
      }
      return null;
    }

    // Set user info
    document.getElementById('user-avatar').textContent = username[0].toUpperCase();
    document.getElementById('user-name').textContent = username;
    document.getElementById('user-host').textContent = username + '@localhost';

    // Render navigation
    renderSidebar();

    // Auto-redirect from root to first nav item if no 'home' page exists
    if (window.location.pathname === '/' && currentPage === 'home') {
      const homeItem = archboardNav.find(n => n.type === 'item' && n.id === 'home');
      if (!homeItem) {
        const firstUrl = getFirstNavUrl();
        if (firstUrl && firstUrl !== '/') {
          window.location.href = firstUrl;
        }
      }
    }
  </script>
</aside><main class="flex flex-col flex-1 overflow-hidden min-w-0"><header class="flex items-center justify-between px-6 py-4 bg-zinc-950/80 border-b border-zinc-800/50">
    <div class="flex items-center gap-3 text-zinc-100">
        <svg class="w-5 h-5 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span class="text-lg font-medium">Dashboard</span>
    </div>

    <div class="flex items-center gap-3">
        <div onclick="openSearch()"
            class="flex items-center gap-2 px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-500 text-sm hover:border-teal-500 transition-colors cursor-pointer">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <span>Search...</span>
            <kbd class="text-xs px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">⌘K</kbd>
        </div>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Notifications">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
        </button>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Settings">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
</header><div class="flex-1 overflow-y-auto overflow-x-hidden p-6 w-full scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent"><!-- Hyprland Config Editor -->
<div id="hyprland-editor" class="container mx-auto p-6 max-w-7xl">
    <!-- Header with Save/Reload buttons -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="flex items-center gap-3">
            <svg class="w-8 h-8 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <h1 class="text-2xl font-bold text-zinc-100">Hyprland Configuration</h1>
        </div>
        <div class="flex items-center gap-3">
            <button id="btn-reload"
                class="flex items-center gap-2 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors"
                onclick="reloadHyprland()">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Reload
            </button>
            <button id="btn-save"
                class="flex items-center gap-2 px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors shadow-lg shadow-teal-900/20"
                onclick="saveConfig()">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                </svg>
                Save
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div id="tab-nav"
        class="flex flex-wrap gap-2 mb-6 bg-zinc-900/50 p-1.5 rounded-xl border border-zinc-800/50 backdrop-blur-sm sticky top-0 z-10">
        <!-- Tabs rendered by JS -->
    </div>

    <!-- Tab Content -->
    <div id="tab-content"
        class="bg-zinc-900/50 min-h-[500px] rounded-xl border border-zinc-800/50 backdrop-blur-sm relative">
        <!-- Loading state -->
        <div class="flex flex-col items-center justify-center h-96 gap-4 text-zinc-500">
            <div class="w-10 h-10 border-4 border-zinc-800 border-t-teal-500 rounded-full animate-spin"></div>
            <span>Loading configuration...</span>
        </div>
    </div>
</div>

<script src="/scripts/hyprland.js?v= "></script></div><footer
    class="flex items-center justify-between px-6 py-3 bg-zinc-950/90 border-t border-zinc-800/50 text-xs text-zinc-500">
    <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-teal-500 animate-pulse"></span>
            <span>System Online</span>
        </div>
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Last sync: just now</span>
        </div>
    </div>

    <div class="flex gap-4">
        <a href="#" class="hover:text-teal-400 transition-colors">Documentation</a>
        <a href="#" class="hover:text-teal-400 transition-colors">GitHub</a>
        <span class="text-zinc-600">v1.0.0</span>
    </div>
</footer></main><!-- Search Modal (Command Palette) -->
<div id="search-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div id="search-backdrop"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0" aria-hidden="true"
        onclick="closeSearch()"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-start justify-center p-4 text-center sm:p-0 mt-20">
        <div id="search-panel"
            class="relative transform overflow-hidden rounded-xl bg-zinc-900 border border-zinc-800 text-left shadow-2xl transition-all duration-300 scale-95 opacity-0 sm:w-full sm:max-w-2xl ring-1 ring-white/10">
            <!-- Search Input -->
            <div class="relative flex items-center border-b border-zinc-800/50 p-4 sticky top-0 bg-zinc-900 z-10">
                <svg class="h-6 w-6 text-teal-500 pointer-events-none transition-colors duration-200" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="search-input"
                    class="h-full w-full bg-transparent border-0 focus:ring-0 focus:outline-none text-zinc-100 placeholder-zinc-500 pl-4 text-lg font-medium"
                    placeholder="Search settings, commands, pages..." autocomplete="off">
                <div class="ml-auto flex items-center gap-2">
                    <span class="text-xs text-zinc-500 font-medium">ESC</span>
                </div>
            </div>

            <!-- Results -->
            <div id="search-results"
                class="max-h-[60vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-zinc-900">
                <div id="search-empty" class="hidden py-16 text-center">
                    <svg class="mx-auto h-12 w-12 text-zinc-700 mb-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-zinc-500 text-sm">No results found.</p>
                </div>
                <!-- Categories will be grouped or flat list? Flat list with category badges looks modern -->
                <div id="search-list" class="p-2 space-y-1">
                    <!-- Results injected here -->
                </div>
            </div>

            <!-- Footer -->
            <div
                class="bg-zinc-900/80 px-4 py-2.5 border-t border-zinc-800/50 flex justify-between items-center text-xs text-zinc-500 select-none">
                <div class="flex gap-4">
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↑↓</kbd>
                        navigate</span>
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↵</kbd>
                        select</span>
                </div>
                <div class="text-zinc-600">ArchBoard Config</div>
            </div>
        </div>
    </div>
</div>

<!-- Fuse.js -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
    // Search Data
    const searchIndex =  ;
    let fuse;
    let selectedIndex = 0;

    // Elements
    const modal = document.getElementById('search-modal');
    const backdrop = document.getElementById('search-backdrop');
    const panel = document.getElementById('search-panel');
    const input = document.getElementById('search-input');
    const list = document.getElementById('search-list');
    const empty = document.getElementById('search-empty');

    // Initialize
    function initSearch() {
        const options = {
            includeScore: true,
            distance: 100, // Reduced distance for more precise prefix matching
            threshold: 0.3, // Lower threshold = stricter matching
            keys: [
                { name: 'title', weight: 0.5 }, // Title is important
                { name: 'description', weight: 0.3 }, // Description adds context
                { name: 'keywords', weight: 0.4 }, // Keywords match specific terms
                { name: 'category', weight: 0.1 } // Category is lowest priority
            ]
        };
        fuse = new Fuse(searchIndex, options);
    }

    // Toggle Modal
    function openSearch() {
        modal.classList.remove('hidden');
        // Animate in
        requestAnimationFrame(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        });

        input.value = '';
        renderResults([]);
        input.focus();
        document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
        // Animate out
        backdrop.classList.add('opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300); // Match transition duration
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            if (modal.classList.contains('hidden')) {
                openSearch();
            } else {
                closeSearch();
            }
        }

        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeSearch();
        }

        if (!modal.classList.contains('hidden')) {
            const items = list.querySelectorAll('.search-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const selected = items[selectedIndex];
                if (selected) {
                    selected.click();
                }
            }
        }
    });

    // Input Handling
    input.addEventListener('input', (e) => {
        const query = e.target.value;
        if (!query) {
            renderResults([]);
            return;
        }

        const results = fuse.search(query);
        // Take top 20 results for performance
        renderResults(results.slice(0, 20).map(r => r.item));
    });

    // Render
    function renderResults(items) {
        list.innerHTML = '';
        selectedIndex = 0;

        if (items.length === 0 && input.value) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');

        if (items.length === 0 && !input.value) {
            return;
        }

        items.forEach((item, index) => {
            const div = document.createElement('div');
            // Improved item styling
            div.className = `search-item group flex cursor-pointer select-none items-start gap-4 rounded-lg px-4 py-3 transition-colors duration-200`;

            div.onclick = () => {
                let url = item.url;
                if (item.selector) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}highlight=${encodeURIComponent(item.selector)}`;
                }
                window.location.href = url;
            };

            const isFirst = index === 0;

            // Icon based on category? Simplify to a generic arrow for now

            div.innerHTML = `
                <div class="mt-1 flex-none text-zinc-500 group-hover:text-teal-400 transition-colors">
                   ${getCategoryIcon(item.category)}
                </div>
                <div class="flex-auto overflow-hidden">
                    <div class="flex items-center gap-2 mb-0.5">
                        <span class="inline-flex items-center rounded-md bg-zinc-800/50 border border-zinc-700/50 px-1.5 py-0.5 text-[10px] font-medium text-zinc-400 uppercase tracking-wider group-hover:border-teal-500/30 group-hover:text-teal-400 transition-colors">
                            ${item.category}
                        </span>
                    </div>
                    <div class="truncate font-semibold text-sm text-zinc-200 group-hover:text-teal-400 pl-0.5">${item.title}</div>
                    ${item.description ? `<div class="mt-0.5 truncate text-xs text-zinc-500 pl-0.5 group-hover:text-zinc-400">${item.description}</div>` : ''}
                </div>
            `;
            list.appendChild(div);
        });

        if (list.children.length > 0) {
            updateSelection(list.querySelectorAll('.search-item'));
        }
    }

    function getCategoryIcon(category) {
        // Simple mapping for icons
        if (category.toLowerCase().includes('hyprland')) return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" /></svg>`;
        return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`;
    }

    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-zinc-800');
                item.classList.remove('hover:bg-zinc-800'); // Prevent conflict
                // Ensure text colors pop
                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.add('text-teal-400');

                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('bg-zinc-800');
                item.classList.add('hover:bg-zinc-800/50'); // Subtle hover state for non-selected

                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.remove('text-teal-400');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initSearch);
</script><div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 [&.active]:opacity-100 [&.active]:pointer-events-auto" onclick="closeModal()"><div id="modal-content" class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200 [&.active]:scale-100" onclick="event.stopPropagation()"></div></div><div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-2 z-[9999] pointer-events-none"></div><script src="scripts/main.js?k= "></script><script src="scripts/api.js?k= "></script><script src="scripts/renderer.js?k= "></script><script src="scripts/utils.js?k= "></script></body></html>
<html><head><title> </title><meta name="description" content=" " /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="preconnect" href="https://fonts.googleapis.com" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" /><link rel="stylesheet" href="tailwind.css?k= " /><script src="scripts/local_settings.js?k= "></script><script>const prod =  ;const plugin_enabled =  ;</script></head><body class="flex h-screen overflow-hidden bg-zinc-950 text-zinc-100 font-sans"><aside
  class="w-64 h-screen bg-zinc-900 text-zinc-400 border-r border-zinc-800/50 flex flex-col flex-shrink-0 select-none">

  <!-- Logo -->
  <div class="h-14 flex items-center px-5 border-b border-zinc-800/30">
    <svg class="w-5 h-5 text-teal-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5">
      </path>
    </svg>
    <span class="text-base font-semibold text-zinc-100">ArchBoard</span>
  </div>

  <!-- Navigation (rendered by JavaScript) -->
  <nav id="sidebar-nav" class="flex-1 overflow-y-auto py-3 px-3 space-y-1">
    <!-- Loading state -->
    <div class="text-zinc-500 text-sm px-2">Loading...</div>
  </nav>

  <!-- User -->
  <div class="border-t border-zinc-800/30 p-3">
    <div class="flex items-center gap-2">
      <div id="user-avatar"
        class="w-7 h-7 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white text-xs font-medium">
        ?
      </div>
      <div class="flex flex-col">
        <span id="user-name" class="text-xs font-medium text-zinc-200">...</span>
        <span id="user-host" class="text-xs text-zinc-500">...@arch</span>
      </div>
    </div>
  </div>

  <script>
    // Navigation data passed from Python
    const archboardNav =  ;
    const currentPage = ' ';
    const username = ' ';

    // Icon SVGs
    const icons = {
      dashboard: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg>`,
      system: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 01-2 2v4a2 2 0 012 2h14a2 2 0 012-2v-4a2 2 0 01-2-2m-2-4h.01M17 16h.01" />
      </svg>`,
      config: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>`,
      default: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>`,
      hyprland: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
      </svg>`,
      waybar: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 14h16M4 14v-4M8 14v-2M12 14v-4M16 14v-2M20 14v-4" />
      </svg>`,
      hyprlock: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>`,
      hypridle: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>`,
      wpaperd: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>`,
      menu: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>`
    };

    function renderSidebar() {
      const nav = document.getElementById('sidebar-nav');
      let html = '';

      archboardNav.forEach(item => {
        if (item.type === 'item') {
          const isActive = currentPage === item.id;
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.default;
          html += `<a href="${item.url}" class="flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 ${isActive ? 'bg-teal-500/10 text-teal-500 font-medium' : 'text-zinc-400 bg-transparent'}">${icon}${item.title}</a>`;
        } else if (item.type === 'group') {
          const isExpanded = item.item_ids && item.item_ids.includes(currentPage);
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.menu;
          const arrowClass = isExpanded ? 'rotate-90' : '';
          const menuClass = isExpanded ? '' : 'hidden';

          html += `
            <div class="pt-2">
              <button onclick="toggleSection('${item.id}-menu', '${item.id}-arrow')" class="flex items-center justify-between w-full gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 text-zinc-400 bg-transparent">
                <div class="flex items-center gap-2">${icon}${item.title}</div>
                <svg id="${item.id}-arrow" class="w-3 h-3 transition-transform duration-200 ${arrowClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
              <div id="${item.id}-menu" class="${menuClass} pl-6 mt-1 space-y-1">
                ${item.items.map(sub => {
            const subActive = currentPage === sub.id;
            const subIcon = sub.icon_svg || icons[sub.icon] || icons.default;
            return `<a href="${sub.url}" class="flex items-center gap-2 pl-10 pr-3 py-2 text-sm rounded-md transition-all duration-150 border-none hover:text-zinc-100 hover:bg-white/5 ${subActive ? 'text-teal-500 bg-white/5 font-medium' : 'text-zinc-500 bg-transparent'}">
              ${subIcon}
              ${sub.title}
            </a>`;
          }).join('')}
              </div>
            </div>`;
        }
      });

      nav.innerHTML = html;
    }

    function toggleSection(menuId, arrowId) {
      const menu = document.getElementById(menuId);
      const arrow = document.getElementById(arrowId);
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        arrow.classList.add('rotate-90');
      } else {
        menu.classList.add('hidden');
        arrow.classList.remove('rotate-90');
      }
    }

    // Get first nav URL (for auto-redirect)
    function getFirstNavUrl() {
      if (!archboardNav || archboardNav.length === 0) return null;
      const first = archboardNav[0];
      if (first.type === 'item') {
        return first.url;
      } else if (first.type === 'group' && first.items && first.items.length > 0) {
        return first.items[0].url;
      }
      return null;
    }

    // Set user info
    document.getElementById('user-avatar').textContent = username[0].toUpperCase();
    document.getElementById('user-name').textContent = username;
    document.getElementById('user-host').textContent = username + '@localhost';

    // Render navigation
    renderSidebar();

    // Auto-redirect from root to first nav item if no 'home' page exists
    if (window.location.pathname === '/' && currentPage === 'home') {
      const homeItem = archboardNav.find(n => n.type === 'item' && n.id === 'home');
      if (!homeItem) {
        const firstUrl = getFirstNavUrl();
        if (firstUrl && firstUrl !== '/') {
          window.location.href = firstUrl;
        }
      }
    }
  </script>
</aside><main class="flex flex-col flex-1 overflow-hidden min-w-0"><header class="flex items-center justify-between px-6 py-4 bg-zinc-950/80 border-b border-zinc-800/50">
    <div class="flex items-center gap-3 text-zinc-100">
        <svg class="w-5 h-5 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span class="text-lg font-medium">Dashboard</span>
    </div>

    <div class="flex items-center gap-3">
        <div onclick="openSearch()"
            class="flex items-center gap-2 px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-500 text-sm hover:border-teal-500 transition-colors cursor-pointer">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <span>Search...</span>
            <kbd class="text-xs px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">⌘K</kbd>
        </div>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Notifications">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
        </button>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Settings">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
</header><div class="flex-1 overflow-y-auto overflow-x-hidden p-6 w-full scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent"><div class="flex flex-col items-center justify-center p-12 text-zinc-500"><svg class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z">pathpath</svg><h2 class="text-xl font-medium text-zinc-300">System Settings</h2><p class="mt-2 text-sm">This module is under construction.</p></div></div><footer
    class="flex items-center justify-between px-6 py-3 bg-zinc-950/90 border-t border-zinc-800/50 text-xs text-zinc-500">
    <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-teal-500 animate-pulse"></span>
            <span>System Online</span>
        </div>
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Last sync: just now</span>
        </div>
    </div>

    <div class="flex gap-4">
        <a href="#" class="hover:text-teal-400 transition-colors">Documentation</a>
        <a href="#" class="hover:text-teal-400 transition-colors">GitHub</a>
        <span class="text-zinc-600">v1.0.0</span>
    </div>
</footer></main><!-- Search Modal (Command Palette) -->
<div id="search-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div id="search-backdrop"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0" aria-hidden="true"
        onclick="closeSearch()"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-start justify-center p-4 text-center sm:p-0 mt-20">
        <div id="search-panel"
            class="relative transform overflow-hidden rounded-xl bg-zinc-900 border border-zinc-800 text-left shadow-2xl transition-all duration-300 scale-95 opacity-0 sm:w-full sm:max-w-2xl ring-1 ring-white/10">
            <!-- Search Input -->
            <div class="relative flex items-center border-b border-zinc-800/50 p-4 sticky top-0 bg-zinc-900 z-10">
                <svg class="h-6 w-6 text-teal-500 pointer-events-none transition-colors duration-200" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="search-input"
                    class="h-full w-full bg-transparent border-0 focus:ring-0 focus:outline-none text-zinc-100 placeholder-zinc-500 pl-4 text-lg font-medium"
                    placeholder="Search settings, commands, pages..." autocomplete="off">
                <div class="ml-auto flex items-center gap-2">
                    <span class="text-xs text-zinc-500 font-medium">ESC</span>
                </div>
            </div>

            <!-- Results -->
            <div id="search-results"
                class="max-h-[60vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-zinc-900">
                <div id="search-empty" class="hidden py-16 text-center">
                    <svg class="mx-auto h-12 w-12 text-zinc-700 mb-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-zinc-500 text-sm">No results found.</p>
                </div>
                <!-- Categories will be grouped or flat list? Flat list with category badges looks modern -->
                <div id="search-list" class="p-2 space-y-1">
                    <!-- Results injected here -->
                </div>
            </div>

            <!-- Footer -->
            <div
                class="bg-zinc-900/80 px-4 py-2.5 border-t border-zinc-800/50 flex justify-between items-center text-xs text-zinc-500 select-none">
                <div class="flex gap-4">
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↑↓</kbd>
                        navigate</span>
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↵</kbd>
                        select</span>
                </div>
                <div class="text-zinc-600">ArchBoard Config</div>
            </div>
        </div>
    </div>
</div>

<!-- Fuse.js -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
    // Search Data
    const searchIndex =  ;
    let fuse;
    let selectedIndex = 0;

    // Elements
    const modal = document.getElementById('search-modal');
    const backdrop = document.getElementById('search-backdrop');
    const panel = document.getElementById('search-panel');
    const input = document.getElementById('search-input');
    const list = document.getElementById('search-list');
    const empty = document.getElementById('search-empty');

    // Initialize
    function initSearch() {
        const options = {
            includeScore: true,
            distance: 100, // Reduced distance for more precise prefix matching
            threshold: 0.3, // Lower threshold = stricter matching
            keys: [
                { name: 'title', weight: 0.5 }, // Title is important
                { name: 'description', weight: 0.3 }, // Description adds context
                { name: 'keywords', weight: 0.4 }, // Keywords match specific terms
                { name: 'category', weight: 0.1 } // Category is lowest priority
            ]
        };
        fuse = new Fuse(searchIndex, options);
    }

    // Toggle Modal
    function openSearch() {
        modal.classList.remove('hidden');
        // Animate in
        requestAnimationFrame(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        });

        input.value = '';
        renderResults([]);
        input.focus();
        document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
        // Animate out
        backdrop.classList.add('opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300); // Match transition duration
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            if (modal.classList.contains('hidden')) {
                openSearch();
            } else {
                closeSearch();
            }
        }

        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeSearch();
        }

        if (!modal.classList.contains('hidden')) {
            const items = list.querySelectorAll('.search-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const selected = items[selectedIndex];
                if (selected) {
                    selected.click();
                }
            }
        }
    });

    // Input Handling
    input.addEventListener('input', (e) => {
        const query = e.target.value;
        if (!query) {
            renderResults([]);
            return;
        }

        const results = fuse.search(query);
        // Take top 20 results for performance
        renderResults(results.slice(0, 20).map(r => r.item));
    });

    // Render
    function renderResults(items) {
        list.innerHTML = '';
        selectedIndex = 0;

        if (items.length === 0 && input.value) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');

        if (items.length === 0 && !input.value) {
            return;
        }

        items.forEach((item, index) => {
            const div = document.createElement('div');
            // Improved item styling
            div.className = `search-item group flex cursor-pointer select-none items-start gap-4 rounded-lg px-4 py-3 transition-colors duration-200`;

            div.onclick = () => {
                let url = item.url;
                if (item.selector) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}highlight=${encodeURIComponent(item.selector)}`;
                }
                window.location.href = url;
            };

            const isFirst = index === 0;

            // Icon based on category? Simplify to a generic arrow for now

            div.innerHTML = `
                <div class="mt-1 flex-none text-zinc-500 group-hover:text-teal-400 transition-colors">
                   ${getCategoryIcon(item.category)}
                </div>
                <div class="flex-auto overflow-hidden">
                    <div class="flex items-center gap-2 mb-0.5">
                        <span class="inline-flex items-center rounded-md bg-zinc-800/50 border border-zinc-700/50 px-1.5 py-0.5 text-[10px] font-medium text-zinc-400 uppercase tracking-wider group-hover:border-teal-500/30 group-hover:text-teal-400 transition-colors">
                            ${item.category}
                        </span>
                    </div>
                    <div class="truncate font-semibold text-sm text-zinc-200 group-hover:text-teal-400 pl-0.5">${item.title}</div>
                    ${item.description ? `<div class="mt-0.5 truncate text-xs text-zinc-500 pl-0.5 group-hover:text-zinc-400">${item.description}</div>` : ''}
                </div>
            `;
            list.appendChild(div);
        });

        if (list.children.length > 0) {
            updateSelection(list.querySelectorAll('.search-item'));
        }
    }

    function getCategoryIcon(category) {
        // Simple mapping for icons
        if (category.toLowerCase().includes('hyprland')) return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" /></svg>`;
        return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`;
    }

    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-zinc-800');
                item.classList.remove('hover:bg-zinc-800'); // Prevent conflict
                // Ensure text colors pop
                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.add('text-teal-400');

                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('bg-zinc-800');
                item.classList.add('hover:bg-zinc-800/50'); // Subtle hover state for non-selected

                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.remove('text-teal-400');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initSearch);
</script><div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 [&.active]:opacity-100 [&.active]:pointer-events-auto" onclick="closeModal()"><div id="modal-content" class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200 [&.active]:scale-100" onclick="event.stopPropagation()"></div></div><div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-2 z-[9999] pointer-events-none"></div><script src="scripts/main.js?k= "></script><script src="scripts/api.js?k= "></script><script src="scripts/renderer.js?k= "></script><script src="scripts/utils.js?k= "></script></body></html>
<html><head><title> </title><meta name="description" content=" " /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="preconnect" href="https://fonts.googleapis.com" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" /><link rel="stylesheet" href="tailwind.css?k= " /><script src="scripts/local_settings.js?k= "></script><script>const prod =  ;const plugin_enabled =  ;</script></head><body class="flex h-screen overflow-hidden bg-zinc-950 text-zinc-100 font-sans"><aside
  class="w-64 h-screen bg-zinc-900 text-zinc-400 border-r border-zinc-800/50 flex flex-col flex-shrink-0 select-none">

  <!-- Logo -->
  <div class="h-14 flex items-center px-5 border-b border-zinc-800/30">
    <svg class="w-5 h-5 text-teal-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5">
      </path>
    </svg>
    <span class="text-base font-semibold text-zinc-100">ArchBoard</span>
  </div>

  <!-- Navigation (rendered by JavaScript) -->
  <nav id="sidebar-nav" class="flex-1 overflow-y-auto py-3 px-3 space-y-1">
    <!-- Loading state -->
    <div class="text-zinc-500 text-sm px-2">Loading...</div>
  </nav>

  <!-- User -->
  <div class="border-t border-zinc-800/30 p-3">
    <div class="flex items-center gap-2">
      <div id="user-avatar"
        class="w-7 h-7 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white text-xs font-medium">
        ?
      </div>
      <div class="flex flex-col">
        <span id="user-name" class="text-xs font-medium text-zinc-200">...</span>
        <span id="user-host" class="text-xs text-zinc-500">...@arch</span>
      </div>
    </div>
  </div>

  <script>
    // Navigation data passed from Python
    const archboardNav =  ;
    const currentPage = ' ';
    const username = ' ';

    // Icon SVGs
    const icons = {
      dashboard: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg>`,
      system: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 01-2 2v4a2 2 0 012 2h14a2 2 0 012-2v-4a2 2 0 01-2-2m-2-4h.01M17 16h.01" />
      </svg>`,
      config: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>`,
      default: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>`,
      hyprland: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
      </svg>`,
      waybar: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 14h16M4 14v-4M8 14v-2M12 14v-4M16 14v-2M20 14v-4" />
      </svg>`,
      hyprlock: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>`,
      hypridle: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>`,
      wpaperd: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>`,
      menu: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>`
    };

    function renderSidebar() {
      const nav = document.getElementById('sidebar-nav');
      let html = '';

      archboardNav.forEach(item => {
        if (item.type === 'item') {
          const isActive = currentPage === item.id;
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.default;
          html += `<a href="${item.url}" class="flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 ${isActive ? 'bg-teal-500/10 text-teal-500 font-medium' : 'text-zinc-400 bg-transparent'}">${icon}${item.title}</a>`;
        } else if (item.type === 'group') {
          const isExpanded = item.item_ids && item.item_ids.includes(currentPage);
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.menu;
          const arrowClass = isExpanded ? 'rotate-90' : '';
          const menuClass = isExpanded ? '' : 'hidden';

          html += `
            <div class="pt-2">
              <button onclick="toggleSection('${item.id}-menu', '${item.id}-arrow')" class="flex items-center justify-between w-full gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 text-zinc-400 bg-transparent">
                <div class="flex items-center gap-2">${icon}${item.title}</div>
                <svg id="${item.id}-arrow" class="w-3 h-3 transition-transform duration-200 ${arrowClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
              <div id="${item.id}-menu" class="${menuClass} pl-6 mt-1 space-y-1">
                ${item.items.map(sub => {
            const subActive = currentPage === sub.id;
            const subIcon = sub.icon_svg || icons[sub.icon] || icons.default;
            return `<a href="${sub.url}" class="flex items-center gap-2 pl-10 pr-3 py-2 text-sm rounded-md transition-all duration-150 border-none hover:text-zinc-100 hover:bg-white/5 ${subActive ? 'text-teal-500 bg-white/5 font-medium' : 'text-zinc-500 bg-transparent'}">
              ${subIcon}
              ${sub.title}
            </a>`;
          }).join('')}
              </div>
            </div>`;
        }
      });

      nav.innerHTML = html;
    }

    function toggleSection(menuId, arrowId) {
      const menu = document.getElementById(menuId);
      const arrow = document.getElementById(arrowId);
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        arrow.classList.add('rotate-90');
      } else {
        menu.classList.add('hidden');
        arrow.classList.remove('rotate-90');
      }
    }

    // Get first nav URL (for auto-redirect)
    function getFirstNavUrl() {
      if (!archboardNav || archboardNav.length === 0) return null;
      const first = archboardNav[0];
      if (first.type === 'item') {
        return first.url;
      } else if (first.type === 'group' && first.items && first.items.length > 0) {
        return first.items[0].url;
      }
      return null;
    }

    // Set user info
    document.getElementById('user-avatar').textContent = username[0].toUpperCase();
    document.getElementById('user-name').textContent = username;
    document.getElementById('user-host').textContent = username + '@localhost';

    // Render navigation
    renderSidebar();

    // Auto-redirect from root to first nav item if no 'home' page exists
    if (window.location.pathname === '/' && currentPage === 'home') {
      const homeItem = archboardNav.find(n => n.type === 'item' && n.id === 'home');
      if (!homeItem) {
        const firstUrl = getFirstNavUrl();
        if (firstUrl && firstUrl !== '/') {
          window.location.href = firstUrl;
        }
      }
    }
  </script>
</aside><main class="flex flex-col flex-1 overflow-hidden min-w-0"><header class="flex items-center justify-between px-6 py-4 bg-zinc-950/80 border-b border-zinc-800/50">
    <div class="flex items-center gap-3 text-zinc-100">
        <svg class="w-5 h-5 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span class="text-lg font-medium">Dashboard</span>
    </div>

    <div class="flex items-center gap-3">
        <div onclick="openSearch()"
            class="flex items-center gap-2 px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-500 text-sm hover:border-teal-500 transition-colors cursor-pointer">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <span>Search...</span>
            <kbd class="text-xs px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">⌘K</kbd>
        </div>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Notifications">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
        </button>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Settings">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
</header><div class="flex-1 overflow-y-auto overflow-x-hidden p-6 w-full scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent"><div class="flex h-full gap-6 p-6 overflow-hidden">

    <!-- LEFT PANEL: MODULES & LAYOUT -->
    <div class="w-1/3 bg-[#18181b] rounded-xl border border-[#27272a] overflow-hidden flex flex-col">

        <div class="p-5 border-b border-[#27272a] flex flex-col gap-4 bg-[#27272a]/30">

            <!-- General Settings -->
            <div class="grid grid-cols-2 gap-2">
                <select id="setting-layer"
                    class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors cursor-pointer">
                    <option value="top">Top Layer</option>
                    <option value="bottom">Bottom Layer</option>
                </select>

                <select id="setting-position"
                    class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors cursor-pointer">
                    <option value="top">Top Bar</option>
                    <option value="bottom">Bottom Bar</option>
                    <option value="left">Left Bar</option>
                    <option value="right">Right Bar</option>
                </select>
            </div>

            <div class="relative">
                <input type="text" id="search-modules" placeholder="Search modules..."
                    class="w-full bg-[#27272a] text-[#f4f4f5] rounded-lg px-4 py-2 border border-[#3f3f46] outline-none transition-all focus:border-teal-500 focus:ring-1 focus:ring-teal-500/50">
                <svg class="w-4 h-4 text-[#71717a] absolute right-3 top-3 pointer-events-none" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
        </div>

        <div id="modules-container"
            class="flex-1 overflow-y-auto p-2 flex flex-col gap-6 scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent">

            <!-- Left Modules -->
            <div>
                <h3
                    class="text-xs font-semibold text-zinc-400 uppercase tracking-wide mb-3 pl-1 flex items-center gap-2 after:content-[''] after:flex-1 after:h-px after:bg-zinc-800">
                    Modules Left</h3>
                <div id="list-left"
                    class="min-h-[50px] p-1 bg-black/20 rounded-lg flex flex-col gap-2 border border-[#27272a]"></div>
            </div>

            <!-- Center Modules -->
            <div>
                <h3
                    class="text-xs font-semibold text-zinc-400 uppercase tracking-wide mb-3 pl-1 flex items-center gap-2 after:content-[''] after:flex-1 after:h-px after:bg-zinc-800">
                    Modules Center</h3>
                <div id="list-center"
                    class="min-h-[50px] p-1 bg-black/20 rounded-lg flex flex-col gap-2 border border-[#27272a]"></div>
            </div>

            <!-- Right Modules -->
            <div>
                <h3
                    class="text-xs font-semibold text-zinc-400 uppercase tracking-wide mb-3 pl-1 flex items-center gap-2 after:content-[''] after:flex-1 after:h-px after:bg-zinc-800">
                    Modules Right</h3>
                <div id="list-right"
                    class="min-h-[50px] p-1 bg-black/20 rounded-lg flex flex-col gap-2 border border-[#27272a]"></div>
            </div>

            <!-- Available/Disabled Modules -->
            <div>
                <h3
                    class="text-xs font-semibold text-zinc-400 uppercase tracking-wide mb-3 pl-1 flex items-center gap-2 after:content-[''] after:flex-1 after:h-px after:bg-zinc-800">
                    Available / Disabled</h3>
                <div id="list-available"
                    class="min-h-[50px] p-1 bg-black/20 rounded-lg flex flex-col gap-2 border border-[#27272a]"></div>
            </div>
        </div>
    </div>

    <!-- RIGHT PANEL: EDITOR -->
    <div class="flex-1 bg-[#18181b] rounded-xl border border-[#27272a] overflow-hidden flex flex-col">

        <div id="editor-container" class="flex-1 p-6 overflow-y-auto hidden">

            <div class="flex items-center justify-between mb-6">

                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-teal-500/10 flex items-center justify-center text-teal-500">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        </svg>
                    </div>

                    <div>
                        <h2 id="module-title" class="text-lg font-medium text-white">Module</h2>
                        <p id="module-type-display" class="text-xs text-zinc-500">Type: clock</p>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button id="save-btn"
                        class="flex items-center gap-2 px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white text-sm font-medium rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        Save
                    </button>
                </div>
            </div>

            <!-- TABS -->
            <div class="flex gap-1 p-1 bg-zinc-800/50 rounded-lg mb-6">
                <button id="tab-simple"
                    class="flex-1 px-4 py-2 text-sm font-medium text-zinc-400 rounded-md transition-colors hover:text-white active">Settings</button>
                <button id="tab-json"
                    class="flex-1 px-4 py-2 text-sm font-medium text-zinc-400 rounded-md transition-colors hover:text-white">JSON</button>
                <button id="tab-style"
                    class="flex-1 px-4 py-2 text-sm font-medium text-zinc-400 rounded-md transition-colors hover:text-white">Style
                    (CSS)</button>
            </div>

            <!-- FORM EDITOR -->
            <div id="view-simple">
                <!-- Generated inputs go here -->
            </div>

            <!-- CONFIG EDITOR -->
            <div id="view-json" class="mb-4 hidden">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">JSON Configuration</label>
                <textarea id="module-config"
                    class="w-full bg-zinc-800 font-mono text-sm text-zinc-200 rounded-lg p-4 border border-zinc-700 focus:border-teal-500 outline-none resize-none transition-all h-96"
                    spellcheck="false"></textarea>
            </div>

            <!-- STYLE EDITOR -->
            <div id="view-style" class="hidden">

                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-zinc-400 mb-1.5">Text Color</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="style-color-picker"
                                class="w-8 h-8 rounded border-none cursor-pointer bg-transparent">
                            <input type="text" id="style-color"
                                class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors"
                                placeholder="#ffffff" style="width: 100%">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-zinc-400 mb-1.5">Background</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="style-bg-picker"
                                class="w-8 h-8 rounded border-none cursor-pointer bg-transparent">
                            <input type="text" id="style-bg"
                                class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors"
                                placeholder="transparent" style="width: 100%">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-zinc-400 mb-1.5">Font Size</label>
                        <input type="text" id="style-font-size"
                            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors"
                            placeholder="13px" style="width: 100%">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-zinc-400 mb-1.5">Padding</label>
                        <input type="text" id="style-padding"
                            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors"
                            placeholder="0 5px" style="width: 100%">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-zinc-400 mb-1.5">Custom CSS for this module</label>
                    <textarea id="module-custom-css"
                        class="w-full bg-zinc-800 font-mono text-sm text-zinc-200 rounded-lg p-4 border border-zinc-700 focus:border-teal-500 outline-none resize-none transition-all h-48"
                        placeholder="border-radius: 5px; ..."></textarea>
                </div>
            </div>

            <div id="status-msg" class="mt-4 text-sm text-center hidden"></div>
        </div>

        <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-zinc-500 p-12">
            <svg class="w-16 h-16 mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            <p>Select a module to edit settings or style</p>
        </div>
    </div>
</div>

<script src="/scripts/waybar.js?k= "></script></div><footer
    class="flex items-center justify-between px-6 py-3 bg-zinc-950/90 border-t border-zinc-800/50 text-xs text-zinc-500">
    <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-teal-500 animate-pulse"></span>
            <span>System Online</span>
        </div>
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Last sync: just now</span>
        </div>
    </div>

    <div class="flex gap-4">
        <a href="#" class="hover:text-teal-400 transition-colors">Documentation</a>
        <a href="#" class="hover:text-teal-400 transition-colors">GitHub</a>
        <span class="text-zinc-600">v1.0.0</span>
    </div>
</footer></main><!-- Search Modal (Command Palette) -->
<div id="search-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div id="search-backdrop"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0" aria-hidden="true"
        onclick="closeSearch()"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-start justify-center p-4 text-center sm:p-0 mt-20">
        <div id="search-panel"
            class="relative transform overflow-hidden rounded-xl bg-zinc-900 border border-zinc-800 text-left shadow-2xl transition-all duration-300 scale-95 opacity-0 sm:w-full sm:max-w-2xl ring-1 ring-white/10">
            <!-- Search Input -->
            <div class="relative flex items-center border-b border-zinc-800/50 p-4 sticky top-0 bg-zinc-900 z-10">
                <svg class="h-6 w-6 text-teal-500 pointer-events-none transition-colors duration-200" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="search-input"
                    class="h-full w-full bg-transparent border-0 focus:ring-0 focus:outline-none text-zinc-100 placeholder-zinc-500 pl-4 text-lg font-medium"
                    placeholder="Search settings, commands, pages..." autocomplete="off">
                <div class="ml-auto flex items-center gap-2">
                    <span class="text-xs text-zinc-500 font-medium">ESC</span>
                </div>
            </div>

            <!-- Results -->
            <div id="search-results"
                class="max-h-[60vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-zinc-900">
                <div id="search-empty" class="hidden py-16 text-center">
                    <svg class="mx-auto h-12 w-12 text-zinc-700 mb-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-zinc-500 text-sm">No results found.</p>
                </div>
                <!-- Categories will be grouped or flat list? Flat list with category badges looks modern -->
                <div id="search-list" class="p-2 space-y-1">
                    <!-- Results injected here -->
                </div>
            </div>

            <!-- Footer -->
            <div
                class="bg-zinc-900/80 px-4 py-2.5 border-t border-zinc-800/50 flex justify-between items-center text-xs text-zinc-500 select-none">
                <div class="flex gap-4">
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↑↓</kbd>
                        navigate</span>
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↵</kbd>
                        select</span>
                </div>
                <div class="text-zinc-600">ArchBoard Config</div>
            </div>
        </div>
    </div>
</div>

<!-- Fuse.js -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
    // Search Data
    const searchIndex =  ;
    let fuse;
    let selectedIndex = 0;

    // Elements
    const modal = document.getElementById('search-modal');
    const backdrop = document.getElementById('search-backdrop');
    const panel = document.getElementById('search-panel');
    const input = document.getElementById('search-input');
    const list = document.getElementById('search-list');
    const empty = document.getElementById('search-empty');

    // Initialize
    function initSearch() {
        const options = {
            includeScore: true,
            distance: 100, // Reduced distance for more precise prefix matching
            threshold: 0.3, // Lower threshold = stricter matching
            keys: [
                { name: 'title', weight: 0.5 }, // Title is important
                { name: 'description', weight: 0.3 }, // Description adds context
                { name: 'keywords', weight: 0.4 }, // Keywords match specific terms
                { name: 'category', weight: 0.1 } // Category is lowest priority
            ]
        };
        fuse = new Fuse(searchIndex, options);
    }

    // Toggle Modal
    function openSearch() {
        modal.classList.remove('hidden');
        // Animate in
        requestAnimationFrame(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        });

        input.value = '';
        renderResults([]);
        input.focus();
        document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
        // Animate out
        backdrop.classList.add('opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300); // Match transition duration
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            if (modal.classList.contains('hidden')) {
                openSearch();
            } else {
                closeSearch();
            }
        }

        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeSearch();
        }

        if (!modal.classList.contains('hidden')) {
            const items = list.querySelectorAll('.search-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const selected = items[selectedIndex];
                if (selected) {
                    selected.click();
                }
            }
        }
    });

    // Input Handling
    input.addEventListener('input', (e) => {
        const query = e.target.value;
        if (!query) {
            renderResults([]);
            return;
        }

        const results = fuse.search(query);
        // Take top 20 results for performance
        renderResults(results.slice(0, 20).map(r => r.item));
    });

    // Render
    function renderResults(items) {
        list.innerHTML = '';
        selectedIndex = 0;

        if (items.length === 0 && input.value) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');

        if (items.length === 0 && !input.value) {
            return;
        }

        items.forEach((item, index) => {
            const div = document.createElement('div');
            // Improved item styling
            div.className = `search-item group flex cursor-pointer select-none items-start gap-4 rounded-lg px-4 py-3 transition-colors duration-200`;

            div.onclick = () => {
                let url = item.url;
                if (item.selector) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}highlight=${encodeURIComponent(item.selector)}`;
                }
                window.location.href = url;
            };

            const isFirst = index === 0;

            // Icon based on category? Simplify to a generic arrow for now

            div.innerHTML = `
                <div class="mt-1 flex-none text-zinc-500 group-hover:text-teal-400 transition-colors">
                   ${getCategoryIcon(item.category)}
                </div>
                <div class="flex-auto overflow-hidden">
                    <div class="flex items-center gap-2 mb-0.5">
                        <span class="inline-flex items-center rounded-md bg-zinc-800/50 border border-zinc-700/50 px-1.5 py-0.5 text-[10px] font-medium text-zinc-400 uppercase tracking-wider group-hover:border-teal-500/30 group-hover:text-teal-400 transition-colors">
                            ${item.category}
                        </span>
                    </div>
                    <div class="truncate font-semibold text-sm text-zinc-200 group-hover:text-teal-400 pl-0.5">${item.title}</div>
                    ${item.description ? `<div class="mt-0.5 truncate text-xs text-zinc-500 pl-0.5 group-hover:text-zinc-400">${item.description}</div>` : ''}
                </div>
            `;
            list.appendChild(div);
        });

        if (list.children.length > 0) {
            updateSelection(list.querySelectorAll('.search-item'));
        }
    }

    function getCategoryIcon(category) {
        // Simple mapping for icons
        if (category.toLowerCase().includes('hyprland')) return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" /></svg>`;
        return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`;
    }

    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-zinc-800');
                item.classList.remove('hover:bg-zinc-800'); // Prevent conflict
                // Ensure text colors pop
                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.add('text-teal-400');

                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('bg-zinc-800');
                item.classList.add('hover:bg-zinc-800/50'); // Subtle hover state for non-selected

                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.remove('text-teal-400');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initSearch);
</script><div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 [&.active]:opacity-100 [&.active]:pointer-events-auto" onclick="closeModal()"><div id="modal-content" class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200 [&.active]:scale-100" onclick="event.stopPropagation()"></div></div><div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-2 z-[9999] pointer-events-none"></div><script src="scripts/main.js?k= "></script><script src="scripts/api.js?k= "></script><script src="scripts/renderer.js?k= "></script><script src="scripts/utils.js?k= "></script></body></html>
<html><head><title> </title><meta name="description" content=" " /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="preconnect" href="https://fonts.googleapis.com" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" /><link rel="stylesheet" href="tailwind.css?k= " /><script src="scripts/local_settings.js?k= "></script><script>const prod =  ;const plugin_enabled =  ;</script></head><body class="flex h-screen overflow-hidden bg-zinc-950 text-zinc-100 font-sans"><aside
  class="w-64 h-screen bg-zinc-900 text-zinc-400 border-r border-zinc-800/50 flex flex-col flex-shrink-0 select-none">

  <!-- Logo -->
  <div class="h-14 flex items-center px-5 border-b border-zinc-800/30">
    <svg class="w-5 h-5 text-teal-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5">
      </path>
    </svg>
    <span class="text-base font-semibold text-zinc-100">ArchBoard</span>
  </div>

  <!-- Navigation (rendered by JavaScript) -->
  <nav id="sidebar-nav" class="flex-1 overflow-y-auto py-3 px-3 space-y-1">
    <!-- Loading state -->
    <div class="text-zinc-500 text-sm px-2">Loading...</div>
  </nav>

  <!-- User -->
  <div class="border-t border-zinc-800/30 p-3">
    <div class="flex items-center gap-2">
      <div id="user-avatar"
        class="w-7 h-7 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white text-xs font-medium">
        ?
      </div>
      <div class="flex flex-col">
        <span id="user-name" class="text-xs font-medium text-zinc-200">...</span>
        <span id="user-host" class="text-xs text-zinc-500">...@arch</span>
      </div>
    </div>
  </div>

  <script>
    // Navigation data passed from Python
    const archboardNav =  ;
    const currentPage = ' ';
    const username = ' ';

    // Icon SVGs
    const icons = {
      dashboard: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg>`,
      system: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 01-2 2v4a2 2 0 012 2h14a2 2 0 012-2v-4a2 2 0 01-2-2m-2-4h.01M17 16h.01" />
      </svg>`,
      config: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>`,
      default: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>`,
      hyprland: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
      </svg>`,
      waybar: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 14h16M4 14v-4M8 14v-2M12 14v-4M16 14v-2M20 14v-4" />
      </svg>`,
      hyprlock: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>`,
      hypridle: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>`,
      wpaperd: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>`,
      menu: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>`
    };

    function renderSidebar() {
      const nav = document.getElementById('sidebar-nav');
      let html = '';

      archboardNav.forEach(item => {
        if (item.type === 'item') {
          const isActive = currentPage === item.id;
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.default;
          html += `<a href="${item.url}" class="flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 ${isActive ? 'bg-teal-500/10 text-teal-500 font-medium' : 'text-zinc-400 bg-transparent'}">${icon}${item.title}</a>`;
        } else if (item.type === 'group') {
          const isExpanded = item.item_ids && item.item_ids.includes(currentPage);
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.menu;
          const arrowClass = isExpanded ? 'rotate-90' : '';
          const menuClass = isExpanded ? '' : 'hidden';

          html += `
            <div class="pt-2">
              <button onclick="toggleSection('${item.id}-menu', '${item.id}-arrow')" class="flex items-center justify-between w-full gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 text-zinc-400 bg-transparent">
                <div class="flex items-center gap-2">${icon}${item.title}</div>
                <svg id="${item.id}-arrow" class="w-3 h-3 transition-transform duration-200 ${arrowClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
              <div id="${item.id}-menu" class="${menuClass} pl-6 mt-1 space-y-1">
                ${item.items.map(sub => {
            const subActive = currentPage === sub.id;
            const subIcon = sub.icon_svg || icons[sub.icon] || icons.default;
            return `<a href="${sub.url}" class="flex items-center gap-2 pl-10 pr-3 py-2 text-sm rounded-md transition-all duration-150 border-none hover:text-zinc-100 hover:bg-white/5 ${subActive ? 'text-teal-500 bg-white/5 font-medium' : 'text-zinc-500 bg-transparent'}">
              ${subIcon}
              ${sub.title}
            </a>`;
          }).join('')}
              </div>
            </div>`;
        }
      });

      nav.innerHTML = html;
    }

    function toggleSection(menuId, arrowId) {
      const menu = document.getElementById(menuId);
      const arrow = document.getElementById(arrowId);
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        arrow.classList.add('rotate-90');
      } else {
        menu.classList.add('hidden');
        arrow.classList.remove('rotate-90');
      }
    }

    // Get first nav URL (for auto-redirect)
    function getFirstNavUrl() {
      if (!archboardNav || archboardNav.length === 0) return null;
      const first = archboardNav[0];
      if (first.type === 'item') {
        return first.url;
      } else if (first.type === 'group' && first.items && first.items.length > 0) {
        return first.items[0].url;
      }
      return null;
    }

    // Set user info
    document.getElementById('user-avatar').textContent = username[0].toUpperCase();
    document.getElementById('user-name').textContent = username;
    document.getElementById('user-host').textContent = username + '@localhost';

    // Render navigation
    renderSidebar();

    // Auto-redirect from root to first nav item if no 'home' page exists
    if (window.location.pathname === '/' && currentPage === 'home') {
      const homeItem = archboardNav.find(n => n.type === 'item' && n.id === 'home');
      if (!homeItem) {
        const firstUrl = getFirstNavUrl();
        if (firstUrl && firstUrl !== '/') {
          window.location.href = firstUrl;
        }
      }
    }
  </script>
</aside><main class="flex flex-col flex-1 overflow-hidden min-w-0"><header class="flex items-center justify-between px-6 py-4 bg-zinc-950/80 border-b border-zinc-800/50">
    <div class="flex items-center gap-3 text-zinc-100">
        <svg class="w-5 h-5 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span class="text-lg font-medium">Dashboard</span>
    </div>

    <div class="flex items-center gap-3">
        <div onclick="openSearch()"
            class="flex items-center gap-2 px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-500 text-sm hover:border-teal-500 transition-colors cursor-pointer">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <span>Search...</span>
            <kbd class="text-xs px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">⌘K</kbd>
        </div>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Notifications">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
        </button>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Settings">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
</header><div class="flex-1 overflow-y-auto overflow-x-hidden p-6 w-full scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent"><!-- Hyprlock Visual Editor Component -->
<div id="hyprlock-editor" class="container mx-auto p-6 max-w-[1920px]">
    <!-- Header with Save/Reload buttons -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-teal-500/10 rounded-lg">
                <span class="text-2xl">🔒</span>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-zinc-100">Hyprlock Configuration</h1>
                <p class="text-zinc-400 text-sm">Visual Lock Screen Editor</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <!-- Preset Selector -->
            <div id="preset-selector"
                class="flex items-center gap-3 p-1.5 bg-zinc-900 border border-zinc-800 rounded-lg">
                <!-- Will be populated by renderPresetSelector() -->
            </div>

            <button onclick="hyprlockEditor.loadConfig()"
                class="flex items-center gap-2 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors border border-zinc-700">
                <span class="material-symbols-rounded text-sm">refresh</span> Reload
            </button>
            <button onclick="hyprlockEditor.saveConfig()"
                class="flex items-center gap-2 px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors shadow-lg shadow-teal-900/20">
                <span class="material-symbols-rounded text-sm">save</span> Save Config
            </button>
        </div>
    </div>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/css2">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Noto+Sans:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* Ensure fonts are available */
        .font-caveat {
            font-family: 'Caveat', cursive;
        }

        .font-noto {
            font-family: 'Noto Sans', sans-serif;
        }
    </style>

    <!-- Main Editor Card -->
    <div class="bg-zinc-950 border border-zinc-800 rounded-xl overflow-hidden shadow-2xl flex h-[800px] relative">

        <!-- Left Sidebar: Widget Toolbox -->
        <div class="w-64 shrink-0 bg-zinc-900/50 border-r border-zinc-800 flex flex-col z-20 backdrop-blur-sm">
            <!-- ... (toolbox content same) ... -->
            <div class="p-4 border-b border-zinc-800">
                <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider flex items-center gap-2">
                    Widgets
                </h2>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="draggable-widget p-3 bg-zinc-800/50 hover:bg-zinc-800 border border-zinc-700/50 hover:border-zinc-500 rounded-lg cursor-grab active:cursor-grabbing transition-all flex items-center gap-3 group"
                    data-type="label" draggable="true">
                    <span class="text-lg opacity-60 group-hover:opacity-100 transition-opacity">T</span>
                    <span class="text-zinc-300 group-hover:text-white text-sm font-medium">Text Label</span>
                </div>
                <!-- ... other widgets ... -->
                <div class="draggable-widget p-3 bg-zinc-800/50 hover:bg-zinc-800 border border-zinc-700/50 hover:border-zinc-500 rounded-lg cursor-grab active:cursor-grabbing transition-all flex items-center gap-3 group"
                    data-type="image" draggable="true">
                    <span class="text-lg opacity-60 group-hover:opacity-100 transition-opacity">🖼️</span>
                    <span class="text-zinc-300 group-hover:text-white text-sm font-medium">Image</span>
                </div>
                <div class="draggable-widget p-3 bg-zinc-800/50 hover:bg-zinc-800 border border-zinc-700/50 hover:border-zinc-500 rounded-lg cursor-grab active:cursor-grabbing transition-all flex items-center gap-3 group"
                    data-type="shape" draggable="true">
                    <span class="text-lg opacity-60 group-hover:opacity-100 transition-opacity">⬜</span>
                    <span class="text-zinc-300 group-hover:text-white text-sm font-medium">Shape</span>
                </div>
                <div class="draggable-widget p-3 bg-zinc-800/50 hover:bg-zinc-800 border border-zinc-700/50 hover:border-zinc-500 rounded-lg cursor-grab active:cursor-grabbing transition-all flex items-center gap-3 group"
                    data-type="input-field" draggable="true">
                    <span class="text-lg opacity-60 group-hover:opacity-100 transition-opacity">🔒</span>
                    <span class="text-zinc-300 group-hover:text-white text-sm font-medium">Input Field</span>
                </div>
                <div class="draggable-widget p-3 bg-zinc-800/50 hover:bg-zinc-800 border border-zinc-700/50 hover:border-zinc-500 rounded-lg cursor-grab active:cursor-grabbing transition-all flex items-center gap-3 group"
                    data-type="background" draggable="true">
                    <span class="text-lg opacity-60 group-hover:opacity-100 transition-opacity">🌄</span>
                    <span class="text-zinc-300 group-hover:text-white text-sm font-medium">Background</span>
                </div>
            </div>
        </div>

        <!-- Main Editor Area -->
        <div class="flex-1 flex flex-col relative bg-zinc-900/20">
            <!-- Toolbar -->
            <div
                class="h-12 border-b border-zinc-800 flex items-center px-4 justify-between bg-zinc-900/50 backdrop-blur z-10">
                <div class="flex items-center gap-4 text-sm text-zinc-400">
                    <!-- Canvas Size -->
                    <div class="flex items-center gap-2">
                        <span>Canvas:</span>
                        <select id="canvas-size"
                            class="bg-zinc-950 border border-zinc-700 rounded px-2 py-1 text-xs text-white focus:outline-none focus:border-teal-500">
                            <option value="1920x1080">1920 x 1080</option>
                            <option value="2560x1440">2560 x 1440</option>
                            <option value="3840x2160">3840 x 2160</option>
                            <option value="1366x768">1366 x 768</option>
                        </select>
                    </div>

                    <!-- Zoom Controls -->
                    <div class="flex items-center gap-2 border-l border-zinc-700 pl-4">
                        <span>Zoom:</span>
                        <button onclick="hyprlockEditor.setZoom(hyprlockEditor.scale - 0.1)"
                            class="w-6 h-6 flex items-center justify-center hover:bg-zinc-800 rounded text-lg">−</button>
                        <input type="range" id="zoom-slider" min="10" max="150" value="50"
                            class="w-24 h-1 accent-teal-500 cursor-pointer">
                        <button onclick="hyprlockEditor.setZoom(hyprlockEditor.scale + 0.1)"
                            class="w-6 h-6 flex items-center justify-center hover:bg-zinc-800 rounded text-lg">+</button>
                        <span id="zoom-display" class="text-xs w-10 text-center">50%</span>
                        <button onclick="hyprlockEditor.resetZoom()"
                            class="px-2 py-1 hover:bg-zinc-800 rounded text-xs border border-zinc-700"
                            title="Reset to 50%">
                            Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Canvas Container - uses absolute positioning for the scaled canvas -->
            <div id="canvas-container" class="flex-1 overflow-auto relative"
                style="background-image: radial-gradient(circle, #333 1px, transparent 1px); background-size: 20px 20px;">

                <!-- The Canvas - absolutely centered using CSS -->
                <div id="editor-canvas" class="absolute bg-black shadow-2xl ring-1 ring-zinc-800"
                    style="width: 1920px; height: 1080px; transform: scale(0.5); transform-origin: top left; top: 50px; left: 50px;">

                    <!-- Background Layer -->
                    <div id="canvas-background-layer" class="absolute inset-0 z-0 overflow-hidden bg-black"></div>

                    <!-- Widget Layer - pointer-events-none so clicks pass through to bg layer -->
                    <div id="canvas-widgets-layer" class="absolute inset-0 z-10 pointer-events-none"></div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Properties -->
        <div class="w-80 shrink-0 bg-zinc-900/50 border-l border-zinc-800 flex flex-col z-20 backdrop-blur-sm">
            <div class="p-4 border-b border-zinc-800">
                <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider flex items-center gap-2">
                    Properties
                </h2>
            </div>
            <div id="properties-panel" class="flex-1 overflow-y-auto p-4 content-start">
                <div class="flex flex-col items-center justify-center h-full text-zinc-500 gap-2 opacity-60">
                    <span class="text-3xl">👆</span>
                    <p class="text-sm">Select a widget</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/scripts/image_picker.js?k= "></script>
    <script src="/scripts/hyprlock_editor.js?k= "></script>
    <script>
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            if (!window.hyprlockEditor) {
                window.hyprlockEditor = new HyprlockEditor();
            }
        });
    </script>
</div></div><footer
    class="flex items-center justify-between px-6 py-3 bg-zinc-950/90 border-t border-zinc-800/50 text-xs text-zinc-500">
    <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-teal-500 animate-pulse"></span>
            <span>System Online</span>
        </div>
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Last sync: just now</span>
        </div>
    </div>

    <div class="flex gap-4">
        <a href="#" class="hover:text-teal-400 transition-colors">Documentation</a>
        <a href="#" class="hover:text-teal-400 transition-colors">GitHub</a>
        <span class="text-zinc-600">v1.0.0</span>
    </div>
</footer></main><!-- Search Modal (Command Palette) -->
<div id="search-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div id="search-backdrop"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0" aria-hidden="true"
        onclick="closeSearch()"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-start justify-center p-4 text-center sm:p-0 mt-20">
        <div id="search-panel"
            class="relative transform overflow-hidden rounded-xl bg-zinc-900 border border-zinc-800 text-left shadow-2xl transition-all duration-300 scale-95 opacity-0 sm:w-full sm:max-w-2xl ring-1 ring-white/10">
            <!-- Search Input -->
            <div class="relative flex items-center border-b border-zinc-800/50 p-4 sticky top-0 bg-zinc-900 z-10">
                <svg class="h-6 w-6 text-teal-500 pointer-events-none transition-colors duration-200" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="search-input"
                    class="h-full w-full bg-transparent border-0 focus:ring-0 focus:outline-none text-zinc-100 placeholder-zinc-500 pl-4 text-lg font-medium"
                    placeholder="Search settings, commands, pages..." autocomplete="off">
                <div class="ml-auto flex items-center gap-2">
                    <span class="text-xs text-zinc-500 font-medium">ESC</span>
                </div>
            </div>

            <!-- Results -->
            <div id="search-results"
                class="max-h-[60vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-zinc-900">
                <div id="search-empty" class="hidden py-16 text-center">
                    <svg class="mx-auto h-12 w-12 text-zinc-700 mb-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-zinc-500 text-sm">No results found.</p>
                </div>
                <!-- Categories will be grouped or flat list? Flat list with category badges looks modern -->
                <div id="search-list" class="p-2 space-y-1">
                    <!-- Results injected here -->
                </div>
            </div>

            <!-- Footer -->
            <div
                class="bg-zinc-900/80 px-4 py-2.5 border-t border-zinc-800/50 flex justify-between items-center text-xs text-zinc-500 select-none">
                <div class="flex gap-4">
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↑↓</kbd>
                        navigate</span>
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↵</kbd>
                        select</span>
                </div>
                <div class="text-zinc-600">ArchBoard Config</div>
            </div>
        </div>
    </div>
</div>

<!-- Fuse.js -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
    // Search Data
    const searchIndex =  ;
    let fuse;
    let selectedIndex = 0;

    // Elements
    const modal = document.getElementById('search-modal');
    const backdrop = document.getElementById('search-backdrop');
    const panel = document.getElementById('search-panel');
    const input = document.getElementById('search-input');
    const list = document.getElementById('search-list');
    const empty = document.getElementById('search-empty');

    // Initialize
    function initSearch() {
        const options = {
            includeScore: true,
            distance: 100, // Reduced distance for more precise prefix matching
            threshold: 0.3, // Lower threshold = stricter matching
            keys: [
                { name: 'title', weight: 0.5 }, // Title is important
                { name: 'description', weight: 0.3 }, // Description adds context
                { name: 'keywords', weight: 0.4 }, // Keywords match specific terms
                { name: 'category', weight: 0.1 } // Category is lowest priority
            ]
        };
        fuse = new Fuse(searchIndex, options);
    }

    // Toggle Modal
    function openSearch() {
        modal.classList.remove('hidden');
        // Animate in
        requestAnimationFrame(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        });

        input.value = '';
        renderResults([]);
        input.focus();
        document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
        // Animate out
        backdrop.classList.add('opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300); // Match transition duration
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            if (modal.classList.contains('hidden')) {
                openSearch();
            } else {
                closeSearch();
            }
        }

        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeSearch();
        }

        if (!modal.classList.contains('hidden')) {
            const items = list.querySelectorAll('.search-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const selected = items[selectedIndex];
                if (selected) {
                    selected.click();
                }
            }
        }
    });

    // Input Handling
    input.addEventListener('input', (e) => {
        const query = e.target.value;
        if (!query) {
            renderResults([]);
            return;
        }

        const results = fuse.search(query);
        // Take top 20 results for performance
        renderResults(results.slice(0, 20).map(r => r.item));
    });

    // Render
    function renderResults(items) {
        list.innerHTML = '';
        selectedIndex = 0;

        if (items.length === 0 && input.value) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');

        if (items.length === 0 && !input.value) {
            return;
        }

        items.forEach((item, index) => {
            const div = document.createElement('div');
            // Improved item styling
            div.className = `search-item group flex cursor-pointer select-none items-start gap-4 rounded-lg px-4 py-3 transition-colors duration-200`;

            div.onclick = () => {
                let url = item.url;
                if (item.selector) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}highlight=${encodeURIComponent(item.selector)}`;
                }
                window.location.href = url;
            };

            const isFirst = index === 0;

            // Icon based on category? Simplify to a generic arrow for now

            div.innerHTML = `
                <div class="mt-1 flex-none text-zinc-500 group-hover:text-teal-400 transition-colors">
                   ${getCategoryIcon(item.category)}
                </div>
                <div class="flex-auto overflow-hidden">
                    <div class="flex items-center gap-2 mb-0.5">
                        <span class="inline-flex items-center rounded-md bg-zinc-800/50 border border-zinc-700/50 px-1.5 py-0.5 text-[10px] font-medium text-zinc-400 uppercase tracking-wider group-hover:border-teal-500/30 group-hover:text-teal-400 transition-colors">
                            ${item.category}
                        </span>
                    </div>
                    <div class="truncate font-semibold text-sm text-zinc-200 group-hover:text-teal-400 pl-0.5">${item.title}</div>
                    ${item.description ? `<div class="mt-0.5 truncate text-xs text-zinc-500 pl-0.5 group-hover:text-zinc-400">${item.description}</div>` : ''}
                </div>
            `;
            list.appendChild(div);
        });

        if (list.children.length > 0) {
            updateSelection(list.querySelectorAll('.search-item'));
        }
    }

    function getCategoryIcon(category) {
        // Simple mapping for icons
        if (category.toLowerCase().includes('hyprland')) return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" /></svg>`;
        return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`;
    }

    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-zinc-800');
                item.classList.remove('hover:bg-zinc-800'); // Prevent conflict
                // Ensure text colors pop
                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.add('text-teal-400');

                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('bg-zinc-800');
                item.classList.add('hover:bg-zinc-800/50'); // Subtle hover state for non-selected

                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.remove('text-teal-400');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initSearch);
</script><div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 [&.active]:opacity-100 [&.active]:pointer-events-auto" onclick="closeModal()"><div id="modal-content" class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200 [&.active]:scale-100" onclick="event.stopPropagation()"></div></div><div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-2 z-[9999] pointer-events-none"></div><script src="scripts/main.js?k= "></script><script src="scripts/api.js?k= "></script><script src="scripts/renderer.js?k= "></script><script src="scripts/utils.js?k= "></script></body></html>
<html><head><title> </title><meta name="description" content=" " /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="preconnect" href="https://fonts.googleapis.com" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" /><link rel="stylesheet" href="tailwind.css?k= " /><script src="scripts/local_settings.js?k= "></script><script>const prod =  ;const plugin_enabled =  ;</script></head><body class="flex h-screen overflow-hidden bg-zinc-950 text-zinc-100 font-sans"><aside
  class="w-64 h-screen bg-zinc-900 text-zinc-400 border-r border-zinc-800/50 flex flex-col flex-shrink-0 select-none">

  <!-- Logo -->
  <div class="h-14 flex items-center px-5 border-b border-zinc-800/30">
    <svg class="w-5 h-5 text-teal-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5">
      </path>
    </svg>
    <span class="text-base font-semibold text-zinc-100">ArchBoard</span>
  </div>

  <!-- Navigation (rendered by JavaScript) -->
  <nav id="sidebar-nav" class="flex-1 overflow-y-auto py-3 px-3 space-y-1">
    <!-- Loading state -->
    <div class="text-zinc-500 text-sm px-2">Loading...</div>
  </nav>

  <!-- User -->
  <div class="border-t border-zinc-800/30 p-3">
    <div class="flex items-center gap-2">
      <div id="user-avatar"
        class="w-7 h-7 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white text-xs font-medium">
        ?
      </div>
      <div class="flex flex-col">
        <span id="user-name" class="text-xs font-medium text-zinc-200">...</span>
        <span id="user-host" class="text-xs text-zinc-500">...@arch</span>
      </div>
    </div>
  </div>

  <script>
    // Navigation data passed from Python
    const archboardNav =  ;
    const currentPage = ' ';
    const username = ' ';

    // Icon SVGs
    const icons = {
      dashboard: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg>`,
      system: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 01-2 2v4a2 2 0 012 2h14a2 2 0 012-2v-4a2 2 0 01-2-2m-2-4h.01M17 16h.01" />
      </svg>`,
      config: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>`,
      default: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>`,
      hyprland: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
      </svg>`,
      waybar: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 14h16M4 14v-4M8 14v-2M12 14v-4M16 14v-2M20 14v-4" />
      </svg>`,
      hyprlock: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>`,
      hypridle: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>`,
      wpaperd: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>`,
      menu: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>`
    };

    function renderSidebar() {
      const nav = document.getElementById('sidebar-nav');
      let html = '';

      archboardNav.forEach(item => {
        if (item.type === 'item') {
          const isActive = currentPage === item.id;
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.default;
          html += `<a href="${item.url}" class="flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 ${isActive ? 'bg-teal-500/10 text-teal-500 font-medium' : 'text-zinc-400 bg-transparent'}">${icon}${item.title}</a>`;
        } else if (item.type === 'group') {
          const isExpanded = item.item_ids && item.item_ids.includes(currentPage);
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.menu;
          const arrowClass = isExpanded ? 'rotate-90' : '';
          const menuClass = isExpanded ? '' : 'hidden';

          html += `
            <div class="pt-2">
              <button onclick="toggleSection('${item.id}-menu', '${item.id}-arrow')" class="flex items-center justify-between w-full gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 text-zinc-400 bg-transparent">
                <div class="flex items-center gap-2">${icon}${item.title}</div>
                <svg id="${item.id}-arrow" class="w-3 h-3 transition-transform duration-200 ${arrowClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
              <div id="${item.id}-menu" class="${menuClass} pl-6 mt-1 space-y-1">
                ${item.items.map(sub => {
            const subActive = currentPage === sub.id;
            const subIcon = sub.icon_svg || icons[sub.icon] || icons.default;
            return `<a href="${sub.url}" class="flex items-center gap-2 pl-10 pr-3 py-2 text-sm rounded-md transition-all duration-150 border-none hover:text-zinc-100 hover:bg-white/5 ${subActive ? 'text-teal-500 bg-white/5 font-medium' : 'text-zinc-500 bg-transparent'}">
              ${subIcon}
              ${sub.title}
            </a>`;
          }).join('')}
              </div>
            </div>`;
        }
      });

      nav.innerHTML = html;
    }

    function toggleSection(menuId, arrowId) {
      const menu = document.getElementById(menuId);
      const arrow = document.getElementById(arrowId);
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        arrow.classList.add('rotate-90');
      } else {
        menu.classList.add('hidden');
        arrow.classList.remove('rotate-90');
      }
    }

    // Get first nav URL (for auto-redirect)
    function getFirstNavUrl() {
      if (!archboardNav || archboardNav.length === 0) return null;
      const first = archboardNav[0];
      if (first.type === 'item') {
        return first.url;
      } else if (first.type === 'group' && first.items && first.items.length > 0) {
        return first.items[0].url;
      }
      return null;
    }

    // Set user info
    document.getElementById('user-avatar').textContent = username[0].toUpperCase();
    document.getElementById('user-name').textContent = username;
    document.getElementById('user-host').textContent = username + '@localhost';

    // Render navigation
    renderSidebar();

    // Auto-redirect from root to first nav item if no 'home' page exists
    if (window.location.pathname === '/' && currentPage === 'home') {
      const homeItem = archboardNav.find(n => n.type === 'item' && n.id === 'home');
      if (!homeItem) {
        const firstUrl = getFirstNavUrl();
        if (firstUrl && firstUrl !== '/') {
          window.location.href = firstUrl;
        }
      }
    }
  </script>
</aside><main class="flex flex-col flex-1 overflow-hidden min-w-0"><header class="flex items-center justify-between px-6 py-4 bg-zinc-950/80 border-b border-zinc-800/50">
    <div class="flex items-center gap-3 text-zinc-100">
        <svg class="w-5 h-5 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span class="text-lg font-medium">Dashboard</span>
    </div>

    <div class="flex items-center gap-3">
        <div onclick="openSearch()"
            class="flex items-center gap-2 px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-500 text-sm hover:border-teal-500 transition-colors cursor-pointer">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <span>Search...</span>
            <kbd class="text-xs px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">⌘K</kbd>
        </div>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Notifications">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
        </button>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Settings">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
</header><div class="flex-1 overflow-y-auto overflow-x-hidden p-6 w-full scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent"><div class="flex flex-col items-center justify-center p-12 text-zinc-500"><svg class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">path</svg><h2 class="text-xl font-medium text-zinc-300">Hypridle Settings</h2><p class="mt-2 text-sm">This module is under construction.</p></div></div><footer
    class="flex items-center justify-between px-6 py-3 bg-zinc-950/90 border-t border-zinc-800/50 text-xs text-zinc-500">
    <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-teal-500 animate-pulse"></span>
            <span>System Online</span>
        </div>
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Last sync: just now</span>
        </div>
    </div>

    <div class="flex gap-4">
        <a href="#" class="hover:text-teal-400 transition-colors">Documentation</a>
        <a href="#" class="hover:text-teal-400 transition-colors">GitHub</a>
        <span class="text-zinc-600">v1.0.0</span>
    </div>
</footer></main><!-- Search Modal (Command Palette) -->
<div id="search-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div id="search-backdrop"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0" aria-hidden="true"
        onclick="closeSearch()"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-start justify-center p-4 text-center sm:p-0 mt-20">
        <div id="search-panel"
            class="relative transform overflow-hidden rounded-xl bg-zinc-900 border border-zinc-800 text-left shadow-2xl transition-all duration-300 scale-95 opacity-0 sm:w-full sm:max-w-2xl ring-1 ring-white/10">
            <!-- Search Input -->
            <div class="relative flex items-center border-b border-zinc-800/50 p-4 sticky top-0 bg-zinc-900 z-10">
                <svg class="h-6 w-6 text-teal-500 pointer-events-none transition-colors duration-200" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="search-input"
                    class="h-full w-full bg-transparent border-0 focus:ring-0 focus:outline-none text-zinc-100 placeholder-zinc-500 pl-4 text-lg font-medium"
                    placeholder="Search settings, commands, pages..." autocomplete="off">
                <div class="ml-auto flex items-center gap-2">
                    <span class="text-xs text-zinc-500 font-medium">ESC</span>
                </div>
            </div>

            <!-- Results -->
            <div id="search-results"
                class="max-h-[60vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-zinc-900">
                <div id="search-empty" class="hidden py-16 text-center">
                    <svg class="mx-auto h-12 w-12 text-zinc-700 mb-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-zinc-500 text-sm">No results found.</p>
                </div>
                <!-- Categories will be grouped or flat list? Flat list with category badges looks modern -->
                <div id="search-list" class="p-2 space-y-1">
                    <!-- Results injected here -->
                </div>
            </div>

            <!-- Footer -->
            <div
                class="bg-zinc-900/80 px-4 py-2.5 border-t border-zinc-800/50 flex justify-between items-center text-xs text-zinc-500 select-none">
                <div class="flex gap-4">
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↑↓</kbd>
                        navigate</span>
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↵</kbd>
                        select</span>
                </div>
                <div class="text-zinc-600">ArchBoard Config</div>
            </div>
        </div>
    </div>
</div>

<!-- Fuse.js -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
    // Search Data
    const searchIndex =  ;
    let fuse;
    let selectedIndex = 0;

    // Elements
    const modal = document.getElementById('search-modal');
    const backdrop = document.getElementById('search-backdrop');
    const panel = document.getElementById('search-panel');
    const input = document.getElementById('search-input');
    const list = document.getElementById('search-list');
    const empty = document.getElementById('search-empty');

    // Initialize
    function initSearch() {
        const options = {
            includeScore: true,
            distance: 100, // Reduced distance for more precise prefix matching
            threshold: 0.3, // Lower threshold = stricter matching
            keys: [
                { name: 'title', weight: 0.5 }, // Title is important
                { name: 'description', weight: 0.3 }, // Description adds context
                { name: 'keywords', weight: 0.4 }, // Keywords match specific terms
                { name: 'category', weight: 0.1 } // Category is lowest priority
            ]
        };
        fuse = new Fuse(searchIndex, options);
    }

    // Toggle Modal
    function openSearch() {
        modal.classList.remove('hidden');
        // Animate in
        requestAnimationFrame(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        });

        input.value = '';
        renderResults([]);
        input.focus();
        document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
        // Animate out
        backdrop.classList.add('opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300); // Match transition duration
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            if (modal.classList.contains('hidden')) {
                openSearch();
            } else {
                closeSearch();
            }
        }

        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeSearch();
        }

        if (!modal.classList.contains('hidden')) {
            const items = list.querySelectorAll('.search-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const selected = items[selectedIndex];
                if (selected) {
                    selected.click();
                }
            }
        }
    });

    // Input Handling
    input.addEventListener('input', (e) => {
        const query = e.target.value;
        if (!query) {
            renderResults([]);
            return;
        }

        const results = fuse.search(query);
        // Take top 20 results for performance
        renderResults(results.slice(0, 20).map(r => r.item));
    });

    // Render
    function renderResults(items) {
        list.innerHTML = '';
        selectedIndex = 0;

        if (items.length === 0 && input.value) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');

        if (items.length === 0 && !input.value) {
            return;
        }

        items.forEach((item, index) => {
            const div = document.createElement('div');
            // Improved item styling
            div.className = `search-item group flex cursor-pointer select-none items-start gap-4 rounded-lg px-4 py-3 transition-colors duration-200`;

            div.onclick = () => {
                let url = item.url;
                if (item.selector) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}highlight=${encodeURIComponent(item.selector)}`;
                }
                window.location.href = url;
            };

            const isFirst = index === 0;

            // Icon based on category? Simplify to a generic arrow for now

            div.innerHTML = `
                <div class="mt-1 flex-none text-zinc-500 group-hover:text-teal-400 transition-colors">
                   ${getCategoryIcon(item.category)}
                </div>
                <div class="flex-auto overflow-hidden">
                    <div class="flex items-center gap-2 mb-0.5">
                        <span class="inline-flex items-center rounded-md bg-zinc-800/50 border border-zinc-700/50 px-1.5 py-0.5 text-[10px] font-medium text-zinc-400 uppercase tracking-wider group-hover:border-teal-500/30 group-hover:text-teal-400 transition-colors">
                            ${item.category}
                        </span>
                    </div>
                    <div class="truncate font-semibold text-sm text-zinc-200 group-hover:text-teal-400 pl-0.5">${item.title}</div>
                    ${item.description ? `<div class="mt-0.5 truncate text-xs text-zinc-500 pl-0.5 group-hover:text-zinc-400">${item.description}</div>` : ''}
                </div>
            `;
            list.appendChild(div);
        });

        if (list.children.length > 0) {
            updateSelection(list.querySelectorAll('.search-item'));
        }
    }

    function getCategoryIcon(category) {
        // Simple mapping for icons
        if (category.toLowerCase().includes('hyprland')) return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" /></svg>`;
        return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`;
    }

    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-zinc-800');
                item.classList.remove('hover:bg-zinc-800'); // Prevent conflict
                // Ensure text colors pop
                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.add('text-teal-400');

                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('bg-zinc-800');
                item.classList.add('hover:bg-zinc-800/50'); // Subtle hover state for non-selected

                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.remove('text-teal-400');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initSearch);
</script><div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 [&.active]:opacity-100 [&.active]:pointer-events-auto" onclick="closeModal()"><div id="modal-content" class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200 [&.active]:scale-100" onclick="event.stopPropagation()"></div></div><div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-2 z-[9999] pointer-events-none"></div><script src="scripts/main.js?k= "></script><script src="scripts/api.js?k= "></script><script src="scripts/renderer.js?k= "></script><script src="scripts/utils.js?k= "></script></body></html>
<html><head><title> </title><meta name="description" content=" " /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="preconnect" href="https://fonts.googleapis.com" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" /><link rel="stylesheet" href="tailwind.css?k= " /><script src="scripts/local_settings.js?k= "></script><script>const prod =  ;const plugin_enabled =  ;</script></head><body class="flex h-screen overflow-hidden bg-zinc-950 text-zinc-100 font-sans"><aside
  class="w-64 h-screen bg-zinc-900 text-zinc-400 border-r border-zinc-800/50 flex flex-col flex-shrink-0 select-none">

  <!-- Logo -->
  <div class="h-14 flex items-center px-5 border-b border-zinc-800/30">
    <svg class="w-5 h-5 text-teal-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5">
      </path>
    </svg>
    <span class="text-base font-semibold text-zinc-100">ArchBoard</span>
  </div>

  <!-- Navigation (rendered by JavaScript) -->
  <nav id="sidebar-nav" class="flex-1 overflow-y-auto py-3 px-3 space-y-1">
    <!-- Loading state -->
    <div class="text-zinc-500 text-sm px-2">Loading...</div>
  </nav>

  <!-- User -->
  <div class="border-t border-zinc-800/30 p-3">
    <div class="flex items-center gap-2">
      <div id="user-avatar"
        class="w-7 h-7 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white text-xs font-medium">
        ?
      </div>
      <div class="flex flex-col">
        <span id="user-name" class="text-xs font-medium text-zinc-200">...</span>
        <span id="user-host" class="text-xs text-zinc-500">...@arch</span>
      </div>
    </div>
  </div>

  <script>
    // Navigation data passed from Python
    const archboardNav =  ;
    const currentPage = ' ';
    const username = ' ';

    // Icon SVGs
    const icons = {
      dashboard: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg>`,
      system: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 01-2 2v4a2 2 0 012 2h14a2 2 0 012-2v-4a2 2 0 01-2-2m-2-4h.01M17 16h.01" />
      </svg>`,
      config: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>`,
      default: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>`,
      hyprland: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
      </svg>`,
      waybar: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 14h16M4 14v-4M8 14v-2M12 14v-4M16 14v-2M20 14v-4" />
      </svg>`,
      hyprlock: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>`,
      hypridle: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>`,
      wpaperd: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>`,
      menu: `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>`
    };

    function renderSidebar() {
      const nav = document.getElementById('sidebar-nav');
      let html = '';

      archboardNav.forEach(item => {
        if (item.type === 'item') {
          const isActive = currentPage === item.id;
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.default;
          html += `<a href="${item.url}" class="flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 ${isActive ? 'bg-teal-500/10 text-teal-500 font-medium' : 'text-zinc-400 bg-transparent'}">${icon}${item.title}</a>`;
        } else if (item.type === 'group') {
          const isExpanded = item.item_ids && item.item_ids.includes(currentPage);
          // Use custom icon_svg if provided, otherwise fall back to icon key
          const icon = item.icon_svg || icons[item.icon] || icons.menu;
          const arrowClass = isExpanded ? 'rotate-90' : '';
          const menuClass = isExpanded ? '' : 'hidden';

          html += `
            <div class="pt-2">
              <button onclick="toggleSection('${item.id}-menu', '${item.id}-arrow')" class="flex items-center justify-between w-full gap-2 px-3 py-2 rounded-md text-sm transition-all duration-150 cursor-pointer border-none hover:bg-white/5 hover:text-zinc-100 text-zinc-400 bg-transparent">
                <div class="flex items-center gap-2">${icon}${item.title}</div>
                <svg id="${item.id}-arrow" class="w-3 h-3 transition-transform duration-200 ${arrowClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
              <div id="${item.id}-menu" class="${menuClass} pl-6 mt-1 space-y-1">
                ${item.items.map(sub => {
            const subActive = currentPage === sub.id;
            const subIcon = sub.icon_svg || icons[sub.icon] || icons.default;
            return `<a href="${sub.url}" class="flex items-center gap-2 pl-10 pr-3 py-2 text-sm rounded-md transition-all duration-150 border-none hover:text-zinc-100 hover:bg-white/5 ${subActive ? 'text-teal-500 bg-white/5 font-medium' : 'text-zinc-500 bg-transparent'}">
              ${subIcon}
              ${sub.title}
            </a>`;
          }).join('')}
              </div>
            </div>`;
        }
      });

      nav.innerHTML = html;
    }

    function toggleSection(menuId, arrowId) {
      const menu = document.getElementById(menuId);
      const arrow = document.getElementById(arrowId);
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        arrow.classList.add('rotate-90');
      } else {
        menu.classList.add('hidden');
        arrow.classList.remove('rotate-90');
      }
    }

    // Get first nav URL (for auto-redirect)
    function getFirstNavUrl() {
      if (!archboardNav || archboardNav.length === 0) return null;
      const first = archboardNav[0];
      if (first.type === 'item') {
        return first.url;
      } else if (first.type === 'group' && first.items && first.items.length > 0) {
        return first.items[0].url;
      }
      return null;
    }

    // Set user info
    document.getElementById('user-avatar').textContent = username[0].toUpperCase();
    document.getElementById('user-name').textContent = username;
    document.getElementById('user-host').textContent = username + '@localhost';

    // Render navigation
    renderSidebar();

    // Auto-redirect from root to first nav item if no 'home' page exists
    if (window.location.pathname === '/' && currentPage === 'home') {
      const homeItem = archboardNav.find(n => n.type === 'item' && n.id === 'home');
      if (!homeItem) {
        const firstUrl = getFirstNavUrl();
        if (firstUrl && firstUrl !== '/') {
          window.location.href = firstUrl;
        }
      }
    }
  </script>
</aside><main class="flex flex-col flex-1 overflow-hidden min-w-0"><header class="flex items-center justify-between px-6 py-4 bg-zinc-950/80 border-b border-zinc-800/50">
    <div class="flex items-center gap-3 text-zinc-100">
        <svg class="w-5 h-5 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span class="text-lg font-medium">Dashboard</span>
    </div>

    <div class="flex items-center gap-3">
        <div onclick="openSearch()"
            class="flex items-center gap-2 px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-500 text-sm hover:border-teal-500 transition-colors cursor-pointer">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <span>Search...</span>
            <kbd class="text-xs px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">⌘K</kbd>
        </div>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Notifications">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
        </button>

        <button class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-900 hover:text-teal-400 transition-colors"
            title="Settings">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
</header><div class="flex-1 overflow-y-auto overflow-x-hidden p-6 w-full scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent"><div class="flex flex-col items-center justify-center p-12 text-zinc-500"><svg class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">path</svg><h2 class="text-xl font-medium text-zinc-300">Wpaperd Settings</h2><p class="mt-2 text-sm">This module is under construction.</p></div></div><footer
    class="flex items-center justify-between px-6 py-3 bg-zinc-950/90 border-t border-zinc-800/50 text-xs text-zinc-500">
    <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-teal-500 animate-pulse"></span>
            <span>System Online</span>
        </div>
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Last sync: just now</span>
        </div>
    </div>

    <div class="flex gap-4">
        <a href="#" class="hover:text-teal-400 transition-colors">Documentation</a>
        <a href="#" class="hover:text-teal-400 transition-colors">GitHub</a>
        <span class="text-zinc-600">v1.0.0</span>
    </div>
</footer></main><!-- Search Modal (Command Palette) -->
<div id="search-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div id="search-backdrop"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0" aria-hidden="true"
        onclick="closeSearch()"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-start justify-center p-4 text-center sm:p-0 mt-20">
        <div id="search-panel"
            class="relative transform overflow-hidden rounded-xl bg-zinc-900 border border-zinc-800 text-left shadow-2xl transition-all duration-300 scale-95 opacity-0 sm:w-full sm:max-w-2xl ring-1 ring-white/10">
            <!-- Search Input -->
            <div class="relative flex items-center border-b border-zinc-800/50 p-4 sticky top-0 bg-zinc-900 z-10">
                <svg class="h-6 w-6 text-teal-500 pointer-events-none transition-colors duration-200" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="search-input"
                    class="h-full w-full bg-transparent border-0 focus:ring-0 focus:outline-none text-zinc-100 placeholder-zinc-500 pl-4 text-lg font-medium"
                    placeholder="Search settings, commands, pages..." autocomplete="off">
                <div class="ml-auto flex items-center gap-2">
                    <span class="text-xs text-zinc-500 font-medium">ESC</span>
                </div>
            </div>

            <!-- Results -->
            <div id="search-results"
                class="max-h-[60vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-zinc-900">
                <div id="search-empty" class="hidden py-16 text-center">
                    <svg class="mx-auto h-12 w-12 text-zinc-700 mb-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-zinc-500 text-sm">No results found.</p>
                </div>
                <!-- Categories will be grouped or flat list? Flat list with category badges looks modern -->
                <div id="search-list" class="p-2 space-y-1">
                    <!-- Results injected here -->
                </div>
            </div>

            <!-- Footer -->
            <div
                class="bg-zinc-900/80 px-4 py-2.5 border-t border-zinc-800/50 flex justify-between items-center text-xs text-zinc-500 select-none">
                <div class="flex gap-4">
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↑↓</kbd>
                        navigate</span>
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↵</kbd>
                        select</span>
                </div>
                <div class="text-zinc-600">ArchBoard Config</div>
            </div>
        </div>
    </div>
</div>

<!-- Fuse.js -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
    // Search Data
    const searchIndex =  ;
    let fuse;
    let selectedIndex = 0;

    // Elements
    const modal = document.getElementById('search-modal');
    const backdrop = document.getElementById('search-backdrop');
    const panel = document.getElementById('search-panel');
    const input = document.getElementById('search-input');
    const list = document.getElementById('search-list');
    const empty = document.getElementById('search-empty');

    // Initialize
    function initSearch() {
        const options = {
            includeScore: true,
            distance: 100, // Reduced distance for more precise prefix matching
            threshold: 0.3, // Lower threshold = stricter matching
            keys: [
                { name: 'title', weight: 0.5 }, // Title is important
                { name: 'description', weight: 0.3 }, // Description adds context
                { name: 'keywords', weight: 0.4 }, // Keywords match specific terms
                { name: 'category', weight: 0.1 } // Category is lowest priority
            ]
        };
        fuse = new Fuse(searchIndex, options);
    }

    // Toggle Modal
    function openSearch() {
        modal.classList.remove('hidden');
        // Animate in
        requestAnimationFrame(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        });

        input.value = '';
        renderResults([]);
        input.focus();
        document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
        // Animate out
        backdrop.classList.add('opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300); // Match transition duration
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            if (modal.classList.contains('hidden')) {
                openSearch();
            } else {
                closeSearch();
            }
        }

        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeSearch();
        }

        if (!modal.classList.contains('hidden')) {
            const items = list.querySelectorAll('.search-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const selected = items[selectedIndex];
                if (selected) {
                    selected.click();
                }
            }
        }
    });

    // Input Handling
    input.addEventListener('input', (e) => {
        const query = e.target.value;
        if (!query) {
            renderResults([]);
            return;
        }

        const results = fuse.search(query);
        // Take top 20 results for performance
        renderResults(results.slice(0, 20).map(r => r.item));
    });

    // Render
    function renderResults(items) {
        list.innerHTML = '';
        selectedIndex = 0;

        if (items.length === 0 && input.value) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');

        if (items.length === 0 && !input.value) {
            return;
        }

        items.forEach((item, index) => {
            const div = document.createElement('div');
            // Improved item styling
            div.className = `search-item group flex cursor-pointer select-none items-start gap-4 rounded-lg px-4 py-3 transition-colors duration-200`;

            div.onclick = () => {
                let url = item.url;
                if (item.selector) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}highlight=${encodeURIComponent(item.selector)}`;
                }
                window.location.href = url;
            };

            const isFirst = index === 0;

            // Icon based on category? Simplify to a generic arrow for now

            div.innerHTML = `
                <div class="mt-1 flex-none text-zinc-500 group-hover:text-teal-400 transition-colors">
                   ${getCategoryIcon(item.category)}
                </div>
                <div class="flex-auto overflow-hidden">
                    <div class="flex items-center gap-2 mb-0.5">
                        <span class="inline-flex items-center rounded-md bg-zinc-800/50 border border-zinc-700/50 px-1.5 py-0.5 text-[10px] font-medium text-zinc-400 uppercase tracking-wider group-hover:border-teal-500/30 group-hover:text-teal-400 transition-colors">
                            ${item.category}
                        </span>
                    </div>
                    <div class="truncate font-semibold text-sm text-zinc-200 group-hover:text-teal-400 pl-0.5">${item.title}</div>
                    ${item.description ? `<div class="mt-0.5 truncate text-xs text-zinc-500 pl-0.5 group-hover:text-zinc-400">${item.description}</div>` : ''}
                </div>
            `;
            list.appendChild(div);
        });

        if (list.children.length > 0) {
            updateSelection(list.querySelectorAll('.search-item'));
        }
    }

    function getCategoryIcon(category) {
        // Simple mapping for icons
        if (category.toLowerCase().includes('hyprland')) return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" /></svg>`;
        return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`;
    }

    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-zinc-800');
                item.classList.remove('hover:bg-zinc-800'); // Prevent conflict
                // Ensure text colors pop
                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.add('text-teal-400');

                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('bg-zinc-800');
                item.classList.add('hover:bg-zinc-800/50'); // Subtle hover state for non-selected

                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.remove('text-teal-400');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initSearch);
</script><div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 [&.active]:opacity-100 [&.active]:pointer-events-auto" onclick="closeModal()"><div id="modal-content" class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200 [&.active]:scale-100" onclick="event.stopPropagation()"></div></div><div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-2 z-[9999] pointer-events-none"></div><script src="scripts/main.js?k= "></script><script src="scripts/api.js?k= "></script><script src="scripts/renderer.js?k= "></script><script src="scripts/utils.js?k= "></script></body></html>
// Main application script
let production = prod || false;

// Dev mode settings panel
if (!production) {
    console.log('Dev mode enabled');

    // Create dev toolbar
    document.addEventListener('DOMContentLoaded', () => {
        createDevToolbar();
        initAutoReload();
    });
}

function createDevToolbar() {
    const toolbar = document.createElement('div');
    toolbar.id = 'dev-toolbar';
    toolbar.innerHTML = `
        <div class="fixed bottom-4 right-4 flex items-center gap-3 px-3 py-2 bg-zinc-900/95 border border-zinc-700 rounded-lg text-xs z-[9999] backdrop-blur text-zinc-400">
            <span class="px-1.5 py-0.5 bg-red-500 text-white rounded font-bold text-[10px] tracking-wider">DEV</span>
            <label class="flex items-center gap-2 cursor-pointer hover:text-zinc-200 transition-colors">
                <input type="checkbox" id="auto-reload-toggle" ${getLocalSettings('auto_reload', 'true') === 'true' ? 'checked' : ''} class="accent-teal-500 cursor-pointer">
                <span>Auto-reload</span>
            </label>
        </div>
    `;
    document.body.appendChild(toolbar);

    // Handle toggle change
    const toggle = document.getElementById('auto-reload-toggle');
    toggle.addEventListener('change', (e) => {
        setLocalSettings('auto_reload', e.target.checked.toString());
        console.log('Auto-reload:', e.target.checked);
    });
}

function initAutoReload() {
    const autoReload = getLocalSettings('auto_reload', 'true') === 'true';
    if (autoReload) {
        setTimeout(() => {
            if (autoReload) {
                location.reload();
            }
        }, 60000); // Reload every 60 seconds in dev mode
    }
}

// API Client for ArchBoard

const POLL_INTERVAL = 3000; // 3 seconds

async function fetchSystemInfo() {
    try {
        const response = await fetch('/system/info');
        if (!response.ok) throw new Error('Failed to fetch system info');
        return await response.json();
    } catch (error) {
        console.error('Error fetching system info:', error);
        return null;
    }
}

// Format bytes to human readable (GB)
function formatBytes(bytes) {
    const gb = bytes / (1024 * 1024 * 1024);
    return gb.toFixed(1) + 'G';
}

async function updateDashboardStats() {
    const data = await fetchSystemInfo();
    if (!data) return;

    // Update CPU card
    const cpuValue = document.getElementById('stat-cpu-value');
    const cpuBar = document.getElementById('stat-cpu-bar');
    if (cpuValue) cpuValue.textContent = `${Math.round(data.overall_cpu_usage)}%`;
    if (cpuBar) cpuBar.style.width = `${data.overall_cpu_usage}%`;

    // Update Memory card
    const memValue = document.getElementById('stat-memory-value');
    const memBar = document.getElementById('stat-memory-bar');
    if (memValue) memValue.textContent = `${Math.round(data.memory_usage)}%`;
    if (memBar) memBar.style.width = `${data.memory_usage}%`;

    // Update Disk card - now with used/total (free) format
    const disk = data.disk_usage;
    const diskValue = document.getElementById('stat-disk-value');
    const diskDetails = document.getElementById('stat-disk-details');
    const diskBar = document.getElementById('stat-disk-bar');

    if (diskValue) diskValue.textContent = `${Math.round(disk.percent)}%`;
    if (diskDetails) {
        diskDetails.textContent = `${formatBytes(disk.used)} / ${formatBytes(disk.total)} (${formatBytes(disk.free)} free)`;
    }
    if (diskBar) diskBar.style.width = `${disk.percent}%`;
}

// Start polling on page load
document.addEventListener('DOMContentLoaded', () => {
    updateDashboardStats();
    setInterval(updateDashboardStats, POLL_INTERVAL);
});

function getLocalSettings(name, defaultValue=null) {
    return localStorage.getItem(name) || defaultValue;
}

function setLocalSettings(name, value) {
    localStorage.setItem(name, value);
}

function clearLocalSettings(name) {
    localStorage.removeItem(name);
}

function clearAllLocalSettings() {
    localStorage.clear();
}

function getAllLocalSettings() {
    let settings = {};
    for (let i = 0; i < localStorage.length; i++) {
        settings[localStorage.key(i)] = localStorage.getItem(localStorage.key(i));
    }
    return settings;
}



let schema = [];
let config = {};
let monitors = [];
let binds = [];
let windowrules = [];
let layerrules = [];
let execCommands = [];
let envVars = [];
let gestures = [];
let presets = [];
let activePreset = null;
let pendingChanges = {};
let migrationStatus = null;

const urlParams = new URLSearchParams(window.location.search);
let activeTab = urlParams.get('tab') || localStorage.getItem('hyprland_active_tab') || 'general';


function checkHighlight() {
    const selector = urlParams.get('highlight');
    if (selector) {

        setTimeout(() => {


            try {
                const el = document.querySelector(selector);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    const highlightClasses = ['ring-2', 'ring-teal-500', 'bg-teal-500/20', 'transition-all', 'duration-1000'];
                    el.classList.add(...highlightClasses);

                    setTimeout(() => el.classList.remove(...highlightClasses), 3000);
                }
            } catch (e) {
                console.warn('Invalid highlight selector:', selector);
            }
        }, 100);
    }
}





const SPECIAL_TABS = [
    { id: 'monitors', title: 'Monitors', icon: '🖥️' },
    { id: 'binds', title: 'Keybinds', icon: '⌨️' },
    { id: 'gestures', title: 'Gestures', icon: '👆' },
    { id: 'windowrules', title: 'Window Rules', icon: '🪟' },
    { id: 'layerrules', title: 'Layer Rules', icon: '📐' },
    { id: 'exec', title: 'Startup', icon: '🚀' },
    { id: 'env', title: 'Environment', icon: '🌍' }
];





document.addEventListener('DOMContentLoaded', async () => {
    await Promise.all([
        loadSchema(),
        loadConfig(),
        loadMonitors(),
        loadBinds(),
        loadWindowRules(),
        loadLayerRules(),
        loadExec(),
        loadEnv(),
        loadGestures(),
        loadPresets(),
        checkMigrationStatus()
    ]);
    renderTabs();
    renderTabContent(activeTab);
    renderPresetSelector();


    if (migrationStatus && migrationStatus.needs_migration &&
        migrationStatus.version && migrationStatus.version.supports_new_window_rules) {
        showMigrationModal();
    }
});



function isAutosaveEnabled() {
    return typeof ArchBoard !== 'undefined' ? ArchBoard.settings.autosaveEnabled : false;
}

async function loadSchema() {
    try {
        const response = await fetch('/hyprland/schema');
        const data = await response.json();
        schema = data.schema;
    } catch (error) {
        console.error('Failed to load schema:', error);
        showToast('Failed to load schema', 'error');
    }
}

async function loadConfig() {
    try {
        const response = await fetch('/hyprland/config');
        const data = await response.json();
        config = data.config;
    } catch (error) {
        console.error('Failed to load config:', error);
        showToast('Failed to load config', 'error');
    }
}

async function loadMonitors() {
    try {
        const response = await fetch('/hyprland/monitors');
        const data = await response.json();
        monitors = data.monitors;
    } catch (error) {
        console.error('Failed to load monitors:', error);
    }
}

async function loadBinds() {
    try {
        const response = await fetch('/hyprland/binds');
        const data = await response.json();
        binds = data.binds;
    } catch (error) {
        console.error('Failed to load binds:', error);
    }
}

async function loadWindowRules() {
    try {
        const response = await fetch('/hyprland/windowrules');
        const data = await response.json();
        windowrules = data.windowrules;
    } catch (error) {
        console.error('Failed to load window rules:', error);
    }
}

async function loadExec() {
    try {
        const response = await fetch('/hyprland/exec');
        const data = await response.json();
        execCommands = data.exec;
    } catch (error) {
        console.error('Failed to load exec commands:', error);
    }
}

async function loadEnv() {
    try {
        const response = await fetch('/hyprland/env');
        const data = await response.json();
        envVars = data.env;
    } catch (error) {
        console.error('Failed to load env vars:', error);
    }
}

let openWindows = [];
let selectedWindowIndex = -1;

function updateRuleMatch(index) {
    const container = document.getElementById('match-generator-ui');

    if (index === "") {
        container.classList.add('hidden');
        document.getElementById('rule-match').value = "";
        selectedWindowIndex = -1;
        return;
    }

    selectedWindowIndex = parseInt(index);
    container.classList.remove('hidden');
    generateMatchString();
}

function generateMatchString() {
    if (selectedWindowIndex === -1 || !openWindows[selectedWindowIndex]) return;

    const win = openWindows[selectedWindowIndex];
    const checkedProps = Array.from(document.querySelectorAll('input[name="match-prop"]:checked'));


    if (checkedProps.length === 0) {

        document.getElementById('rule-match').value = "";
        return;
    }

    const mode = document.querySelector('input[name="match-mode"]:checked').value;
    const matchParts = [];

    checkedProps.forEach(checkbox => {
        const prop = checkbox.value;
        let val = win[prop] || "";


        val = val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

        let regexVal = "";
        if (mode === 'exact') {
            regexVal = `^(${val})$`;
        } else if (mode === 'contains') {
            regexVal = `.*${val}.*`;
        } else if (mode === 'starts') {
            regexVal = `^${val}.*`;
        } else {
            regexVal = val;
        }
        let key = prop;
        if (prop === 'initialClass') key = 'initialclass';
        else if (prop === 'initialTitle') key = 'initialtitle';
        matchParts.push(`match:${key} ${regexVal}`);
    });

    document.getElementById('rule-match').value = matchParts.join(', ');
}

async function loadGestures() {
    try {
        const response = await fetch('/hyprland/gestures');
        const data = await response.json();
        gestures = data.gestures || [];
    } catch (error) {
        console.error('Failed to load gestures:', error);
    }
}

async function loadLayerRules() {
    try {
        const response = await fetch('/hyprland/layerrules');
        const data = await response.json();
        layerrules = data.layerrules || [];
    } catch (error) {
        console.error('Failed to load layer rules:', error);
    }
}

async function checkMigrationStatus() {
    try {
        const response = await fetch('/hyprland/migration/status');
        migrationStatus = await response.json();
    } catch (error) {
        console.error('Failed to check migration status:', error);
        migrationStatus = null;
    }
}

function showMigrationModal() {
    const versionStr = migrationStatus.version?.version || 'v0.53.0+';
    openModal(`
        <div class="text-center mb-4">
            <span class="text-4xl">🔄</span>
        </div>
        <h3 class="text-xl font-bold text-zinc-100 mb-4 text-center">Hyprland Upgrade Detected</h3>
        <p class="text-zinc-400 mb-4 text-center">
            You are running Hyprland <strong class="text-teal-400">${versionStr}</strong>. 
            Your config uses legacy window/layer rule syntax.
        </p>
        <div class="bg-zinc-800/50 rounded-lg p-4 mb-4">
            <h4 class="text-sm font-semibold text-zinc-300 mb-2">Changes detected:</h4>
            <pre class="text-xs text-zinc-500 whitespace-pre-wrap">${migrationStatus.summary || 'Legacy rules found'}</pre>
        </div>
        <p class="text-zinc-500 text-sm mb-6 text-center">
            Would you like to migrate to the new window rule syntax? A backup will be created.
        </p>
        <div class="flex justify-center gap-3">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">
                Skip (Keep Legacy)
            </button>
            <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="runMigration()">
                Migrate Config
            </button>
        </div>
    `);
}

async function runMigration() {
    try {
        const response = await fetch('/hyprland/migration/migrate', { method: 'POST' });
        const result = await response.json();

        if (result.success && result.migrated) {
            closeModal();
            showToast(`Migrated ${result.migrated_rules} rules. Backup: ${result.backup_path}`, 'success');

            await Promise.all([loadWindowRules(), loadLayerRules(), loadConfig()]);
            renderTabContent(activeTab);
        } else if (result.success && !result.migrated) {
            closeModal();
            showToast('Config already using new syntax', 'info');
        } else {
            showToast('Migration failed', 'error');
        }
    } catch (error) {
        console.error('Migration failed:', error);
        showToast('Migration failed', 'error');
    }
}






function renderTabs() {
    const nav = document.getElementById('tab-nav');


    const schemaTabs = schema.map(tab => `
        <button class="flex items-center gap-2 px-4 py-2.5 bg-transparent border-none rounded-lg text-zinc-400 text-sm cursor-pointer whitespace-nowrap hover:bg-zinc-800 hover:text-zinc-300 transition-all duration-200 ${tab.id === activeTab ? 'bg-zinc-800 text-teal-500 shadow-sm' : ''}" 
                data-tab="${tab.id}" 
                onclick="switchTab('${tab.id}')">
            <span class="text-base">${tab.icon}</span>
            <span>${tab.title}</span>
        </button>
    `).join('');


    const specialTabs = SPECIAL_TABS.map(tab => `
        <button class="flex items-center gap-2 px-4 py-2.5 bg-transparent border-none rounded-lg text-zinc-400 text-sm cursor-pointer whitespace-nowrap hover:bg-zinc-800 hover:text-zinc-300 transition-all duration-200 ${tab.id === activeTab ? 'bg-zinc-800 text-teal-500 shadow-sm' : ''}" 
                data-tab="${tab.id}" 
                onclick="switchTab('${tab.id}')">
            <span class="text-base">${tab.icon}</span>
            <span>${tab.title}</span>
        </button>
    `).join('');

    nav.innerHTML = schemaTabs + specialTabs;
}

function switchTab(tabId) {
    activeTab = tabId;
    localStorage.setItem('hyprland_active_tab', tabId);


    document.querySelectorAll('[data-tab]').forEach(btn => {
        const isActive = btn.dataset.tab === tabId;
        if (isActive) {
            btn.classList.add('bg-zinc-800', 'text-teal-500', 'shadow-sm');
        } else {
            btn.classList.remove('bg-zinc-800', 'text-teal-500', 'shadow-sm');
        }
    });

    renderTabContent(tabId);
}

function renderTabContent(tabId) {
    const content = document.getElementById('tab-content');

    let html = '';
    switch (tabId) {
        case 'monitors':
            html = renderMonitorsTab();
            break;
        case 'binds':
            html = renderBindsTab();
            break;
        case 'gestures':
            html = renderGesturesTab();
            break;
        case 'windowrules':
            html = renderWindowRulesTab();
            break;
        case 'layerrules':
            html = renderLayerRulesTab();
            break;
        case 'exec':
            html = renderExecTab();
            break;
        case 'env':
            html = renderEnvTab();
            break;
        default:
            const tab = schema.find(t => t.id === tabId);
            if (tab) {
                html = tab.sections.map(section => renderSection(section)).join('');
            }
    }

    content.innerHTML = html;
    checkHighlight();
}





function renderMonitorsTab() {
    return `
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden mb-4">
            <div class="px-5 py-3.5 bg-zinc-800/30 border-b border-zinc-800 flex justify-between items-center">
                <h3 class="text-sm font-semibold text-zinc-200 uppercase tracking-wider m-0">Monitor Configuration</h3>
            </div>
            <div class="p-2">
                ${monitors.length === 0 ? '<p class="text-center text-zinc-500 p-8">No monitors configured</p>' :
            monitors.map((m, i) => `
                    <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-4 mb-3">
                        <div class="font-semibold text-teal-500 text-base mb-2">${m.name}</div>
                        <div class="flex gap-4 text-sm text-zinc-400 mb-2">
                            <span class="text-zinc-200">${m.resolution || 'disabled'}</span>
                            ${m.position ? `<span>@ ${m.position}</span>` : ''}
                            ${m.scale ? `<span>×${m.scale}</span>` : ''}
                        </div>
                        <code class="block text-xs text-zinc-500 bg-zinc-900 p-2 rounded overflow-x-auto">${m.raw}</code>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function renderBindsTab() {
    const listHtml = UI.renderTable({
        headers: ['Type', 'Mods', 'Key', 'Dispatcher', 'Params', 'Actions'],
        data: binds,
        emptyMessage: 'No keybinds configured',
        rowRenderer: (b) => `
            <td class="p-3 text-zinc-200"><code class="font-mono text-xs">${b.type}</code></td>
            <td class="p-3 text-zinc-200">${b.mods || '-'}</td>
            <td class="p-3 text-zinc-200"><code class="font-mono text-xs">${b.key}</code></td>
            <td class="p-3 text-zinc-200"><strong>${b.dispatcher}</strong></td>
            <td class="p-3 text-zinc-500 max-w-[200px] truncate">${b.params || '-'}</td>
            <td class="p-3 w-24 text-right">
                <div class="flex justify-end gap-2">
                    <button class="p-1 text-zinc-500 hover:text-teal-500 transition-colors" onclick="showEditBindModal('${b.type}', '${b.mods || ''}', '${b.key}', '${b.dispatcher}', '${(b.params || '').replace(/'/g, "\\'")}', '${b.raw.replace(/'/g, "\\'")}')">✏️</button>
                    <button class="p-1 text-zinc-500 hover:text-red-500 transition-colors" onclick="confirmDeleteBind('${b.raw.replace(/'/g, "\\'")}')">🗑️</button>
                </div>
            </td>
        `
    });

    return `
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden mb-4">
            ${UI.renderSectionHeader('Keybinds', { label: 'Add Keybind', onclick: 'showAddBindModal()' }, binds.length)}
            ${listHtml}
        </div>
    `;
}

function renderGesturesTab() {
    return `
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden mb-4">
            <div class="px-5 py-3.5 bg-zinc-800/30 border-b border-zinc-800 flex justify-between items-center">
                <h3 class="text-sm font-semibold text-zinc-200 uppercase tracking-wider m-0">Gesture Bindings (${gestures.length})</h3>
                <button class="flex items-center gap-2 px-3 py-1.5 bg-teal-500 hover:bg-teal-600 text-white rounded-md text-sm transition-colors" onclick="showAddGestureModal()">+ Add Gesture</button>
            </div>
            <div class="p-0">
                ${gestures.length === 0 ? '<p class="text-center text-zinc-500 p-8">No gesture bindings configured. Add a gesture like "3, horizontal, workspace" to enable touchpad swiping.</p>' : `
                <table class="w-full text-left text-sm border-collapse">
                    <thead>
                        <tr>
                            <th class="text-zinc-500 font-medium text-xs uppercase tracking-wider p-3 border-b border-zinc-800">Fingers</th>
                            <th class="text-zinc-500 font-medium text-xs uppercase tracking-wider p-3 border-b border-zinc-800">Direction</th>
                            <th class="text-zinc-500 font-medium text-xs uppercase tracking-wider p-3 border-b border-zinc-800">Mod/Scale</th>
                            <th class="text-zinc-500 font-medium text-xs uppercase tracking-wider p-3 border-b border-zinc-800">Action</th>
                            <th class="text-zinc-500 font-medium text-xs uppercase tracking-wider p-3 border-b border-zinc-800">Params</th>
                            <th class="text-zinc-500 font-medium text-xs uppercase tracking-wider p-3 border-b border-zinc-800">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${gestures.map(g => {
        const actionDisplay = g.action === 'dispatcher' ? `dispatcher: ${g.dispatcher}` : g.action;
        const modScale = [g.mod ? `mod: ${g.mod}` : '', g.scale ? `scale: ${g.scale}` : ''].filter(x => x).join(', ') || '-';
        return `
                            <tr class="hover:bg-zinc-800/40 border-b border-zinc-800">
                                <td class="p-3 text-zinc-200"><code class="font-mono text-xs">${g.fingers}</code></td>
                                <td class="p-3 text-zinc-200">${g.direction}</td>
                                <td class="p-3 text-zinc-200">${modScale}</td>
                                <td class="p-3 text-zinc-200"><strong>${actionDisplay}</strong></td>
                                <td class="p-3 text-zinc-500 max-w-[200px] truncate">${g.params || '-'}</td>
                                <td class="p-3 flex gap-2">
                                    <button class="p-1 text-zinc-500 hover:text-teal-500 transition-colors" onclick="showEditGestureModal('${g.fingers}', '${g.direction}', '${g.action}', '${(g.params || '').replace(/'/g, "\\'")}', '${g.raw.replace(/'/g, "\\'")}', '${(g.dispatcher || '').replace(/'/g, "\\'")}', '${(g.mod || '').replace(/'/g, "\\'")}', '${(g.scale || '').replace(/'/g, "\\'")}')">✏️</button>
                                    <button class="p-1 text-zinc-500 hover:text-red-500 transition-colors" onclick="confirmDeleteGesture('${g.raw.replace(/'/g, "\\'")}')">🗑️</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>`}
            </div>
        </div>
    `;
}

function renderWindowRulesTab() {
    const listHtml = UI.renderTable({
        headers: ['Type', 'Effect', 'Match', 'Actions'],
        data: windowrules,
        emptyMessage: 'No window rules configured',
        rowRenderer: (r) => `
            <td class="p-3 w-24">
                <code class="bg-zinc-800 px-2 py-0.5 rounded text-xs text-teal-500 font-mono">${r.type}</code>
            </td>
            <td class="p-3">
                <span class="text-zinc-200 font-medium text-sm">${r.effect}</span>
            </td>
            <td class="p-3 text-zinc-500 text-xs font-mono">
                ${r.match}
            </td>
            <td class="p-3 w-24 text-right">
                <div class="flex justify-end gap-2">
                    <button class="p-1 text-zinc-500 hover:text-teal-500 transition-colors" onclick="showEditRuleModal('${r.type}', '${r.effect}', '${r.match.replace(/'/g, "\\'")}', '${r.raw.replace(/'/g, "\\'")}')">✏️</button>
                    <button class="p-1 text-zinc-500 hover:text-red-500 transition-colors" onclick="confirmDeleteRule('${r.raw.replace(/'/g, "\\'")}')">🗑️</button>
                </div>
            </td>
        `
    });

    return `
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden mb-4">
            ${UI.renderSectionHeader('Window Rules', { label: 'Add Rule', onclick: 'showAddRuleModal()' }, windowrules.length)}
            ${listHtml}
        </div>
    `;
}

function renderLayerRulesTab() {
    const listHtml = UI.renderTable({
        headers: ['Type', 'Effect', 'Namespace', 'Actions'],
        data: layerrules,
        emptyMessage: 'No layer rules configured. Layer rules affect surfaces like waybar, rofi, notifications, etc.',
        rowRenderer: (r) => `
            <td class="p-3 w-24">
                <code class="bg-zinc-800 px-2 py-0.5 rounded text-xs text-purple-500 font-mono">layerrule</code>
            </td>
            <td class="p-3">
                <span class="text-zinc-200 font-medium text-sm">${r.effect}</span>
            </td>
            <td class="p-3">
                <span class="text-zinc-500 text-xs">→ ${r.namespace}</span>
            </td>
            <td class="p-3 w-24 text-right">
                <div class="flex justify-end gap-2">
                    <button class="p-1 text-zinc-500 hover:text-teal-500 transition-colors" onclick="showEditLayerRuleModal('${r.effect.replace(/'/g, "\\'")}', '${r.namespace.replace(/'/g, "\\'")}', '${r.raw.replace(/'/g, "\\'")}')">✏️</button>
                    <button class="p-1 text-zinc-500 hover:text-red-500 transition-colors" onclick="confirmDeleteLayerRule('${r.raw.replace(/'/g, "\\'")}')">🗑️</button>
                </div>
            </td>
        `
    });

    return `
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden mb-4">
            ${UI.renderSectionHeader('Layer Rules', { label: 'Add Layer Rule', onclick: 'showAddLayerRuleModal()' }, layerrules.length)}
            ${listHtml}
        </div>
        <div class="bg-zinc-800/30 rounded-lg p-4 text-sm text-zinc-500">
            <strong class="text-zinc-400">💡 Common Layer Rules:</strong>
            <ul class="mt-2 space-y-1">
                <li><code class="text-teal-500">blur</code> - Apply blur effect to layer surface</li>
                <li><code class="text-teal-500">ignorezero</code> - Ignore fully transparent pixels</li>
                <li><code class="text-teal-500">ignorealpha 0.5</code> - Ignore pixels with alpha below threshold</li>
                <li><code class="text-teal-500">animation slide</code> - Set animation style (slide, popin, fade)</li>
                <li><code class="text-teal-500">noanim</code> - Disable animations</li>
            </ul>
        </div>
    `;
}


function renderExecTab() {
    const listHtml = UI.renderTable({
        headers: ['Type', 'Command', 'Actions'],
        data: execCommands,
        emptyMessage: 'No startup commands configured',
        rowRenderer: (c) => `
            <td class="p-3 w-32">
                <code class="bg-zinc-800 px-2 py-0.5 rounded text-xs ${c.type === 'exec-once' ? 'text-purple-500' : 'text-blue-500'} font-mono">${c.type}</code>
            </td>
            <td class="p-3">
                <code class="text-zinc-300 text-sm font-mono break-all">${c.command}</code>
            </td>
            <td class="p-3 w-24 text-right">
                <div class="flex justify-end gap-2">
                    <button class="p-1 text-zinc-500 hover:text-teal-500 transition-colors" onclick="showEditExecModal('${c.type}', '${c.command.replace(/'/g, "\\'")}')">✏️</button>
                    <button class="p-1 text-zinc-500 hover:text-red-500 transition-colors" onclick="confirmDeleteExec('${c.type}', '${c.command.replace(/'/g, "\\'")}')">🗑️</button>
                </div>
            </td>
        `
    });

    return `
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden mb-4">
            ${UI.renderSectionHeader('Startup Commands', { label: 'Add Command', onclick: 'showAddExecModal()' }, execCommands.length)}
            ${listHtml}
        </div>
    `;
}

function renderEnvTab() {

    function getCategory(name) {
        name = name.toUpperCase();
        if (name.startsWith('GTK') || name.startsWith('GDK')) return 'GTK/GDK';
        if (name.startsWith('QT')) return 'QT';
        if (name.startsWith('XDG')) return 'XDG';
        if (name.startsWith('XCURSOR')) return 'XCURSOR';
        if (name.includes('NVIDIA') || name.startsWith('__GL') || name === 'GBM_BACKEND' || name === 'LIBVA_DRIVER_NAME') return 'NVIDIA';
        if (name.startsWith('AQ_')) return 'AQ (Aquamarine)';
        if (name.startsWith('HYPRLAND')) return 'HYPRLAND';
        return 'Other';
    }

    const listHtml = UI.renderTable({
        headers: ['Category', 'Variable', 'Value', 'Actions'],
        data: envVars,
        emptyMessage: 'No environment variables configured',
        rowRenderer: (env) => {
            const category = getCategory(env.name);
            return `
            <td class="p-3 w-32">
                 <span class="inline-flex items-center rounded-md bg-zinc-800 px-2 py-1 text-xs font-medium text-zinc-400 ring-1 ring-inset ring-zinc-700/10">${category}</span>
            </td>
            <td class="p-3">
                <code class="text-teal-500 text-sm font-mono font-medium">${env.name}</code>
            </td>
            <td class="p-3">
                <code class="text-zinc-400 text-sm font-mono break-all">${env.value}</code>
            </td>
            <td class="p-3 w-24 text-right">
                <div class="flex justify-end gap-2">
                    <button class="p-1 text-zinc-500 hover:text-teal-500 transition-colors" onclick="showEditEnvModal('${env.name}', '${env.value.replace(/'/g, "\\'")}')">✏️</button>
                    <button class="p-1 text-zinc-500 hover:text-red-500 transition-colors" onclick="confirmDeleteEnv('${env.name}')">🗑️</button>
                </div>
            </td>
            `;
        }
    });

    return `
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden mb-4">
            ${UI.renderSectionHeader('Environment Variables', { label: 'Add Variable', onclick: 'showAddEnvModal()' }, envVars.length)}
            ${listHtml}
        </div>
    `;
}

// =============================================================================
// SECTION RENDERING
// =============================================================================

function renderSection(section) {
    return `
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden mb-4">
            ${UI.renderSectionHeader(section.title, null)}
            <div class="p-2">
                ${section.options.map(opt => renderOption(section.name, opt)).join('')}
            </div>
        </div>
    `;
}

function renderOption(sectionName, option) {
    const path = `${sectionName}:${option.name} `;
    const configValue = config[path];
    const value = configValue !== undefined ? configValue : option.default;
    const hasChange = path in pendingChanges;

    return `
        <div class="searchable-item flex justify-between items-center px-4 py-3.5 hover:bg-zinc-800/40 transition-colors rounded-lg mb-1 ${hasChange ? 'bg-teal-500/5 border-l-2 border-teal-500' : ''}" data-path="${path}">
            <div class="flex-1 min-w-0 mr-4">
                <label class="block text-sm font-medium text-zinc-200 mb-0.5">${formatLabel(option.name)}</label>
                <span class="block text-xs text-zinc-500 truncate max-w-md">${option.description}</span>
            </div>
            <div class="flex-shrink-0">
                ${renderControl(path, option, value)}
            </div>
        </div>
    `;
}

function formatLabel(name) {
    return name
        .replace(/_/g, ' ')
        .replace(/\./g, ' ')
        .replace(/\b\w/g, c => c.toUpperCase());
}

// =============================================================================
// CONTROL RENDERING
// =============================================================================

function renderControl(path, option, value) {
    switch (option.type) {
        case 'bool':
            return renderToggle(path, value);
        case 'int':
        case 'float':
            if (option.min !== null && option.max !== null) {
                return renderSlider(path, option, value);
            }
            return renderNumberInput(path, option, value);
        case 'color':
        case 'gradient':
            return renderColorInput(path, value);
        case 'enum':
            return renderSelect(path, option, value);
        case 'vec2':
            return renderVec2Input(path, value);
        case 'string':
        default:
            return renderTextInput(path, value);
    }
}

function renderToggle(path, value) {
    const checked = value === true || value === 'true' || value === 'yes' || value === '1';
    return `
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" class="sr-only peer" ${checked ? 'checked' : ''}
                onchange="updateValue('${path}', this.checked)">
                <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-teal-500/20 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div>
            </label>
    `;
}

function renderSlider(path, option, value) {
    const parsed = parseFloat(value);
    const numValue = isNaN(parsed) ? option.default : parsed;
    const step = option.step || (option.type === 'float' ? 0.1 : 1);
    return `
        <div class="flex items-center gap-3 min-w-[180px]">
            <input type="range" class="flex-1 h-1.5 bg-zinc-700 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-teal-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:hover:scale-110 [&::-webkit-slider-thumb]:transition-transform"
                min="${option.min}" max="${option.max}" step="${step}"
                value="${numValue}"
                oninput="updateSlider('${path}', this.value, this.parentElement)">
                <span class="slider-value min-w-[40px] text-right text-sm font-medium text-zinc-200">${numValue}</span>
            </div>
    `;
}

function renderNumberInput(path, option, value) {
    return `
        <input type="number" class="w-20 px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm text-center focus:outline-none focus:border-teal-500 transition-colors" value="${value}"
               ${option.min !== null ? `min="${option.min}"` : ''}
               ${option.max !== null ? `max="${option.max}"` : ''}
               ${option.step ? `step="${option.step}"` : ''}
               onchange="updateValue('${path}', this.value)">
    `;
}

function renderColorInput(path, value) {
    // Convert hyprland color format to hex
    const hexColor = hyprColorToHex(value);
    return `
        <div class="flex items-center gap-2">
            <input type="color" value="${hexColor}" class="w-8 h-8 rounded border-none cursor-pointer bg-transparent"
                onchange="updateColor('${path}', this.value)">
                <input type="text" class="w-28 px-2 py-1.5 bg-zinc-800 border border-zinc-700 rounded text-zinc-200 text-xs font-mono focus:outline-none focus:border-teal-500" value="${value}"
                    onchange="updateValue('${path}', this.value)">
                </div>
                `;
}

function renderSelect(path, option, value) {
    return `
                <select class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors cursor-pointer" onchange="updateValue('${path}', this.value)">
                    ${option.choices.map(choice => `
                <option value="${choice}" ${value === choice ? 'selected' : ''}>
                    ${choice || '(none)'}
                </option>
            `).join('')}
                </select>
                `;
}

function renderVec2Input(path, value) {
    const parts = String(value).split(' ');
    const x = parts[0] || '0';
    const y = parts[1] || '0';
    return `
                <div class="flex gap-2">
                    <input type="number" class="w-16 px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200 text-sm text-center focus:outline-none focus:border-teal-500" value="${x}" placeholder="X"
                        onchange="updateVec2('${path}', this.value, null)">
                        <input type="number" class="w-16 px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200 text-sm text-center focus:outline-none focus:border-teal-500" value="${y}" placeholder="Y"
                            onchange="updateVec2('${path}', null, this.value)">
                        </div>
                        `;
}

function renderTextInput(path, value) {
    return `
                        <input type="text" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${value}"
                            onchange="updateValue('${path}', this.value)">
                            `;
}

// =============================================================================
// VALUE UPDATES
// =============================================================================

function updateValue(path, value) {
    pendingChanges[path] = value;
    config[path] = value;
    markChanged(path);
    updateSaveButton();

    // Autosave with debounce
    if (isAutosaveEnabled()) {
        debouncedSave();
    }
}

// Debounced save for autosave (500ms delay)
let saveTimeout = null;
function debouncedSave() {
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(async () => {
        await saveConfig();
        // If there's an active preset, also sync to it
        if (activePreset) {
            await syncToActivePreset();
        }
    }, 500);
}

function updateSlider(path, value, container) {
    const display = container.querySelector('.slider-value');
    if (display) display.textContent = value;
    updateValue(path, value);
}

function updateColor(path, hexValue) {
    // Convert hex to hyprland format
    const hyprColor = hexToHyprColor(hexValue);
    updateValue(path, hyprColor);

    // Update text input
    const option = document.querySelector(`[data-path="${path}"] .color-text`);
    if (option) option.value = hyprColor;
}

function updateVec2(path, x, y) {
    const current = String(config[path] || '0 0').split(' ');
    const newX = x !== null ? x : current[0];
    const newY = y !== null ? y : current[1];
    updateValue(path, `${newX} ${newY}`);
}

function markChanged(path) {
    const el = document.querySelector(`[data-path="${path}"]`);
    if (el) {
        el.classList.add('bg-teal-500/5', 'border-l-2', 'border-teal-500');
    }
}

function updateSaveButton() {
    const btn = document.getElementById('btn-save');
    const count = Object.keys(pendingChanges).length;
    if (count > 0) {
        btn.classList.add('has-changes');
        btn.innerHTML = `
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            Save (${count})
                            `;
    } else {
        btn.classList.remove('has-changes');
        btn.innerHTML = `
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            Save
                            `;
    }

    // Also update preset selector to show change count
    renderPresetSelector();
}

// =============================================================================
// SAVE & RELOAD
// =============================================================================

async function saveConfig() {
    if (Object.keys(pendingChanges).length === 0) {
        showToast('No changes to save', 'info');
        return;
    }

    try {
        const response = await fetch('/hyprland/config/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ updates: pendingChanges })
        });

        if (!response.ok) throw new Error('Failed to save');

        // Clear pending changes
        pendingChanges = {};
        document.querySelectorAll('[data-path]').forEach(el => {
            el.classList.remove('bg-teal-500/5', 'border-l-2', 'border-teal-500');
        });
        updateSaveButton();

        showToast('Configuration saved!', 'success');
    } catch (error) {
        console.error('Save failed:', error);
        showToast('Failed to save configuration', 'error');
    }
}

async function reloadHyprland() {
    try {
        const response = await fetch('/hyprland/reload', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showToast('Hyprland reloaded!', 'success');
        } else {
            showToast('Reload failed', 'error');
        }
    } catch (error) {
        console.error('Reload failed:', error);
        showToast('Failed to reload Hyprland', 'error');
    }
}

// =============================================================================
// COLOR UTILITIES
// =============================================================================

function hyprColorToHex(color) {
    // Handle Hyprland formats:
    // - 0xAARRGGBB or 0xRRGGBB
    // - rgba(RRGGBBAA) - hex inside rgba!
    // - Gradients: rgba(33ccffee) rgba(8f00ffee) 45deg
    // - #RRGGBB

    if (!color || typeof color !== 'string') return '#ffffff';

    const colorStr = String(color).trim();
    if (!colorStr) return '#ffffff';

    // For gradients, just take the first color
    // e.g., "rgba(33ccffee) rgba(8f00ffee) 45deg" -> extract first rgba

    // 0xAARRGGBB format
    if (colorStr.startsWith('0x')) {
        const hex = colorStr.slice(2);
        if (hex.length === 8) {
            // AARRGGBB -> #RRGGBB (skip alpha)
            return '#' + hex.slice(2);
        }
        return '#' + hex.padStart(6, '0');
    }

    // Already hex with #
    if (colorStr.startsWith('#')) {
        return colorStr.slice(0, 7); // Take just 6 chars after #
    }

    // Hyprland rgba(RRGGBBAA) format - hex inside parentheses, NOT decimal RGB!
    const hyprRgbaMatch = colorStr.match(/rgba?\s*\(\s*([0-9a-fA-F]{6, 8})\s*\)/);
    if (hyprRgbaMatch) {
        const hex = hyprRgbaMatch[1];
        // RRGGBBAA -> #RRGGBB (first 6 chars, skip alpha if present)
        return '#' + hex.slice(0, 6);
    }

    // Standard CSS rgba(r,g,b,a) with decimal values
    const cssRgbaMatch = colorStr.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);
    if (cssRgbaMatch) {
        const r = Math.min(255, parseInt(cssRgbaMatch[1])).toString(16).padStart(2, '0');
        const g = Math.min(255, parseInt(cssRgbaMatch[2])).toString(16).padStart(2, '0');
        const b = Math.min(255, parseInt(cssRgbaMatch[3])).toString(16).padStart(2, '0');
        return `#${r}${g}${b}`;
    }

    // Handle bare hex without prefix (e.g., "33ccff" or "33ccffee")
    const bareHexMatch = colorStr.match(/^([0-9a-fA-F]{6, 8})/);
    if (bareHexMatch) {
        const hex = bareHexMatch[1];
        return '#' + hex.slice(0, 6);
    }

    return '#ffffff';
}

function hexToHyprColor(hex) {
    // #RRGGBB -> 0xffRRGGBB
    const rgb = hex.slice(1);
    return `0xff${rgb}`;
}

// =============================================================================
// TOAST NOTIFICATIONS
// =============================================================================

// Note: showToast is now provided by utils.js globally

// =============================================================================
// MODAL SYSTEM 
// Note: openModal(), closeModal(), and confirmDialog() are now provided by 
// utils.js globally. The functions below delegate to them for backwards 
// compatibility, or can be removed if the page-specific modal overlay is
// no longer used.
// =============================================================================

// Legacy compatibility - if page has a #modal-overlay element, use it
// Otherwise, fall back to global modal system
function openModal(content) {
    const pageOverlay = document.getElementById('modal-overlay');
    if (pageOverlay) {
        const modalContent = document.getElementById('modal-content');
        modalContent.innerHTML = content;
        pageOverlay.classList.add('active');
    } else {
        openGlobalModal(content);
    }
}

function closeModal() {
    const pageOverlay = document.getElementById('modal-overlay');
    if (pageOverlay) {
        pageOverlay.classList.remove('active');
    } else {
        closeGlobalModal();
    }
}

// =============================================================================
// ENV VAR CRUD
// =============================================================================

function showAddEnvModal() {
    openModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Add Environment Variable</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
        </div>
        <div class="mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Variable Name</label>
                <input type="text" id="env-name" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="e.g., GTK_THEME">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Value</label>
                <input type="text" id="env-value" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="e.g., Nord">
            </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
            <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="addEnvVar()">Add</button>
        </div>
    `);
}

async function addEnvVar() {
    const name = document.getElementById('env-name').value.trim();
    const value = document.getElementById('env-value').value.trim();
    if (!name) return showToast('Name is required', 'error');

    try {
        await fetch('/hyprland/env', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'add', name, value })
        });
        closeModal();
        await loadEnv();
        renderTabContent('env');
        showToast('Environment variable added', 'success');
    } catch (e) {
        showToast('Failed to add', 'error');
    }
}

function showEditEnvModal(name, value) {
    openModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Edit Environment Variable</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
        </div>
        <div class="mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Variable Name</label>
                <input type="text" id="env-name" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${name}">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Value</label>
                <input type="text" id="env-value" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${value}">
            </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
            <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="updateEnvVar('${name}')">Save</button>
        </div>
    `);
}

async function updateEnvVar(oldName) {
    const name = document.getElementById('env-name').value.trim();
    const value = document.getElementById('env-value').value.trim();

    try {
        await fetch('/hyprland/env', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'update', name, value, old_name: oldName })
        });
        closeModal();
        await loadEnv();
        renderTabContent('env');
        showToast('Environment variable updated', 'success');
    } catch (e) {
        showToast('Failed to update', 'error');
    }
}

async function deleteEnvVar(name) {
    try {
        await fetch('/hyprland/env', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', name, value: '' })
        });
        await loadEnv();
        renderTabContent('env');
        showToast('Environment variable deleted', 'success');
    } catch (e) {
        showToast('Failed to delete', 'error');
    }
}

function confirmDeleteEnv(name) {
    confirmDialog('Delete Environment Variable',
        `Are you sure you want to delete "${name}"?`,
        `function() { deleteEnvVar('${name}') }`);
}

// =============================================================================
// EXEC COMMANDS CRUD
// =============================================================================

function showAddExecModal() {
    openModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Add Startup Command</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
        </div>
        <div class="mb-6">
            <div class="mb-4">
                <label class="block text-zinc-400 text-sm mb-1">Type</label>
                <select id="exec-type" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                    <option value="exec-once">exec-once (Startup)</option>
                    <option value="exec">exec (Always)</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Command</label>
                <input type="text" id="exec-command" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="e.g., waybar">
            </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
            <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="addExecCommand()">Add</button>
        </div>
    `);
}

async function addExecCommand() {
    const type = document.getElementById('exec-type').value;
    const command = document.getElementById('exec-command').value.trim();
    if (!command) return showToast('Command is required', 'error');

    try {
        await fetch('/hyprland/exec', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'add', type, command })
        });
        closeModal();
        await loadExec();
        renderTabContent('exec');
        showToast('Command added', 'success');
    } catch (e) {
        showToast('Failed to add', 'error');
    }
}

async function deleteExecCommand(type, command) {
    try {
        await fetch('/hyprland/exec', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', type, command })
        });
        await loadExec();
        renderTabContent('exec');
        showToast('Command deleted', 'success');
    } catch (e) {
        showToast('Failed to delete', 'error');
    }
}

function confirmDeleteExec(type, command) {
    const escapedCmd = command.replace(/'/g, "\\'");
    confirmDialog('Delete Command',
        `Are you sure you want to delete this command?`,
        `function() {deleteExecCommand('${type}', '${escapedCmd}')}`);
}

function showEditExecModal(type, command) {
    const escapedCmd = command.replace(/"/g, '&quot;');
    openModal(`
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-white">Edit Startup Command</h3>
                                <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
                            </div>
                            <div class="mb-6">
                                <div class="w-1/3">
                                    <label class="block text-zinc-400 text-xs mb-1">Type</label>
                                    <select id="exec-type" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                                        <option value="exec-once" ${type === 'exec-once' ? 'selected' : ''}>exec-once</option>
                                        <option value="exec" ${type === 'exec' ? 'selected' : ''}>exec</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-zinc-400 mb-1.5">Command</label>
                                    <input type="text" id="exec-command" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${escapedCmd}">
                                </div>
                            </div>
                            <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
                                <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
                                <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="updateExecCommand('${type}', '${command.replace(/'/g, "\\'")}')">Save</button>
                        </div>
                        `);
}

async function updateExecCommand(oldType, oldCommand) {
    const type = document.getElementById('exec-type').value;
    const command = document.getElementById('exec-command').value.trim();
    if (!command) return showToast('Command is required', 'error');

    try {
        await fetch('/hyprland/exec', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'update', type, command, old_command: oldCommand })
        });
        closeModal();
        await loadExec();
        renderTabContent('exec');
        showToast('Command updated', 'success');
    } catch (e) {
        showToast('Failed to update', 'error');
    }
}

// =============================================================================
// WINDOW RULES CRUD
// =============================================================================



async function loadOpenWindows() {
    try {
        const response = await fetch('/hyprland/windows');
        const data = await response.json();
        openWindows = data.windows || [];
    } catch (e) {
        openWindows = [];
    }
}

function showAddRuleModal() {
    loadOpenWindows().then(() => {
        const windowOptions = openWindows.map((w, index) =>
            `<option value="${index}">${w.class} - ${w.title ? w.title.substring(0, 30) : 'No Title'}</option>`
        ).join('');

        openModal(`
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">Add Window Rule</h3>
                <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
            </div>
            <div class="mb-6">
                <input type="hidden" id="rule-type" value="windowrule">
                <div class="mb-4">
                    <label class="block text-zinc-400 text-sm mb-1">Effect</label>
                <label class="block text-zinc-400 text-sm mb-1">Effect</label>
                <div class="space-y-2">
                    <!-- Manual Input -->
                    <input type="text" id="rule-effect-input" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="e.g., float, center, opacity 0.9">
                    
                    <!-- Presets -->
                    <div class="relative">
                        <select id="rule-effect-preset" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors appearance-none text-zinc-400" onchange="document.getElementById('rule-effect-input').value = this.value; this.value = '';">
                            <option value="">Select a preset to fill above...</option>
                            <!-- Common effects -->
                            <optgroup label="Window State">
                                <option value="float">Float</option>
                                <option value="tile">Tile</option>
                                <option value="fullscreen">Fullscreen</option>
                                <option value="maximize">Maximize</option>
                                <option value="nofocus">No Focus</option>
                                <option value="pin">Pin</option>
                                <option value="center">Center</option>
                            </optgroup>
                            <optgroup label="Appearance">
                                <option value="opacity 0.9">Opacity 0.9</option>
                                <option value="noborder">No Border</option>
                                <option value="noshadow">No Shadow</option>
                                <option value="noblur">No Blur</option>
                            </optgroup>
                            <optgroup label="Workspace">
                                <option value="workspace 1">Workspace 1</option>
                                <option value="workspace special">Special Workspace</option>
                            </optgroup>
                            <optgroup label="Size/Position">
                                <option value="size 80% 80%">Size 80% 80%</option>
                                <option value="size 1000 600">Size 1000x600</option>
                                <option value="exactsize 800 400">Exact Size 800x400</option>
                                <option value="min_size 200 200">Min Size 200x200</option>
                                <option value="max_size 1200 800">Max Size 1200x800</option>
                                <option value="move 100 50">Move 100x50</option>
                                <option value="move 0 0">Move to Top-Left</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="noinitialfocus">No Initial Focus</option>
                                <option value="noanim">No Animation</option>
                                <option value="windowdance">Window Dance</option>
                                <option value="noopaque">No Opaque</option>
                                <option value="forceinput">Force Input</option>
                                <option value="animation slide">Animation Slide</option>
                                <option value="animation popin">Animation Pop-in</option>
                                <option value="animation fade">Animation Fade</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-zinc-400 text-sm mb-1">Select Open Window</label>
                <div class="relative">
                <div class="mb-4">
                    <label class="block text-zinc-400 text-sm mb-1">Select Open Window</label>
                    <div class="relative">
                        <select id="rule-window-select" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors appearance-none" onchange="updateRuleMatch(this.value)">
                            <option value="">-- Select a window to auto-fill --</option>
                            ${windowOptions}
                        </select>
                    </div>
                </div>

                <!-- Match Generator UI -->
                <div id="match-generator-ui" class="hidden mb-4 p-4 bg-zinc-900/50 rounded-md border border-zinc-700/50">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-zinc-500 mb-2 uppercase font-bold tracking-wider">Match Property</div>
                            <div class="space-y-2" id="match-props-container">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="match-prop" value="class" checked onchange="generateMatchString()" class="text-teal-500 rounded border-zinc-600 bg-zinc-800 focus:ring-teal-500">
                                    <span class="text-sm text-zinc-300">Class</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="match-prop" value="title" onchange="generateMatchString()" class="text-teal-500 rounded border-zinc-600 bg-zinc-800 focus:ring-teal-500">
                                    <span class="text-sm text-zinc-300">Title</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="match-prop" value="initialClass" onchange="generateMatchString()" class="text-teal-500 rounded border-zinc-600 bg-zinc-800 focus:ring-teal-500">
                                    <span class="text-sm text-zinc-300">Initial Class</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="match-prop" value="initialTitle" onchange="generateMatchString()" class="text-teal-500 rounded border-zinc-600 bg-zinc-800 focus:ring-teal-500">
                                    <span class="text-sm text-zinc-300">Initial Title</span>
                                </label>
                            </div>
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-zinc-500 mb-2 uppercase font-bold tracking-wider">Precision</div>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="radio" name="match-mode" value="exact" checked onclick="generateMatchString()" class="text-teal-500 focus:ring-teal-500 bg-zinc-800 border-zinc-600">
                                    <span class="text-sm text-zinc-300">Exact Match (^...$)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="radio" name="match-mode" value="starts" onclick="generateMatchString()" class="text-teal-500 focus:ring-teal-500 bg-zinc-800 border-zinc-600">
                                    <span class="text-sm text-zinc-300">Starts With (^...)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="radio" name="match-mode" value="contains" onclick="generateMatchString()" class="text-teal-500 focus:ring-teal-500 bg-zinc-800 border-zinc-600">
                                    <span class="text-sm text-zinc-300">Contains (.*...*)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-zinc-400 mb-1.5">Or enter match manually</label>
                    <input type="text" id="rule-match" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="e.g., class:firefox">
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
                <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
                <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="addWindowRule()">Add</button>
            </div>
        `);
    });
}

async function addWindowRule() {
    const type = document.getElementById('rule-type').value;
    const effect = document.getElementById('rule-effect-input').value.trim();
    const match = document.getElementById('rule-match').value.trim();
    if (!match) return showToast('Match criteria is required', 'error');

    try {
        await fetch('/hyprland/windowrules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'add', type, effect, match })
        });
        closeModal();
        await loadWindowRules();
        renderTabContent('windowrules');
        showToast('Window rule added', 'success');
    } catch (e) {
        showToast('Failed to add', 'error');
    }
}

async function deleteWindowRule(raw) {
    try {
        await fetch('/hyprland/windowrules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', type: '', effect: '', match: '', old_raw: raw })
        });
        await loadWindowRules();
        renderTabContent('windowrules');
        showToast('Window rule deleted', 'success');
    } catch (e) {
        showToast('Failed to delete', 'error');
    }
}

function confirmDeleteRule(raw) {
    const escapedRaw = raw.replace(/'/g, "\\'");
    confirmDialog('Delete Window Rule',
        `Are you sure you want to delete this rule?`,
        `function() {deleteWindowRule('${escapedRaw}')}`);
}

function showEditRuleModal(type, effect, match, raw) {
    const escapedMatch = match.replace(/"/g, '&quot;');
    const escapedRaw = raw.replace(/'/g, "\\'");

    openModal(`
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-white">Edit Window Rule</h3>
                            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
                        </div>
                        <div class="mb-6">
                            <input type="hidden" id="rule-type" value="windowrule">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-zinc-400 mb-1.5">Effect</label>
                                    <input type="text" id="rule-effect" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${effect}">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-zinc-400 mb-1.5">Match</label>
                                    <input type="text" id="rule-match" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${escapedMatch}">
                                </div>
                        </div>
                        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
                            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
                            <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="updateWindowRule('${escapedRaw}')">Save</button>
                        </div>
                        `);
}

async function updateWindowRule(oldRaw) {
    const type = document.getElementById('rule-type').value;
    const effect = document.getElementById('rule-effect').value.trim();
    const match = document.getElementById('rule-match').value.trim();
    if (!effect || !match) return showToast('Effect and match are required', 'error');

    try {
        await fetch('/hyprland/windowrules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'update', type, effect, match, old_raw: oldRaw })
        });
        closeModal();
        await loadWindowRules();
        renderTabContent('windowrules');
        showToast('Window rule updated', 'success');
    } catch (e) {
        showToast('Failed to update', 'error');
    }
}

// =============================================================================
// LAYER RULES CRUD
// =============================================================================

function showAddLayerRuleModal() {
    openModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Add Layer Rule</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
        </div>
        <div class="mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Effect</label>
                <div class="space-y-2">
                    <input type="text" id="layerrule-effect-input" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="e.g., blur, ignorezero, ignore_alpha 0.5">
                    <select id="layerrule-effect-preset" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors appearance-none text-zinc-400" onchange="document.getElementById('layerrule-effect-input').value = this.value; this.value = '';">
                        <option value="" disabled selected>Select a preset...</option>
                        <option value="blur">Blur (Standard)</option>
                        <option value="ignorezero">Ignore Zero (Transparent Pixels)</option>
                        <option value="ignore_alpha 0.5">Ignore Alpha 0.5 (Semi-transparent)</option>
                        <option value="noanim">No Animation</option>
                        <option value="animation slide">Animation: Slide</option>
                        <option value="animation popin">Animation: Popin</option>
                        <option value="animation fade">Animation: Fade</option>
                        <option value="dimaround">Dim Around</option>
                        <option value="stay_focused">Stay Focused</option>
                    </select>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Namespace (Layer Surface)</label>
                <input type="text" id="layerrule-namespace" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="e.g., waybar, rofi, swaync">
                <small class="text-zinc-500 mt-1 block">Common namespaces: waybar, rofi, wofi, swaync, gtk-layer-shell</small>
            </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
            <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="addLayerRule()">Add</button>
        </div>
    `);
}

async function addLayerRule() {
    const effect = document.getElementById('layerrule-effect-input').value.trim();
    const namespace = document.getElementById('layerrule-namespace').value.trim();

    if (!namespace) {
        return showToast('Please enter a namespace', 'error');
    }

    try {
        await fetch('/hyprland/layerrules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'add',
                effect,
                namespace
            })
        });
        closeModal();
        await loadLayerRules();
        renderTabContent('layerrules');
        showToast('Layer rule added', 'success');
    } catch (e) {
        showToast('Failed to add', 'error');
    }
}

function showEditLayerRuleModal(effect, namespace, raw) {
    const escapedEffect = effect.replace(/"/g, '&quot;');
    const escapedNamespace = namespace.replace(/"/g, '&quot;');
    const escapedRaw = raw.replace(/'/g, "\\'");

    openModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Edit Layer Rule</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
        </div>
        <div class="mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Effect</label>
                <div class="space-y-2">
                    <input type="text" id="layerrule-effect-input" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${escapedEffect}">
                    <select id="layerrule-effect-preset" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors appearance-none text-zinc-400" onchange="document.getElementById('layerrule-effect-input').value = this.value; this.value = '';">
                        <option value="" disabled selected>Or choose a preset...</option>
                        <option value="blur">Blur (Standard)</option>
                        <option value="ignorezero">Ignore Zero</option>
                        <option value="ignore_alpha 0.5">Ignore Alpha 0.5</option>
                        <option value="noanim">No Animation</option>
                        <option value="stay_focused">Stay Focused</option>
                    </select>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Namespace</label>
                <input type="text" id="layerrule-namespace" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${escapedNamespace}">
            </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
            <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="updateLayerRule('${escapedRaw}')">Save</button>
        </div>
    `);
}

async function updateLayerRule(oldRaw) {
    const effect = document.getElementById('layerrule-effect-input').value.trim();
    const namespace = document.getElementById('layerrule-namespace').value.trim();

    try {
        await fetch('/hyprland/layerrules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'update',
                effect,
                namespace,
                old_raw: oldRaw
            })
        });
        closeModal();
        await loadLayerRules();
        renderTabContent('layerrules');
        showToast('Layer rule updated', 'success');
    } catch (e) {
        showToast('Failed to update', 'error');
    }
}

async function deleteLayerRule(raw) {
    try {
        await fetch('/hyprland/layerrules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'delete',
                effect: '',
                namespace: '',
                old_raw: raw
            })
        });
        await loadLayerRules();
        renderTabContent('layerrules');
        showToast('Layer rule deleted', 'success');
    } catch (e) {
        showToast('Failed to delete', 'error');
    }
}

function confirmDeleteLayerRule(raw) {
    const escapedRaw = raw.replace(/'/g, "\\'");
    confirmDialog('Delete Layer Rule',
        'Are you sure you want to delete this layer rule?',
        `function() {deleteLayerRule('${escapedRaw}')}`);
}

// =============================================================================
// KEYBINDS CRUD
// =============================================================================

let capturedMods = [];
let capturedKey = '';

// Dispatcher definitions with descriptions and param hints
const DISPATCHERS = {
    // Commands
    exec: { desc: "Execute shell command", param: "command (e.g., kitty, firefox)", category: "Commands" },
    execr: { desc: "Execute raw shell command", param: "command", category: "Commands" },
    pass: { desc: "Pass key to window", param: "window", category: "Commands" },
    sendshortcut: { desc: "Send keys to window", param: "mod, key[, window]", category: "Commands" },
    global: { desc: "Execute Global Shortcut", param: "name", category: "Commands" },

    // Window Actions
    killactive: { desc: "Close active window", param: "none", category: "Window Actions" },
    forcekillactive: { desc: "Force kill active window", param: "none", category: "Window Actions" },
    closewindow: { desc: "Close specified window", param: "window", category: "Window Actions" },
    togglefloating: { desc: "Toggle floating state", param: "empty/window", category: "Window Actions" },
    setfloating: { desc: "Set floating", param: "empty/window", category: "Window Actions" },
    settiled: { desc: "Set tiled", param: "empty/window", category: "Window Actions" },
    fullscreen: { desc: "Toggle fullscreen", param: "0=full, 1=maximize", category: "Window Actions" },
    pin: { desc: "Pin window to all workspaces", param: "empty/window", category: "Window Actions" },
    centerwindow: { desc: "Center floating window", param: "none/1", category: "Window Actions" },

    // Focus & Movement
    movefocus: { desc: "Move focus direction", param: "l/r/u/d", category: "Focus & Movement" },
    movewindow: { desc: "Move window direction/monitor", param: "l/r/u/d or mon:NAME", category: "Focus & Movement" },
    swapwindow: { desc: "Swap with window in direction", param: "l/r/u/d or window", category: "Focus & Movement" },
    focuswindow: { desc: "Focus specific window", param: "window (class:, title:, etc)", category: "Focus & Movement" },
    focusmonitor: { desc: "Focus a monitor", param: "monitor (l/r/+1/-1/name)", category: "Focus & Movement" },
    cyclenext: { desc: "Focus next/prev window", param: "none/prev/tiled/floating", category: "Focus & Movement" },
    swapnext: { desc: "Swap with next window", param: "none/prev", category: "Focus & Movement" },
    bringactivetotop: { desc: "Bring window to top", param: "none", category: "Focus & Movement" },
    alterzorder: { desc: "Change window stack order", param: "top/bottom[,window]", category: "Focus & Movement" },

    // Workspaces
    workspace: { desc: "Switch workspace", param: "ID/+1/-1/name:X/special", category: "Workspaces" },
    movetoworkspace: { desc: "Move window to workspace", param: "workspace[,window]", category: "Workspaces" },
    movetoworkspacesilent: { desc: "Move without switching", param: "workspace[,window]", category: "Workspaces" },
    togglespecialworkspace: { desc: "Toggle scratchpad", param: "none/name", category: "Workspaces" },
    focusworkspaceoncurrentmonitor: { desc: "Focus workspace on current", param: "workspace", category: "Workspaces" },
    movecurrentworkspacetomonitor: { desc: "Move workspace to monitor", param: "monitor", category: "Workspaces" },
    swapactiveworkspaces: { desc: "Swap workspaces between monitors", param: "monitor1 monitor2", category: "Workspaces" },

    // Resize & Position
    resizeactive: { desc: "Resize active window", param: "X Y (e.g., 10 -10, 20%)", category: "Resize" },
    moveactive: { desc: "Move active window", param: "X Y", category: "Resize" },
    resizewindowpixel: { desc: "Resize specific window", param: "X Y,window", category: "Resize" },
    movewindowpixel: { desc: "Move specific window", param: "X Y,window", category: "Resize" },
    splitratio: { desc: "Change split ratio", param: "+0.1/-0.1/exact 0.5", category: "Resize" },

    // Groups
    togglegroup: { desc: "Toggle window group", param: "none", category: "Groups" },
    changegroupactive: { desc: "Switch in group", param: "b/f or index", category: "Groups" },
    lockgroups: { desc: "Lock all groups", param: "lock/unlock/toggle", category: "Groups" },
    lockactivegroup: { desc: "Lock current group", param: "lock/unlock/toggle", category: "Groups" },
    moveintogroup: { desc: "Move into group", param: "l/r/u/d", category: "Groups" },
    moveoutofgroup: { desc: "Move out of group", param: "empty/window", category: "Groups" },

    // System
    exit: { desc: "Exit Hyprland", param: "none", category: "System" },
    dpms: { desc: "Toggle DPMS", param: "on/off/toggle", category: "System" },
    forcerendererreload: { desc: "Reload renderer", param: "none", category: "System" },
    submap: { desc: "Switch submap", param: "reset/name", category: "System" },

    // Layout (Dwindle/Master)
    togglesplit: { desc: "Toggle split orientation", param: "none", category: "Layout" },
    pseudo: { desc: "Toggle pseudo-tiling", param: "none", category: "Layout" },
    layoutmsg: { desc: "Send layout message", param: "message", category: "Layout" },
};

function getDispatcherOptions() {
    const categories = {};
    for (const [name, info] of Object.entries(DISPATCHERS)) {
        if (!categories[info.category]) categories[info.category] = [];
        categories[info.category].push({ name, desc: info.desc });
    }

    let html = '';
    for (const [cat, items] of Object.entries(categories)) {
        html += `<optgroup label="${cat}">`;
        html += items.map(d => `<option value="${d.name}">${d.name} - ${d.desc}</option>`).join('');
        html += '</optgroup>';
    }
    return html;
}

function updateParamHint() {
    const dispatcher = document.getElementById('bind-dispatcher').value;
    const hint = document.getElementById('param-hint');
    const info = DISPATCHERS[dispatcher];
    if (hint && info) {
        hint.textContent = `Parameter: ${info.param}`;
    }
}

function showAddBindModal() {
    capturedMods = [];
    capturedKey = '';

    openModal(`
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Add Keybind</h3>
                        <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
                    </div>
                    <div class="mb-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-zinc-400 mb-1.5">Press your key combination</label>
                            <div id="key-capture-box" class="w-full h-32 bg-zinc-900 border-2 border-dashed border-zinc-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-teal-500 hover:bg-zinc-800 transition-all focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500" tabindex="0" onkeydown="captureKey(event)">
                                <div class="text-xl font-mono text-zinc-200 mb-2 font-bold" id="key-display">Click here and press keys</div>
                                <div class="text-sm text-zinc-500">Hold modifiers (SUPER, ALT, CTRL, SHIFT) and press a key</div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-zinc-400 mb-1.5">Bind Type</label>
                            <select id="bind-type" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                                <option value="bind">bind - Normal keybind</option>
                                <option value="binde">binde - Repeat while held</option>
                                <option value="bindm">bindm - Mouse bind</option>
                                <option value="bindl">bindl - Works when locked</option>
                                <option value="bindr">bindr - On key release</option>
                                <option value="bindel">bindel - Repeat + locked</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-zinc-400 mb-1.5">Dispatcher (Action)</label>
                            <select id="bind-dispatcher" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" onchange="updateParamHint()">
                                ${getDispatcherOptions()}
                            </select>
                            <small id="param-hint" class="block mt-1 text-xs text-zinc-500">Parameter: command (e.g., kitty, firefox)</small>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-zinc-400 mb-1.5">Parameters</label>
                            <input type="text" id="bind-params" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="Enter parameters based on dispatcher">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
                        <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
                        <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="addBind()">Add</button>
                    </div>
                    `);

    setTimeout(() => document.getElementById('key-capture-box').focus(), 100);
}

function captureKey(event) {
    event.preventDefault();

    const mods = [];
    if (event.metaKey || event.key === 'Super' || event.key === 'Meta') mods.push('SUPER');
    if (event.altKey) mods.push('ALT');
    if (event.ctrlKey) mods.push('CTRL');
    if (event.shiftKey) mods.push('SHIFT');

    let key = event.key.toUpperCase();

    // Filter out modifier keys themselves
    if (['CONTROL', 'ALT', 'SHIFT', 'META', 'SUPER'].includes(key)) {
        capturedMods = mods;
        document.getElementById('key-display').textContent = mods.join(' + ') + ' + ...';
        return;
    }

    // Map special keys
    const keyMap = {
        ' ': 'SPACE',
        'ARROWUP': 'UP',
        'ARROWDOWN': 'DOWN',
        'ARROWLEFT': 'LEFT',
        'ARROWRIGHT': 'RIGHT',
        'ENTER': 'RETURN',
        'ESCAPE': 'ESCAPE'
    };
    key = keyMap[key] || key;

    capturedMods = mods;
    capturedKey = key;

    const display = mods.length > 0 ? mods.join(' + ') + ' + ' + key : key;
    document.getElementById('key-display').textContent = display;
    document.getElementById('key-capture-box').classList.add('ring-2', 'ring-teal-500', 'border-teal-500', 'bg-zinc-800');
}

async function addBind() {
    if (!capturedKey) return showToast('Please capture a key combination', 'error');

    const type = document.getElementById('bind-type').value;
    const mods = capturedMods.join('');
    const dispatcher = document.getElementById('bind-dispatcher').value;
    const params = document.getElementById('bind-params').value.trim();

    try {
        await fetch('/hyprland/binds', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'add',
                type,
                mods,
                key: capturedKey,
                dispatcher,
                params
            })
        });
        closeModal();
        await loadBinds();
        renderTabContent('binds');
        showToast('Keybind added', 'success');
    } catch (e) {
        showToast('Failed to add', 'error');
    }
}

async function deleteBind(raw) {
    try {
        await fetch('/hyprland/binds', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', type: '', mods: '', key: '', dispatcher: '', old_raw: raw })
        });
        await loadBinds();
        renderTabContent('binds');
        showToast('Keybind deleted', 'success');
    } catch (e) {
        showToast('Failed to delete', 'error');
    }
}

function confirmDeleteBind(raw) {
    const escapedRaw = raw.replace(/'/g, "\\'");
    confirmDialog('Delete Keybind',
        `Are you sure you want to delete this keybind?`,
        `function() {deleteBind('${escapedRaw}')}`);
}

function getDispatcherOptionsWithSelected(selected) {
    const categories = {};
    for (const [name, info] of Object.entries(DISPATCHERS)) {
        if (!categories[info.category]) categories[info.category] = [];
        categories[info.category].push({ name, desc: info.desc });
    }

    let html = '';
    for (const [cat, items] of Object.entries(categories)) {
        html += `<optgroup label="${cat}">`;
        html += items.map(d => `<option value="${d.name}" ${d.name === selected ? 'selected' : ''}>${d.name} - ${d.desc}</option>`).join('');
        html += '</optgroup>';
    }
    return html;
}

function showEditBindModal(type, mods, key, dispatcher, params, raw) {
    const escapedRaw = raw.replace(/'/g, "\\'");
    const escapedParams = (params || '').replace(/"/g, '&quot;');

    // Pre-set captured values for display
    capturedMods = mods ? mods.match(/(SUPER|ALT|CTRL|SHIFT)/g) || [] : [];
    capturedKey = key;

    const modsDisplay = capturedMods.length > 0 ? capturedMods.join(' + ') + ' + ' + key : key;
    const paramHint = DISPATCHERS[dispatcher]?.param || 'parameters';

    openModal(`
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white">Edit Keybind</h3>
                    <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
                </div>
                <div class="mb-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-1.5">Press your key combination</label>
                        <div id="key-capture-box" class="w-full h-32 bg-zinc-900 border-2 border-dashed border-zinc-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-teal-500 hover:bg-zinc-800 transition-all focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500" tabindex="0" onkeydown="captureKey(event)">
                            <div class="text-xl font-mono text-zinc-200 mb-2 font-bold" id="key-display">${modsDisplay}</div>
                            <div class="text-sm text-zinc-500">Click and press new keys to change</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-1.5">Bind Type</label>
                        <select id="bind-type" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                            <option value="bind" ${type === 'bind' ? 'selected' : ''}>bind - Normal keybind</option>
                            <option value="binde" ${type === 'binde' ? 'selected' : ''}>binde - Repeat while held</option>
                            <option value="bindm" ${type === 'bindm' ? 'selected' : ''}>bindm - Mouse bind</option>
                            <option value="bindl" ${type === 'bindl' ? 'selected' : ''}>bindl - Works when locked</option>
                            <option value="bindr" ${type === 'bindr' ? 'selected' : ''}>bindr - On key release</option>
                            <option value="bindel" ${type === 'bindel' ? 'selected' : ''}>bindel - Repeat + locked</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-1.5">Dispatcher (Action)</label>
                        <select id="bind-dispatcher" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" onchange="updateParamHint()">
                            ${getDispatcherOptionsWithSelected(dispatcher)}
                        </select>
                        <small id="param-hint" class="block mt-1 text-xs text-zinc-500">Parameter: ${paramHint}</small>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-1.5">Parameters</label>
                        <input type="text" id="bind-params" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${escapedParams}">
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
                    <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
                    <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="updateBind('${escapedRaw}')">Save</button>
                </div>
                `);

    setTimeout(() => document.getElementById('key-capture-box').focus(), 100);
}

async function updateBind(oldRaw) {
    if (!capturedKey) return showToast('Key is required', 'error');

    const type = document.getElementById('bind-type').value;
    const mods = capturedMods.join('');
    const dispatcher = document.getElementById('bind-dispatcher').value;
    const params = document.getElementById('bind-params').value.trim();

    try {
        await fetch('/hyprland/binds', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'update',
                type,
                mods,
                key: capturedKey,
                dispatcher,
                params,
                old_raw: oldRaw
            })
        });
        closeModal();
        await loadBinds();
        renderTabContent('binds');
        showToast('Keybind updated', 'success');
    } catch (e) {
        showToast('Failed to update', 'error');
    }
}

// =============================================================================
// GESTURE CRUD
// =============================================================================

// Get gesture action options for select dropdown
function getGestureActionOptions(selected = '') {
    const actions = [
        { value: 'workspace', desc: 'Workspace swipe gesture' },
        { value: 'move', desc: 'Move active window' },
        { value: 'resize', desc: 'Resize active window' },
        { value: 'special', desc: 'Toggle special workspace' },
        { value: 'close', desc: 'Close active window' },
        { value: 'fullscreen', desc: 'Fullscreen (none or maximize)' },
        { value: 'float', desc: 'Float window (toggle/float/tile)' },
        { value: 'dispatcher', desc: 'Run a dispatcher' },
        { value: 'unset', desc: 'Unset a gesture' }
    ];
    return actions.map(a =>
        `<option value="${a.value}" ${a.value === selected ? 'selected' : ''}>${a.value} - ${a.desc}</option>`
    ).join('');
}

function toggleGestureDispatcher() {
    const action = document.getElementById('gesture-action').value;
    const dispatcherGroup = document.getElementById('gesture-dispatcher-group');
    const paramsGroup = document.getElementById('gesture-params-group');
    const paramsLabel = document.getElementById('gesture-params-label');

    if (action === 'dispatcher') {
        dispatcherGroup.style.display = 'block';
        paramsLabel.textContent = 'Dispatcher Parameters';
        updateGestureParamHint();
    } else {
        dispatcherGroup.style.display = 'none';
        // Update params label based on action
        const hints = {
            'workspace': 'Parameters (none needed)',
            'move': 'Parameters (none needed)',
            'resize': 'Parameters (none needed)',
            'special': 'Special workspace name (e.g., mySpecialWorkspace)',
            'close': 'Parameters (none needed)',
            'fullscreen': 'Parameters (none or "maximize")',
            'float': 'Parameters (none, "float", or "tile")',
            'unset': 'Parameters (none needed)'
        };
        paramsLabel.textContent = hints[action] || 'Parameters';
    }
}

function updateGestureParamHint() {
    const dispatcher = document.getElementById('gesture-dispatcher')?.value;
    const hint = document.getElementById('gesture-param-hint');
    const info = DISPATCHERS[dispatcher];
    if (hint && info) {
        hint.textContent = `Parameter: ${info.param}`;
    }
}

function showAddGestureModal() {
    openModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Add Gesture</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
        </div>
        <div class="mb-6">
            <div class="mb-4">
                <label class="block text-zinc-400 text-sm mb-1">Fingers</label>
                <select id="gesture-fingers" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                    <option value="3">3 Fingers</option>
                    <option value="4">4 Fingers</option>
                    <option value="5">5 fingers</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-zinc-400 text-sm mb-1">Direction</label>
                <select id="gesture-direction" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                    <option value="swipe">swipe (any swipe)</option>
                    <option value="horizontal">horizontal</option>
                    <option value="vertical">vertical</option>
                    <option value="left">left</option>
                    <option value="right">right</option>
                    <option value="up">up</option>
                    <option value="down">down</option>
                    <option value="pinch">pinch (any pinch)</option>
                    <option value="pinchin">pinchin</option>
                    <option value="pinchout">pinchout</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-zinc-400 text-sm mb-1">Modifier (Optional)</label>
                <select id="gesture-mod" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                    <option value="">None</option>
                    <option value="SUPER">SUPER</option>
                    <option value="ALT">ALT</option>
                    <option value="CTRL">CTRL</option>
                    <option value="SHIFT">SHIFT</option>
                    <option value="SUPER_ALT">SUPER + ALT</option>
                    <option value="SUPER_CTRL">SUPER + CTRL</option>
                    <option value="SUPER_SHIFT">SUPER + SHIFT</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Scale (optional, e.g., 1.5)</label>
                <input type="text" id="gesture-scale" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="Leave empty for default">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Action</label>
                <select id="gesture-action" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" onchange="toggleGestureDispatcher()">
                    ${getGestureActionOptions()}
                </select>
            </div>
            <div class="mb-4" id="gesture-dispatcher-group" style="display: none;">
                <label class="block text-zinc-400 text-sm mb-1">Dispatcher</label>
                <select id="gesture-dispatcher" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" onchange="updateGestureParamHint()">
                    ${getDispatcherOptions()}
                </select>
                <small id="gesture-param-hint" class="form-hint">Parameter: command (e.g., kitty, firefox)</small>
            </div>
            <div class="mb-4" id="gesture-params-group">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5" id="gesture-params-label">Parameters (none needed)</label>
                <input type="text" id="gesture-params" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="e.g., special workspace name">
            </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
            <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="addGesture()">Add</button>
        </div>
    `);
}

async function addGesture() {
    const fingers = document.getElementById('gesture-fingers').value;
    const direction = document.getElementById('gesture-direction').value;
    const gestureAction = document.getElementById('gesture-action').value;
    const mod = document.getElementById('gesture-mod').value;
    const scale = document.getElementById('gesture-scale').value.trim();
    const isDispatcher = gestureAction === 'dispatcher';

    let params;
    let dispatcher = '';

    if (isDispatcher) {
        dispatcher = document.getElementById('gesture-dispatcher').value;
        params = document.getElementById('gesture-params').value.trim();
    } else {
        params = document.getElementById('gesture-params').value.trim();
    }

    try {
        await fetch('/hyprland/gestures', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'add',
                fingers: parseInt(fingers),
                direction,
                gesture_action: gestureAction,
                dispatcher,
                params,
                mod,
                scale
            })
        });
        closeModal();
        await loadGestures();
        renderTabContent('gestures');
        showToast('Gesture added', 'success');
    } catch (e) {
        showToast('Failed to add', 'error');
    }
}

function showEditGestureModal(fingers, direction, gestureAction, params, raw, dispatcher = '', mod = '', scale = '') {
    const escapedRaw = raw.replace(/'/g, "\\'");
    const escapedParams = (params || '').replace(/"/g, '&quot;');
    const isDispatcher = gestureAction === 'dispatcher';

    openModal(`
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white">Edit Gesture</h3>
                    <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
                </div>
                <div class="mb-6">
                    <div class="w-1/2 pr-2">
                    <label class="block text-zinc-400 text-xs mb-1">Fingers</label>
                    <select id="gesture-fingers" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                        <option value="3" ${data.fingers === '3' ? 'selected' : ''}>3 fingers</option>
                        <option value="4" ${data.fingers === '4' ? 'selected' : ''}>4 fingers</option>
                        <option value="5" ${data.fingers === '5' ? 'selected' : ''}>5 fingers</option>
                    </select>
                </div>
                <div class="w-1/2 pl-2">
                    <label class="block text-zinc-400 text-xs mb-1">Direction</label>
                    <select id="gesture-direction" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                        <option value="swipe" ${data.direction === 'swipe' ? 'selected' : ''}>swipe</option>
                        <option value="u" ${data.direction === 'u' ? 'selected' : ''}>Up (u)</option>
                        <option value="d" ${data.direction === 'd' ? 'selected' : ''}>Down (d)</option>
                        <option value="l" ${data.direction === 'l' ? 'selected' : ''}>Left (l)</option>
                        <option value="r" ${data.direction === 'r' ? 'selected' : ''}>Right (r)</option>
                    </select>
                </div>
                    <div class="w-full mt-3">
                    <label class="block text-zinc-400 text-xs mb-1">Modifier (Optional)</label>
                    <select id="gesture-mod" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                        <option value="" ${data.mod === '' ? 'selected' : ''}>None</option>
                        <option value="SUPER" ${data.mod === 'SUPER' ? 'selected' : ''}>SUPER</option>
                        <option value="ALT" ${data.mod === 'ALT' ? 'selected' : ''}>ALT</option>
                        <option value="CTRL" ${data.mod === 'CTRL' ? 'selected' : ''}>CTRL</option>
                        <option value="SHIFT" ${data.mod === 'SHIFT' ? 'selected' : ''}>SHIFT</option>
                    </select>
                </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-1.5">Scale (optional, e.g., 1.5)</label>
                        <input type="text" id="gesture-scale" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${scale}" placeholder="Leave empty for default">
                    </div>
                    <div class="w-full mt-3">
                    <label class="block text-zinc-400 text-xs mb-1">Action Type</label>
                    <select id="gesture-action" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" onchange="toggleGestureDispatcher()">
                        <option value="dispatch" ${isDispatch ? 'selected' : ''}>Dispatch</option>
                        <option value="exec" ${isExec ? 'selected' : ''}>Exec</option>
                    </select>
                </div>
                
                <div class="w-full mt-3" id="gesture-dispatcher-group">
                    <label class="block text-zinc-400 text-xs mb-1">Dispatcher</label>
                    <select id="gesture-dispatcher" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" onchange="updateGestureParamHint()">
                        ${getDispatcherOptions(currentDispatcher)}
                    </select>
                        <small id="gesture-param-hint" class="form-hint">Parameter: ${DISPATCHERS[dispatcher]?.param || 'parameters'}</small>
                    </div>
                    <div class="mb-4" id="gesture-params-group">
                        <label class="block text-sm font-medium text-zinc-400 mb-1.5" id="gesture-params-label">${isDispatcher ? 'Dispatcher Parameters' : 'Parameters'}</label>
                        <input type="text" id="gesture-params" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${escapedParams}">
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
                    <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
                    <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="updateGesture('${escapedRaw}')">Save</button>
                </div>
                `);
}

async function updateGesture(oldRaw) {
    const fingers = document.getElementById('gesture-fingers').value;
    const direction = document.getElementById('gesture-direction').value;
    const gestureAction = document.getElementById('gesture-action').value;
    const mod = document.getElementById('gesture-mod').value;
    const scale = document.getElementById('gesture-scale').value.trim();
    const isDispatcher = gestureAction === 'dispatcher';

    let params;
    let dispatcher = '';

    if (isDispatcher) {
        dispatcher = document.getElementById('gesture-dispatcher').value;
        params = document.getElementById('gesture-params').value.trim();
    } else {
        params = document.getElementById('gesture-params').value.trim();
    }

    try {
        await fetch('/hyprland/gestures', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'update',
                fingers: parseInt(fingers),
                direction,
                gesture_action: gestureAction,
                dispatcher,
                params,
                mod,
                scale,
                old_raw: oldRaw
            })
        });
        closeModal();
        await loadGestures();
        renderTabContent('gestures');
        showToast('Gesture updated', 'success');
    } catch (e) {
        showToast('Failed to update', 'error');
    }
}

async function deleteGesture(raw) {
    try {
        await fetch('/hyprland/gestures', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', fingers: 0, direction: '', gesture_action: '', old_raw: raw })
        });
        await loadGestures();
        renderTabContent('gestures');
        showToast('Gesture deleted', 'success');
    } catch (e) {
        showToast('Failed to delete', 'error');
    }
}

function confirmDeleteGesture(raw) {
    const escapedRaw = raw.replace(/'/g, "\\'");
    confirmDialog('Delete Gesture',
        `Are you sure you want to delete this gesture?`,
        `function() {deleteGesture('${escapedRaw}')}`);
}

// =============================================================================
// PRESETS
// =============================================================================

async function loadPresets() {
    try {
        const response = await fetch('/presets/hyprland');
        const data = await response.json();
        presets = data.presets || [];
        activePreset = data.active_preset;
    } catch (error) {
        console.error('Failed to load presets:', error);
        presets = [];
        activePreset = null;
    }
}

function renderPresetSelector() {
    // Find or create preset container in the page
    let container = document.getElementById('preset-selector-container');

    // If no container exists, try to add it to the header area
    if (!container) {
        const header = document.querySelector('.page-header') || document.querySelector('.config-header');
        if (header) {
            container = document.createElement('div');
            container.id = 'preset-selector-container';
            container.className = 'flex justify-between items-center mb-4';
            header.appendChild(container);
        } else {
            // Create before tab navigation as fallback
            const tabNav = document.getElementById('tab-nav');
            if (tabNav) {
                container = document.createElement('div');
                container.id = 'preset-selector-container';
                container.className = 'flex justify-between items-center mb-4';
                tabNav.parentElement.insertBefore(container, tabNav);
            } else {
                return; // No suitable location found
            }
        }
    }

    const activePresetData = presets.find(p => p.id === activePreset);
    const changeCount = Object.keys(pendingChanges).length;
    const hasChanges = changeCount > 0;

    container.innerHTML = `
                <div class="flex items-center gap-3 p-1.5 bg-zinc-900 border border-zinc-800 rounded-lg">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-semibold text-zinc-500 uppercase tracking-wider pl-2">Preset:</span>
                        <select id="preset-dropdown" onchange="handlePresetChange(this.value)" class="bg-zinc-800 border-none text-zinc-200 text-sm rounded-md px-2 py-1 focus:ring-1 focus:ring-teal-500 cursor-pointer outline-none hover:bg-zinc-700 transition-colors">
                            <option value="">-- No Preset --</option>
                            ${presets.map(p => `
                        <option value="${p.id}" ${p.id === activePreset ? 'selected' : ''}>
                            ${p.name}
                        </option>
                    `).join('')}
                        </select>
                    </div>
                    <div class="flex items-center gap-1">
                        ${activePreset ? `
                    <button class="px-3 py-1.5 ${hasChanges ? 'bg-teal-500 hover:bg-teal-600 text-white shadow-lg shadow-teal-500/20' : 'bg-zinc-800 hover:bg-zinc-700 text-zinc-300'} text-sm rounded-md transition-all flex items-center gap-2" onclick="saveAndSyncPreset()" title="Save and sync to preset">
                        💾 Save${hasChanges ? ` (${changeCount})` : ''}
                    </button>
                ` : ''}
                        <button class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-sm rounded-md transition-colors flex items-center gap-2" onclick="showSavePresetModal()" title="Save current config as new preset">
                            💾 Save As
                        </button>
                        <button class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-sm rounded-md transition-colors flex items-center gap-2" onclick="showManagePresetsModal()" title="Manage presets">
                            ⚙️
                        </button>
                    </div>
                </div>
                `;
}

async function handlePresetChange(presetId) {
    if (!presetId) {
        // Deactivate current preset
        try {
            await fetch('/presets/hyprland/deactivate', { method: 'POST' });
            activePreset = null;
            showToast('Preset deactivated', 'info');
        } catch (e) {
            showToast('Failed to deactivate preset', 'error');
        }
        return;
    }

    // Check for unsaved changes
    if (Object.keys(pendingChanges).length > 0) {
        confirmDialog(
            'Unsaved Changes',
            'You have unsaved changes. Switching presets will discard them. Continue?',
            `function() { activatePreset('${presetId}') }`
        );
        // Reset dropdown to current if user cancels
        document.getElementById('preset-dropdown').value = activePreset || '';
        return;
    }

    await activatePreset(presetId);
}

async function activatePreset(presetId) {
    try {
        const response = await fetch(`/presets/hyprland/${presetId}/activate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ backup_current: true })
        });

        if (!response.ok) {
            throw new Error('Activation failed');
        }

        const result = await response.json();
        activePreset = presetId;

        // Reload config to reflect changes
        await loadConfig();
        renderTabContent(activeTab);
        renderPresetSelector();

        const preset = presets.find(p => p.id === presetId);
        showToast(`Preset "${preset?.name || presetId}" activated!`, 'success');

        if (result.reload?.reloaded) {
            showToast('Hyprland reloaded', 'success');
        }
    } catch (e) {
        showToast('Failed to activate preset', 'error');
        document.getElementById('preset-dropdown').value = activePreset || '';
    }
}

function showSavePresetModal() {
    openModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">💾 Save as Preset</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
        </div>
        <div class="mb-6">
            <p class="modal-description">Save your current configuration as a reusable preset.</p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Preset Name</label>
                <input type="text" id="preset-name" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="e.g., Battery Save" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Description (optional)</label>
                <textarea id="preset-description" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" placeholder="e.g., Low power mode with no animations"></textarea>
            </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
            <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="saveNewPreset()">Save Preset</button>
        </div>
    `);
}

// Save config and sync to active preset
async function saveAndSyncPreset() {
    // First save the config to file
    if (Object.keys(pendingChanges).length > 0) {
        await saveConfig();
    }

    // Then sync to the active preset
    await syncToActivePreset();

    // Refresh the UI
    renderPresetSelector();
}

// Sync current config to the active preset
async function syncToActivePreset() {
    if (!activePreset) return;

    try {
        const response = await fetch(`/presets/hyprland/${activePreset}/update-content`, {
            method: 'POST'
        });

        if (response.ok) {
            const preset = presets.find(p => p.id === activePreset);
            showToast(`Synced to "${preset?.name}"`, 'success');
        }
    } catch (e) {
        console.error('Failed to sync preset:', e);
    }
}

async function saveNewPreset() {
    const name = document.getElementById('preset-name').value.trim();
    const description = document.getElementById('preset-description').value.trim();

    if (!name) {
        showToast('Please enter a preset name', 'error');
        return;
    }

    // First save any pending changes
    if (Object.keys(pendingChanges).length > 0) {
        await saveConfig();
    }

    try {
        const response = await fetch('/presets/hyprland', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });

        if (!response.ok) {
            throw new Error('Failed to create preset');
        }

        const preset = await response.json();
        presets.push(preset);

        closeModal();
        renderPresetSelector();
        showToast(`Preset "${name}" created!`, 'success');
    } catch (e) {
        showToast('Failed to create preset', 'error');
    }
}

function showManagePresetsModal() {
    openModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">⚙️ Manage Presets</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
        </div>
        <div class="mb-6">
            ${presets.length === 0 ?
            '<p class="text-center py-8 text-zinc-500 italic">No presets saved yet. Click "Save As" to create your first preset.</p>' :
            `<div class="space-y-2">
                ${presets.map(p => `
                    <div class="flex items-center justify-between p-3 bg-zinc-900 border ${p.id === activePreset ? 'border-teal-500 bg-teal-500/5' : 'border-zinc-800 hover:border-zinc-700'} rounded-lg group transition-all">
                        <div class="flex-1 min-w-0 pr-4">
                            <div class="flex items-center gap-2 font-medium text-zinc-200">
                                ${p.name}
                                ${p.id === activePreset ? '<span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider bg-teal-500/10 text-teal-400 border border-teal-500/20">Active</span>' : ''}
                            </div>
                            <div class="text-sm text-zinc-400 mt-0.5 truncate">${p.description || 'No description'}</div>
                            <div class="text-xs text-zinc-600 mt-1">Created: ${new Date(p.created_at).toLocaleDateString()}</div>
                        </div>
                        <div class="flex items-center gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                            ${p.id !== activePreset ? `
                                <button class="p-1.5 text-zinc-400 hover:text-teal-400 hover:bg-zinc-800 rounded transition-colors" onclick="activatePresetFromModal('${p.id}')" title="Activate">▶️</button>
                            ` : ''}
                            <button class="p-1.5 text-zinc-400 hover:text-teal-400 hover:bg-zinc-800 rounded transition-colors" onclick="showEditPresetModal('${p.id}', '${p.name.replace(/'/g, "\\'")}', '${(p.description || '').replace(/'/g, "\\'")}')" title="Edit">✏️</button>
                            <button class="p-1.5 text-zinc-400 hover:text-teal-400 hover:bg-zinc-800 rounded transition-colors" onclick="updatePresetContent('${p.id}')" title="Update with current config">🔄</button>
                            <button class="p-1.5 text-zinc-400 hover:text-red-400 hover:bg-zinc-800 rounded transition-colors" onclick="confirmDeletePreset('${p.id}', '${p.name.replace(/'/g, "\\'")}')" title="Delete">🗑️</button>
                        </div>
                    </div>
                `).join('')}
            </div>`
        }
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Close</button>
        </div>
    `);
}

async function activatePresetFromModal(presetId) {
    await activatePreset(presetId);
    showManagePresetsModal(); // Refresh modal
}

function showEditPresetModal(id, name, description) {
    openModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">✏️ Edit Preset</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
        </div>
        <div class="mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Preset Name</label>
                <input type="text" id="edit-preset-name" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors" value="${name}">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">Description</label>
                <textarea id="edit-preset-description" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors">${description}</textarea>
            </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="showManagePresetsModal()">Back</button>
            <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="updatePreset('${id}')">Save Changes</button>
        </div>
    `);
}

async function updatePreset(presetId) {
    const name = document.getElementById('edit-preset-name').value.trim();
    const description = document.getElementById('edit-preset-description').value.trim();

    if (!name) {
        showToast('Preset name is required', 'error');
        return;
    }

    try {
        const response = await fetch(`/presets/hyprland/${presetId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });

        if (!response.ok) throw new Error('Update failed');

        // Update local state
        const idx = presets.findIndex(p => p.id === presetId);
        if (idx >= 0) {
            presets[idx].name = name;
            presets[idx].description = description;
        }

        showManagePresetsModal();
        renderPresetSelector();
        showToast('Preset updated', 'success');
    } catch (e) {
        showToast('Failed to update preset', 'error');
    }
}

async function updatePresetContent(presetId) {
    // First save pending changes
    if (Object.keys(pendingChanges).length > 0) {
        await saveConfig();
    }

    try {
        const response = await fetch(`/presets/hyprland/${presetId}/update-content`, {
            method: 'POST'
        });

        if (!response.ok) throw new Error('Update failed');

        const preset = presets.find(p => p.id === presetId);
        showToast(`Preset "${preset?.name}" updated with current config`, 'success');
    } catch (e) {
        showToast('Failed to update preset content', 'error');
    }
}

function confirmDeletePreset(presetId, name) {
    confirmDialog(
        'Delete Preset',
        `Are you sure you want to delete the preset "${name}"? This cannot be undone.`,
        `function() { deletePreset('${presetId}') }`
    );
}

async function deletePreset(presetId) {
    try {
        const response = await fetch(`/presets/hyprland/${presetId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Delete failed');


        presets = presets.filter(p => p.id !== presetId);
        if (activePreset === presetId) {
            activePreset = null;
        }

        showManagePresetsModal();
        renderPresetSelector();
        showToast('Preset deleted', 'success');
    } catch (e) {
        showToast('Failed to delete preset', 'error');
    }
}

// ArchBoard Shared Utilities
// Common functionality used across all tool pages

// =============================================================================
// SETTINGS STATE (persisted in localStorage)
// =============================================================================

const ArchBoard = {
    // localStorage key mapping
    _storageKeys: {
        toastsEnabled: 'archboard_toasts',
        autosaveEnabled: 'archboard_autosave'
    },

    // Settings with defaults
    settings: {
        toastsEnabled: localStorage.getItem('archboard_toasts') !== 'false',
        autosaveEnabled: localStorage.getItem('archboard_autosave') === 'true'
    },

    // Update a setting
    setSetting(key, value) {
        this.settings[key] = value;
        const storageKey = this._storageKeys[key] || `archboard_${key}`;
        localStorage.setItem(storageKey, value.toString());
    },

    // Get a setting
    getSetting(key) {
        return this.settings[key];
    }
};

// =============================================================================
// TOAST NOTIFICATIONS
// =============================================================================

function showToast(message, type = 'info') {
    // Skip if toasts are disabled
    if (!ArchBoard.settings.toastsEnabled) return;

    let container = document.getElementById('toast-container');

    // Create container if it doesn't exist
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'fixed bottom-6 right-6 flex flex-col gap-2 z-[9999] pointer-events-none';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    const typeClasses = {
        'info': 'border-blue-500 bg-blue-500/10 text-blue-200',
        'success': 'border-teal-500 bg-teal-500/10 text-teal-200',
        'error': 'border-red-500 bg-red-500/10 text-red-200'
    };

    toast.className = `flex items-center justify-between gap-4 px-4 py-3 bg-zinc-900 border rounded-lg text-sm shadow-xl min-w-[300px] pointer-events-auto transition-all duration-300 animate-in slide-in-from-right-full ${typeClasses[type] || typeClasses['info']}`;
    toast.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="hover:text-white transition-colors">×</button>
    `;
    container.appendChild(toast);

    // Auto remove after 3 seconds
    setTimeout(() => toast.remove(), 3000);
}

// Force show toast even if disabled (for settings confirmation)
function forceShowToast(message, type = 'info') {
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'fixed bottom-6 right-6 flex flex-col gap-2 z-[10000] pointers-events-none';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    const typeClasses = {
        'info': 'border-blue-500 bg-blue-500/10 text-blue-200',
        'success': 'border-teal-500 bg-teal-500/10 text-teal-200',
        'error': 'border-red-500 bg-red-500/10 text-red-200'
    };
    toast.className = `flex items-center justify-between gap-4 px-4 py-3 bg-zinc-900 border rounded-lg text-sm shadow-xl min-w-[300px] pointer-events-auto transition-all duration-300 animate-in slide-in-from-right-full ${typeClasses[type] || typeClasses['info']}`;
    toast.innerHTML = `<span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// =============================================================================
// MODAL SYSTEM
// =============================================================================

function openGlobalModal(content) {
    let overlay = document.getElementById('global-modal-overlay');

    // Create modal overlay if it doesn't exist
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'global-modal-overlay';
        overlay.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 [&.active]:opacity-100 [&.active]:pointer-events-auto';
        overlay.onclick = closeGlobalModal;

        const modalContent = document.createElement('div');
        modalContent.id = 'global-modal-content';
        modalContent.className = 'bg-zinc-900 border border-zinc-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200 [&.active]:scale-100';
        modalContent.onclick = (e) => e.stopPropagation();

        overlay.appendChild(modalContent);
        document.body.appendChild(overlay);
    }

    const modalContent = document.getElementById('global-modal-content');
    modalContent.innerHTML = content;
    overlay.classList.add('active');
}

function closeGlobalModal() {
    const overlay = document.getElementById('global-modal-overlay');
    if (overlay) overlay.classList.remove('active');
}

// Shorter aliases for convenience - these check for page-specific modal first
function openModal(content) {
    // Check for page-specific modal overlay first (styled consistently with page)
    const pageOverlay = document.getElementById('modal-overlay');
    if (pageOverlay) {
        const modalContent = document.getElementById('modal-content');
        if (modalContent) {
            modalContent.innerHTML = content;
            pageOverlay.classList.add('active');
            return;
        }
    }
    // Fall back to global modal
    openGlobalModal(content);
}

function closeModal() {
    // Check for page-specific modal overlay first
    const pageOverlay = document.getElementById('modal-overlay');
    if (pageOverlay && pageOverlay.classList.contains('active')) {
        pageOverlay.classList.remove('active');
        return;
    }
    // Fall back to global modal
    closeGlobalModal();
}

// Confirm dialog helper - shows a confirmation dialog with customizable action
function confirmDialog(title, message, onConfirmFn, confirmText = 'Confirm', isDangerous = true) {
    const buttonClass = isDangerous
        ? 'bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/50'
        : 'bg-teal-600 hover:bg-teal-500 text-white';

    openModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">${title}</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
        </div>
        <div class="mb-6">
            <p class="text-zinc-300">${message}</p>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
            <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
            <button class="px-4 py-2 ${buttonClass} rounded-lg transition-colors" 
                onclick="(${onConfirmFn})(); closeModal();">${confirmText}</button>
        </div>
    `);
}

// =============================================================================
// GLOBAL SETTINGS MODAL
// =============================================================================

function toggleToasts(enabled) {
    ArchBoard.setSetting('toastsEnabled', enabled);
    forceShowToast(`Toasts ${enabled ? 'enabled' : 'disabled'}`);
}

function toggleGlobalAutosave(enabled) {
    ArchBoard.setSetting('autosaveEnabled', enabled);
    forceShowToast(`Autosave ${enabled ? 'enabled' : 'disabled'}`);

    // Also update any tool-specific autosave state
    if (typeof autosaveEnabled !== 'undefined') {
        autosaveEnabled = enabled;
    }

    // Update toggle in hyprland header if it exists
    const toggle = document.getElementById('autosave-toggle');
    if (toggle) toggle.checked = enabled;
}

function showGlobalSettingsModal() {
    openGlobalModal(`
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">⚙️ Settings</h3>
            <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeGlobalModal()">×</button>
        </div>
        <div class="mb-6">
            <div class="flex flex-col gap-3">
                <div class="flex justify-between items-center p-4 bg-zinc-800/50 rounded-lg border border-zinc-700/50">
                    <div class="flex-1 mr-4">
                        <div class="font-medium text-zinc-200 mb-1">Show Notifications</div>
                        <div class="text-xs text-zinc-500">Display toast messages for save, sync, and other actions</div>
                    </div>
                    
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer" ${ArchBoard.settings.toastsEnabled ? 'checked' : ''} onchange="toggleToasts(this.checked)">
                        <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-teal-500/20 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div>
                    </label>
                </div>
                <div class="flex justify-between items-center p-4 bg-zinc-800/50 rounded-lg border border-zinc-700/50">
                    <div class="flex-1 mr-4">
                        <div class="font-medium text-zinc-200 mb-1">Autosave</div>
                        <div class="text-xs text-zinc-500">Automatically save changes as you edit</div>
                    </div>
                    
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer" ${ArchBoard.settings.autosaveEnabled ? 'checked' : ''} onchange="toggleGlobalAutosave(this.checked)">
                        <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-teal-500/20 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div>
                    </label>
                </div>
            </div>
        </div>
        <div class="flex justify-end pt-4 border-t border-zinc-700/50">
            <button class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 text-white rounded-lg text-sm font-medium transition-colors" onclick="closeGlobalModal()">Close</button>
        </div>
    `);
}

// Initialize global settings button
document.addEventListener('DOMContentLoaded', () => {
    // Find the settings button in header and wire it up
    const settingsButtons = document.querySelectorAll('button[title="Settings"]');
    settingsButtons.forEach(btn => {
        btn.onclick = showGlobalSettingsModal;
    });
});


// DOM Elements
let elements = {};

function initElements() {
    elements = {
        // Lists
        listLeft: document.getElementById('list-left'),
        listCenter: document.getElementById('list-center'),
        listRight: document.getElementById('list-right'),
        listAvailable: document.getElementById('list-available'),
        searchInput: document.getElementById('search-modules'),

        // Editor
        emptyState: document.getElementById('empty-state'),
        editorContainer: document.getElementById('editor-container'),
        moduleTitle: document.getElementById('module-title'),
        moduleTypeDisplay: document.getElementById('module-type-display'),
        saveBtn: document.getElementById('save-btn'),
        statusMsg: document.getElementById('status-msg'),

        // Config View
        moduleConfig: document.getElementById('module-config'),

        // Form View
        formContainer: document.getElementById('view-simple'),

        // Style View
        styleColor: document.getElementById('style-color'),
        styleColorPicker: document.getElementById('style-color-picker'),
        styleBg: document.getElementById('style-bg'),
        styleBgPicker: document.getElementById('style-bg-picker'),
        styleFontSize: document.getElementById('style-font-size'),
        stylePadding: document.getElementById('style-padding'),
        styleCustom: document.getElementById('module-custom-css'),

        // Tabs
        tabSimple: document.getElementById('tab-simple'),
        tabJson: document.getElementById('tab-json'),
        tabStyle: document.getElementById('tab-style'),

        viewSimple: document.getElementById('view-simple'),
        viewJson: document.getElementById('view-json'),
        viewStyle: document.getElementById('view-style'),

        // Settings
        settingLayer: document.getElementById('setting-layer'),
        settingPosition: document.getElementById('setting-position'),
    };
}

// State
let fullConfig = {};
let schemas = {}; // Loaded schemas
let cssContent = "";
let currentModule = null;
let currentView = 'simple'; // 'simple' | 'json' | 'style'

// Initial Load
let initRetries = 0;
async function init() {
    console.log("Waybar Editor: Init started");
    initElements();

    if (!elements.listLeft) {
        initRetries++;
        if (initRetries > 20) {
            console.error("Failed to find DOM elements after 20 retries.");
            return;
        }
        setTimeout(init, 200);
        return;
    }

    await Promise.all([fetchConfig(), fetchSchema(), fetchStyle()]);
    setupEventListeners();
    renderLayout();
    console.log("Waybar Editor: Init complete");
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}

// Fetchers
async function fetchConfig() {
    try {
        const res = await fetch('/waybar/config');
        fullConfig = await res.json();
        if (Array.isArray(fullConfig)) fullConfig = fullConfig[0];
        console.log("Waybar Editor: Config loaded", Object.keys(fullConfig));

        if (elements.settingLayer) elements.settingLayer.value = fullConfig.layer || 'top';
        if (elements.settingPosition) elements.settingPosition.value = fullConfig.position || 'top';

    } catch (e) {
        console.error("Config load failed", e);
        showStatus('Failed to load config', 'text-red-500');
    }
}

async function fetchSchema() {
    try {
        const res = await fetch('/waybar/schema');
        schemas = await res.json();
        console.log("Waybar Editor: Schema loaded", Object.keys(schemas));
    } catch (e) {
        console.error("Schema load failed", e);
    }
}

async function fetchStyle() {
    try {
        const res = await fetch('/waybar/style');
        const data = await res.json();
        cssContent = data.content || "";
        console.log("Waybar Editor: Style loaded");
    } catch (e) {
        console.error("Style load failed", e);
    }
}

// Layout Rendering
function renderLayout() {
    console.log("Waybar Editor: Rendering layout");
    const query = elements.searchInput.value.toLowerCase();

    const modulesLeft = fullConfig['modules-left'] || [];
    const modulesCenter = fullConfig['modules-center'] || [];
    const modulesRight = fullConfig['modules-right'] || [];

    const allDefined = new Set([
        ...modulesLeft, ...modulesCenter, ...modulesRight,
        ...Object.keys(fullConfig).filter(k =>
            typeof fullConfig[k] === 'object' &&
            !['modules-left', 'modules-center', 'modules-right'].includes(k) &&
            !['layer', 'position', 'height', 'width', 'spacing', 'margin'].includes(k)
        )
    ]);

    const usedModules = new Set([...modulesLeft, ...modulesCenter, ...modulesRight]);
    const availableModules = Array.from(allDefined).filter(m => !usedModules.has(m));

    renderList(elements.listLeft, modulesLeft, 'modules-left', query);
    renderList(elements.listCenter, modulesCenter, 'modules-center', query);
    renderList(elements.listRight, modulesRight, 'modules-right', query);
    renderList(elements.listAvailable, availableModules, 'available', query);
}

function renderList(container, modules, listName, query) {
    container.innerHTML = '';
    modules.filter(m => m.toLowerCase().includes(query)).forEach(m => {
        const el = document.createElement('div');
        // We use onclick attributes. Ensure selectModule is global.
        el.className = `group flex items-center justify-between p-2.5 rounded-lg text-sm text-zinc-200 bg-zinc-800 border border-zinc-700 cursor-grab mb-2 hover:bg-zinc-700 hover:border-zinc-600 transition-all ${currentModule === m ? 'border-teal-500 bg-teal-500/10' : ''}`;
        el.innerHTML = `
            <div class="flex items-center gap-3 flex-1 cursor-pointer min-w-0" onclick="selectModule('${m}')">
                <div class="w-8 h-8 rounded bg-zinc-700 flex items-center justify-center text-sm text-zinc-400 flex-shrink-0">${getModuleIcon(m)}</div>
                <span class="text-xs font-medium text-zinc-300 truncate">${m}</span>
            </div>
            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                ${plugin_enabled ? `
                    <button class="p-1.5 text-zinc-400 hover:text-pink-400 hover:bg-white/5 rounded transition-colors" title="Move to Available" onclick="moveModule('${m}', '${listName}', 'available')">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                ` : `
                    <button class="p-1.5 text-zinc-400 hover:text-green-400 hover:bg-white/5 rounded transition-colors" title="Add to Right" onclick="moveModule('${m}', 'available', 'modules-right')">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    </button>
                `}
            </div>
        `;
        container.appendChild(el);
    });
}

function getModuleIcon(name) {
    if (name.includes('clock')) return '🕒';
    if (name.includes('battery')) return '🔋';
    if (name.includes('cpu')) return '💻';
    if (name.includes('memory')) return '🧠';
    if (name.includes('network')) return '📡';
    if (name.includes('sound') || name.includes('audio') || name.includes('pulse')) return '🔊';
    if (name.includes('tray')) return '📥';
    if (name.includes('workspaces')) return '🗂️';
    if (name.includes('window')) return '🪟';
    if (name.includes('launcher')) return '🚀';
    if (name.includes('temperature')) return '🌡️';
    if (name.includes('backlight')) return '☀';
    return '📦';
}

// Logic
async function moveModule(name, fromList, toList) {
    console.log("Waybar Editor: Moving module", name, fromList, toList);
    if (fromList === toList) return;
    if (fromList !== 'available') {
        const arr = fullConfig[fromList];
        const idx = arr.indexOf(name);
        if (idx !== -1) arr.splice(idx, 1);
        await updateConfigValue(fromList, arr);
    }
    if (toList !== 'available') {
        if (!fullConfig[toList]) fullConfig[toList] = [];
        fullConfig[toList].push(name);
        await updateConfigValue(toList, fullConfig[toList]);
    }
    renderLayout();
}

async function updateGeneralSettings(key, value) {
    fullConfig[key] = value;
    await updateConfigValue(key, value);
}

async function updateConfigValue(key, value) {
    try {
        await fetch('/waybar/config/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ module: key, value: value })
        });
        showStatus('Saved', 'text-green-400');
    } catch (e) {
        showStatus('Save failed', 'text-red-500');
    }
}

// Selection & Editor
function selectModule(name) {
    console.log("Waybar Editor: selectModule called for", name);
    currentModule = name;

    if (!elements.moduleTitle) {
        console.error("Waybar Editor: moduleTitle element missing");
        return;
    }

    elements.moduleTitle.textContent = name;

    // Toggle containers
    console.log("Waybar Editor: Showing editor container");
    if (elements.emptyState) elements.emptyState.style.display = 'none';

    if (elements.editorContainer) {
        elements.editorContainer.classList.remove('hidden');
        elements.editorContainer.classList.add('active'); // CSS requires .active to show
    }

    const modConfig = fullConfig[name] || {};
    if (elements.moduleConfig) elements.moduleConfig.value = JSON.stringify(modConfig, null, 4);

    // Determine typehidden
    let type = name;
    if (name.startsWith("custom/")) type = "custom";
    else if (name.startsWith("hyprland/")) type = name; // Exact match for defined ones

    // Check schemas
    let schema = schemas[type];

    // Fallback: Check if name matches a key in schema directly (e.g. "clock")
    if (!schema && schemas[name]) schema = schemas[name];

    // Fallback for generic custom
    if (!schema && name.includes("/")) {
        // e.g. "custom/foo" -> try "custom"
        if (name.startsWith("custom/")) schema = schemas["custom"];
    }

    if (schema) {
        console.log("Waybar Editor: Schema found", schema.title);
        elements.moduleTypeDisplay.textContent = `Type: ${schema.title}`;
        renderForm(schema, modConfig);
        if (currentView === 'json' || currentView === 'style') {
            // Keep current view
        } else {
            switchTab('simple');
        }
    } else {
        console.log("Waybar Editor: No schema found for", name);
        elements.moduleTypeDisplay.textContent = `Type: Generic (JSON)`;
        elements.formContainer.innerHTML = '<div class="text-zinc-500 p-4 text-center">No visual settings available for this module. Use JSON editor.</div>';
        switchTab('json');
    }

    // Populate Style
    populateStyleEditor(name);

    renderLayout();
}

// Attach to window to ensure global access for inline onclick
window.selectModule = selectModule;
window.moveModule = moveModule;

function renderForm(schema, config) {
    const container = elements.formContainer;
    container.innerHTML = '';

    schema.options.forEach(opt => {
        const group = document.createElement('div');
        group.className = 'mb-4';

        const label = document.createElement('label');
        label.className = 'block text-sm font-medium text-zinc-400 mb-1.5';
        label.textContent = opt.description || opt.name;
        group.appendChild(label);

        let input;
        const val = config[opt.name] !== undefined ? config[opt.name] : (opt.default !== undefined ? opt.default : "");

        if (opt.type === 'bool') {
            // Container for toggle
            input = document.createElement('div');
            input.className = 'flex items-center justify-between p-3 bg-zinc-800/50 rounded-lg border border-zinc-700/50';

            // Custom toggle structure matching hyprland.js
            const labelToggle = document.createElement('label');
            labelToggle.className = 'relative inline-flex items-center cursor-pointer';

            const chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.className = 'sr-only peer';
            chk.checked = val === true;
            chk.onchange = (e) => updateFormValue(opt.name, e.target.checked);

            const slider = document.createElement('div');
            slider.className = "w-11 h-6 bg-zinc-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-teal-500/20 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500";

            labelToggle.appendChild(chk);
            labelToggle.appendChild(slider);

            // Label text container
            const labelContainer = document.createElement('div');
            const mainLabel = document.createElement('span');
            mainLabel.className = 'text-sm font-medium text-zinc-200 block';
            mainLabel.textContent = opt.name; // Use short name for toggle title

            labelContainer.appendChild(mainLabel);
            if (opt.description) {
                const desc = document.createElement('span');
                desc.className = 'text-xs text-zinc-500 block';
                desc.textContent = opt.description;
                labelContainer.appendChild(desc);
            }

            input.appendChild(labelContainer);
            input.appendChild(labelToggle);

            // Hide the group label since we handled it inside
            label.style.display = 'none';
        }
        else if (opt.type === 'int' || opt.type === 'float') {
            input = document.createElement('input');
            input.type = 'number';
            input.className = 'w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors';
            if (opt.type === 'float') input.step = opt.step || "0.1";
            input.value = val;
            input.oninput = (e) => updateFormValue(opt.name, opt.type === 'int' ? parseInt(e.target.value) : parseFloat(e.target.value));
        }
        else if (opt.type === 'enum' && opt.choices) {
            input = document.createElement('select');
            input.className = 'w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors cursor-pointer';
            opt.choices.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                if (c == val) option.selected = true;
                input.appendChild(option);
            });
            input.onchange = (e) => updateFormValue(opt.name, e.target.value);
        }
        else if (opt.type === 'json') {
            input = document.createElement('textarea');
            input.className = 'w-full bg-zinc-800 font-mono text-sm text-zinc-200 rounded-lg p-4 border border-zinc-700 focus:border-teal-500 outline-none resize-none transition-all h-32';
            input.value = typeof val === 'object' ? JSON.stringify(val) : val;
            input.onchange = (e) => {
                try {
                    const j = JSON.parse(e.target.value);
                    updateFormValue(opt.name, j);
                    input.classList.remove('border-red-500');
                } catch (err) {
                    input.classList.add('border-red-500');
                }
            };
        }
        else {
            // String
            input = document.createElement('input');
            input.type = 'text';
            input.className = 'w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-zinc-200 text-sm focus:outline-none focus:border-teal-500 transition-colors';
            input.value = val;
            input.oninput = (e) => updateFormValue(opt.name, e.target.value);
        }

        if (opt.type !== 'bool') group.appendChild(input); // Bool appends its own container
        else group.appendChild(input);

        container.appendChild(group);
    });
}

function updateFormValue(key, value) {
    if (!currentModule) return;

    // Update local config object
    if (!fullConfig[currentModule]) fullConfig[currentModule] = {};
    fullConfig[currentModule][key] = value;

    // Sync JSON view
    elements.moduleConfig.value = JSON.stringify(fullConfig[currentModule], null, 4);
}

function populateStyleEditor(name) {
    const selector = `#${name} `;
    // Simple regex matching for now
    const blockMatch = new RegExp(`${selector.replace(/\//g, '\\/')}\\s*\\{([^}]*)\\}`, 'm').exec(cssContent);
    // Also try without # for custom classes if needed, but standard modules use #name

    // Reset
    elements.styleColor.value = ''; elements.styleColorPicker.value = '#ffffff';
    elements.styleBg.value = ''; elements.styleBgPicker.value = '#000000';
    elements.styleFontSize.value = '';
    elements.stylePadding.value = '';

    if (blockMatch) {
        const content = blockMatch[1];
        const getProp = (p) => {
            const m = new RegExp(`${p}\\s*:\\s*([^;]+);`).exec(content);
            return m ? m[1].trim() : '';
        };

        const color = getProp('color');
        if (color) { elements.styleColor.value = color; elements.styleColorPicker.value = color.startsWith('#') ? color : '#ffffff'; }

        const bg = getProp('background') || getProp('background-color');
        if (bg) { elements.styleBg.value = bg; elements.styleBgPicker.value = bg.startsWith('#') ? bg : '#000000'; }

        elements.styleFontSize.value = getProp('font-size');
        elements.stylePadding.value = getProp('padding');
    }
}

async function saveCurrentModule() {
    if (!currentModule) return;

    try {
        let newContent;
        // If we are in Simple view, the fullConfig[currentModule] is already updated by event listeners
        // If in JSON view, we need to parse textarea
        if (currentView === 'json') {
            newContent = JSON.parse(elements.moduleConfig.value);
            fullConfig[currentModule] = newContent;
        } else {
            newContent = fullConfig[currentModule];
        }

        elements.saveBtn.textContent = 'Saving...';

        const res = await fetch('/waybar/config/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                module: currentModule,
                value: newContent
            })
        });

        if (res.ok) {
            showStatus('Config saved', 'text-green-400');
        } else {
            const err = await res.json();
            showStatus('Error: ' + err.error, 'text-red-400');
        }
    } catch (e) {
        showStatus('Invalid JSON', 'text-red-400');
    } finally {
        elements.saveBtn.innerHTML = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg> Save`;
    }
}

async function updateStyle(prop, value) {
    if (!currentModule) return;
    let cssId = '#' + currentModule;
    if (currentModule.includes('/')) {
        const parts = currentModule.split('/');
        if (parts[0] === 'custom') cssId = '#custom-' + parts[1];
        else cssId = '#' + parts[1];
    }
    // Correction for specific hyprland modules if needed
    if (currentModule == "hyprland/workspaces") cssId = "#workspaces";
    if (currentModule == "hyprland/window") cssId = "#window";

    try {
        await fetch('/waybar/style/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                selector: cssId,
                property: prop,
                value: value
            })
        });
        showStatus('Style updated', 'text-green-400');
    } catch (e) {
        showStatus('Style update failed', 'text-red-400');
    }
}

function switchTab(view) {
    currentView = view;

    // Reset classes
    [elements.tabSimple, elements.tabJson, elements.tabStyle].forEach(t => {
        t.classList.remove('active');
    });

    [elements.viewSimple, elements.viewJson, elements.viewStyle].forEach(v => v.classList.add('hidden'));

    if (view === 'simple') {
        elements.tabSimple.classList.add('active');
        elements.viewSimple.classList.remove('hidden');
    } else if (view === 'json') {
        elements.tabJson.classList.add('active');
        elements.viewJson.classList.remove('hidden');
        // Ensure JSON is up to date
        if (currentModule) elements.moduleConfig.value = JSON.stringify(fullConfig[currentModule], null, 4);
    } else {
        elements.tabStyle.classList.add('active');
        elements.viewStyle.classList.remove('hidden');
    }
}

function showStatus(msg, cls) {
    elements.statusMsg.textContent = msg;
    elements.statusMsg.className = 'mt-4 text-sm text-center ' + cls;
    elements.statusMsg.classList.remove('hidden');
    setTimeout(() => elements.statusMsg.classList.add('hidden'), 3000);
}

function setupEventListeners() {
    elements.searchInput.addEventListener('input', renderLayout);
    elements.saveBtn.addEventListener('click', saveCurrentModule);

    elements.tabSimple.addEventListener('click', () => switchTab('simple'));
    elements.tabJson.addEventListener('click', () => switchTab('json'));
    elements.tabStyle.addEventListener('click', () => switchTab('style'));

    elements.settingLayer.addEventListener('change', (e) => updateGeneralSettings('layer', e.target.value));
    elements.settingPosition.addEventListener('change', (e) => updateGeneralSettings('position', e.target.value));

    const debounce = (fn, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn(...args), delay);
        };
    };

    const styleHandler = (prop) => debounce((e) => updateStyle(prop, e.target.value), 500);

    elements.styleColor.addEventListener('input', styleHandler('color'));
    elements.styleColorPicker.addEventListener('input', (e) => {
        elements.styleColor.value = e.target.value;
        updateStyle('color', e.target.value);
    });

    elements.styleBg.addEventListener('input', styleHandler('background'));
    elements.styleBgPicker.addEventListener('input', (e) => {
        elements.styleBg.value = e.target.value;
        updateStyle('background', e.target.value);
    });

    elements.styleFontSize.addEventListener('input', styleHandler('font-size'));
    elements.stylePadding.addEventListener('input', styleHandler('padding'));
}

/**
 * UI Renderer & Search Utility
 * Provides a consistent API for generating UI elements and handling search/filtering.
 */

class UI {

    /**
     * Render a standard table with columns and actions
     * @param {Object} options
     * @param {string[]} options.headers - Column headers
     * @param {Array} options.data - Data rows
     * @param {Function} options.rowRenderer - Function(item) => html string for row cells <table> content
     * @param {string} options.emptyMessage - Message to show if data is empty
     * @returns {string} HTML string
     */
    static renderTable({ headers, data, rowRenderer, emptyMessage = 'No items found' }) {
        if (!data || data.length === 0) {
            return `<div class="bg-zinc-900 border border-zinc-800 rounded-xl p-8 text-center text-zinc-500">${emptyMessage}</div>`;
        }

        const headerHtml = headers.map(h =>
            `<th class="text-zinc-500 font-medium text-xs uppercase tracking-wider p-3 border-b border-zinc-800 text-left">${h}</th>`
        ).join('');

        const rowsHtml = data.map(item =>
            `<tr class="hover:bg-zinc-800/40 border-b border-zinc-800 last:border-0 transition-colors">${rowRenderer(item)}</tr>`
        ).join('');

        return `
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden search-container">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm border-collapse">
                        <thead>
                            <tr>${headerHtml}</tr>
                        </thead>
                        <tbody class="searchable-list">
                            ${rowsHtml}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    /**
     * Render a section header with title and optional add button
     */
    static renderSectionHeader(title, addButtonFn_or_HTML, count = null) {
        const countBadge = count !== null ? `<span class="text-zinc-500 ml-2 text-xs">(${count})</span>` : '';

        let buttonHtml = '';
        if (typeof addButtonFn_or_HTML === 'string') {
            // If string passed, treat as label for button
            buttonHtml = `<button class="flex items-center gap-2 px-3 py-1.5 bg-teal-500 hover:bg-teal-600 text-white rounded-md text-sm transition-colors" onclick="${addButtonFn_or_HTML}"> + Add </button>`;
        } else if (addButtonFn_or_HTML) {
            // If object passed (label, onclick)
            buttonHtml = `<button class="flex items-center gap-2 px-3 py-1.5 bg-teal-500 hover:bg-teal-600 text-white rounded-md text-sm transition-colors" onclick="${addButtonFn_or_HTML.onclick}"> + ${addButtonFn_or_HTML.label} </button>`;
        }

        return `
            <div class="px-5 py-3.5 bg-zinc-800/30 border-b border-zinc-800 flex justify-between items-center">
                <h3 class="text-sm font-semibold text-zinc-200 uppercase tracking-wider m-0">${title} ${countBadge}</h3>
                <div class="flex gap-4 items-center">
                    <div class="relative">
                        <input type="text" 
                               placeholder="Search ${title.toLowerCase()}..." 
                               onkeyup="UI.filterSection(this)"
                               class="w-48 px-3 py-1.5 bg-zinc-900 border border-zinc-700 rounded-md text-xs text-zinc-300 focus:outline-none focus:border-teal-500 transition-width focus:w-64">
                    </div>
                    ${buttonHtml}
                </div>
            </div>
        `;
    }

    /**
     * Global filter function attached to section search inputs
     */
    static filterSection(input) {
        const query = input.value.toLowerCase();
        // Find the parent container (the section)
        const container = input.closest('.bg-zinc-900');
        if (!container) return;

        // Try to filter table rows
        const rows = container.querySelectorAll('tbody tr');
        if (rows.length > 0) {
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
            return;
        }

        // Try to filter divs (like in monitors or window rules list)
        // We assume items are direct children of a specific container or marked with a class
        // Let's look for common list item patterns
        const listItems = container.querySelectorAll('.searchable-item, .bg-zinc-800.border.border-zinc-700, .border-b.border-zinc-800');

        listItems.forEach(item => {
            // Skip the header itself if matched
            if (item.contains(input)) return;

            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(query) ? '' : 'none';
        });
    }

    /**
     * Standard modal content generator
     */
    static renderModalHeader(title) {
        return `
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">${title}</h3>
                <button class="text-zinc-500 hover:text-white text-2xl leading-none" onclick="closeModal()">×</button>
            </div>
        `;
    }

    static renderModalFooter(primaryAction, cancelAction = 'closeModal()', primaryLabel = 'Save', cancelLabel = 'Cancel') {
        return `
            <div class="flex justify-end gap-3 pt-4 border-t border-zinc-800/50">
                <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition-colors" onclick="${cancelAction}">${cancelLabel}</button>
                <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors" onclick="${primaryAction}">${primaryLabel}</button>
            </div>
        `;
    }
}

// Expose UI globally
window.UI = UI;

class ImagePicker {
    constructor() {
        this.options = {
            multiselect: false,
            folderSelect: false,
            onSelect: null
        };
        this.isOpen = false;
        this.activeTab = 'library'; // library, upload, folders
        this.items = [];
        this.folders = [];
        this.selected = new Set();

        // Bind methods
        this.close = this.close.bind(this);
        this.handleUpload = this.handleUpload.bind(this);
        this.handleFolderUpload = this.handleFolderUpload.bind(this);
    }

    static open(options = {}) {
        if (!window._imagePicker) {
            window._imagePicker = new ImagePicker();
        }
        window._imagePicker.show(options);
    }

    show(options) {
        this.options = { ...this.options, ...options };
        this.isOpen = true;
        this.selected.clear();
        this.activeTab = 'library';

        // Adjust modal styling for large content
        const modalContent = document.getElementById('modal-content');
        if (modalContent) {
            // Save original classes to restore later if needed, or just hardcode reset
            this.originalClasses = modalContent.className;
            // Remove width and padding constraints
            modalContent.classList.remove('max-w-md', 'p-6', 'w-full');
            // Add wider constraints and no padding (header/footer handles it)
            modalContent.classList.add('max-w-5xl', 'w-[800px]', 'p-0', 'overflow-hidden');
        }

        // Open modal with content
        openModal(this.getModalContent());

        // Fetch data and populate content
        this.fetchData();
    }

    close() {
        this.isOpen = false;

        // Restore modal styling
        const modalContent = document.getElementById('modal-content');
        if (modalContent) {
            // Reset to default standard modal styles found in layout
            modalContent.className = 'bg-zinc-900 border border-zinc-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200 [&.active]:scale-100';
        }

        closeModal();
    }

    async fetchData() {
        try {
            const res = await fetch('/images/list');
            const data = await res.json();
            this.allItems = data.images || [];
            this.allFolders = data.folders || [];
            this.items = [...this.allItems];
            this.folders = [...this.allFolders];
            this.renderContent();
        } catch (e) {
            console.error("Failed to load images", e);
        }
    }

    // Call this when switching tabs or updating UI
    render() {
        // Find existing container in modal or re-open modal if needed
        const container = document.getElementById('ip-modal-container');
        if (container) {
            container.outerHTML = this.getModalContent();
            this.renderContent(); // Re-populate content area
        }
    }

    getModalContent() {
        // Removed outer shell styling (bg, border, shadow) since modal-content handles it
        // Kept w-full h-[600px] flex flex-col to fill the modal-content
        return `
            <div id="ip-modal-container" class="w-full h-[600px] flex flex-col animate-in fade-in zoom-in duration-200">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/50">
                    <h3 class="text-lg font-semibold text-white">Select Image</h3>
                    <button class="text-zinc-500 hover:text-white" onclick="window._imagePicker.close()">✕</button>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-zinc-800 bg-zinc-900/30">
                    ${this.renderTab('library', 'Library')}
                    ${this.renderTab('upload', 'Upload Files')}
                    ${this.options.folderSelect ? this.renderTab('folders', 'Upload Folder') : ''}
                    <div class="flex-1"></div>
                    <div class="p-2">
                        <input type="text" placeholder="Search..." class="bg-zinc-950 border border-zinc-700 rounded px-3 py-1 text-sm text-zinc-300 focus:border-teal-500 outline-none" oninput="window._imagePicker.filter(this.value)">
                    </div>
                </div>

                <!-- Content -->
                <div id="ip-content" class="flex-1 overflow-y-auto p-6 bg-zinc-950/30 relative">
                    <!-- Loading... -->
                    <div class="flex justify-center items-center h-full text-zinc-500">Loading...</div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 border-t border-zinc-800 bg-zinc-900/50 flex justify-between items-center">
                    <div class="text-sm text-zinc-500">
                        ${this.options.multiselect ? '<span id="ip-count">0</span> selected' : ''}
                    </div>
                    <div class="flex gap-3">
                        <button class="px-4 py-2 text-zinc-400 hover:text-white" onclick="window._imagePicker.close()">Cancel</button>
                        <button class="px-6 py-2 bg-teal-600 hover:bg-teal-500 text-white rounded-lg font-medium shadow-lg shadow-teal-900/20" onclick="window._imagePicker.confirm()">
                            Select
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    renderTab(id, label) {
        const active = this.activeTab === id;
        return `
            <button 
                class="px-6 py-3 text-sm font-medium border-b-2 transition-colors ${active ? 'border-teal-500 text-teal-500 bg-teal-500/5' : 'border-transparent text-zinc-400 hover:text-white hover:bg-zinc-800/50'}"
                onclick="window._imagePicker.switchTab('${id}')"
            >
                ${label}
            </button>
        `;
    }

    switchTab(tab) {
        this.activeTab = tab;
        this.render(); // Re-render shell
        this.renderContent(); // Render content
    }

    renderContent() {
        const container = document.getElementById('ip-content');
        if (!container) return;

        if (this.activeTab === 'library') {
            if (this.items.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-zinc-500 pb-10">
                    <div class="text-4xl mb-4 opacity-20">🖼️</div>
                    <p>No images found</p>
                    <button class="mt-4 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm text-zinc-300" onclick="window._imagePicker.switchTab('upload')">Upload Image</button>
                </div>`;
                return;
            }
            container.innerHTML = `
                <div class="grid grid-cols-4 gap-4">
                    ${this.items.map(item => this.renderCard(item)).join('')}
                </div>
            `;
        } else if (this.activeTab === 'upload') {
            container.innerHTML = `
                <div class="h-full border-2 border-dashed border-zinc-700 rounded-xl flex flex-col items-center justify-center gap-4 text-zinc-400 hover:border-teal-500 hover:bg-zinc-800/20 transition-all cursor-pointer"
                     onclick="document.getElementById('ip-file-input').click()"
                     ondragover="event.preventDefault(); this.classList.add('border-teal-500')"
                     ondragleave="event.preventDefault(); this.classList.remove('border-teal-500')"
                     ondrop="event.preventDefault(); window._imagePicker.handleDrop(event)"
                >
                    <div class="text-4xl">☁️</div>
                    <p class="font-medium">Click to upload or drag & drop</p>
                    <p class="text-xs text-zinc-500">Supports PNG, JPG, WEBP</p>
                    <input type="file" id="ip-file-input" class="hidden" multiple accept="image/*" onchange="window._imagePicker.handleUpload(this.files)">
                </div>
            `;
        } else if (this.activeTab === 'folders') {
            // Folder Upload UI
            container.innerHTML = `
                <div class="flex flex-col h-full">
                    <div class="mb-6 p-6 border-2 border-dashed border-zinc-700 rounded-xl flex flex-col items-center justify-center gap-4 text-zinc-400 hover:border-teal-500 hover:bg-zinc-800/20 transition-all cursor-pointer"
                        onclick="document.getElementById('ip-folder-input').click()">
                        <div class="text-4xl">📂</div>
                        <p class="font-medium">Click to upload a folder</p>
                        <p class="text-xs text-zinc-500">Recursively uploads all images</p>
                        <input type="file" id="ip-folder-input" class="hidden" webkitdirectory directory onchange="window._imagePicker.handleFolderUpload(this.files)">
                    </div>
                    
                    <h3 class="text-sm font-semibold text-zinc-400 uppercase tracking-wider mb-3">Managed Folders</h3>
                    <div class="space-y-2">
                        ${this.folders.length === 0 ? '<p class="text-zinc-500 text-sm italic">No folders uploaded yet</p>' : ''}
                        ${this.folders.map(f => `
                            <div class="flex items-center justify-between p-3 bg-zinc-900 border border-zinc-800 rounded-lg hover:border-zinc-700 group">
                                <div class="flex items-center gap-3">
                                    <span class="text-xl">📁</span>
                                    <div>
                                        <div class="text-sm font-medium text-zinc-200">${f.name}</div>
                                        <div class="text-xs text-zinc-500 font-mono">${f.path}</div>
                                    </div>
                                </div>
                                <button class="px-3 py-1 bg-zinc-800 hover:bg-teal-500/20 hover:text-teal-400 text-xs rounded transition-colors" onclick="window._imagePicker.selectFolder('${f.id}')">Select</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    }

    renderCard(item) {
        const selected = this.selected.has(item.id);
        const name = item.name;
        const url = `/images/raw/${item.id}`;

        return `
            <div class="group relative aspect-square bg-zinc-900 rounded-lg border-2 overflow-hidden cursor-pointer transition-all ${selected ? 'border-teal-500 ring-2 ring-teal-500/20' : 'border-zinc-800 hover:border-zinc-600'}"
                 onclick="window._imagePicker.toggleSelect('${item.id}')">
                <img src="${url}" class="w-full h-full object-cover transition-transform group-hover:scale-105" loading="lazy" onerror="this.src='/assets/placeholder.png'">
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-2">
                    <span class="text-xs text-white truncate w-full shadow-black drop-shadow-md">${name}</span>
                </div>
                ${selected ? '<div class="absolute top-2 right-2 bg-teal-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow-lg">✓</div>' : ''}
            </div>
        `;
    }

    toggleSelect(id) {
        if (this.options.multiselect) {
            if (this.selected.has(id)) this.selected.delete(id);
            else this.selected.add(id);
        } else {
            this.selected.clear();
            this.selected.add(id);
        }
        this.renderContent();
        this.updateCount();
    }

    selectFolder(id) {
        // Find folder obj
        const f = this.folders.find(x => x.id === id);
        if (this.options.onSelect && f) {
            this.options.onSelect([{ type: 'folder', ...f }]);
            this.close();
        }
    }

    updateCount() {
        const el = document.getElementById('ip-count');
        if (el) el.innerText = this.selected.size;
    }

    async handleUpload(files) {
        if (!files || files.length === 0) return;

        const formData = new FormData();
        Array.from(files).forEach(f => formData.append('files', f));

        // Show loading state
        document.getElementById('ip-content').innerHTML = '<div class="flex justify-center items-center h-full text-zinc-400">Uploading...</div>';

        try {
            const res = await fetch('/images/upload', {
                method: 'POST',
                body: formData
            });
            if (res.ok) {
                if (window.showToast) window.showToast('Images uploaded successfully', 'success');
                this.switchTab('library');
                this.fetchData(); // Refresh list
            } else {
                if (window.showToast) window.showToast('Upload failed', 'error');
                else alert('Upload failed');
                this.switchTab('upload');
            }
        } catch (e) {
            console.error(e);
            if (window.showToast) window.showToast('Upload error', 'error');
            else alert('Upload error');
        }
    }

    async handleFolderUpload(files) {
        if (!files || files.length === 0) return;

        const formData = new FormData();
        const folderName = files[0].webkitRelativePath.split('/')[0] || "Uploaded Folder";
        formData.append('folder_name', folderName);

        Array.from(files).forEach(f => {
            formData.append('files', f);
            formData.append('paths', f.webkitRelativePath);
        });

        // Show loading state
        document.getElementById('ip-content').innerHTML = '<div class="flex justify-center items-center h-full text-zinc-400">Uploading folder... This may take a while.</div>';

        try {
            const res = await fetch('/images/upload_folder', {
                method: 'POST',
                body: formData
            });
            if (res.ok) {
                if (window.showToast) window.showToast('Folder uploaded successfully', 'success');
                // Return to folders tab
                this.switchTab('folders');
                this.fetchData();
            } else {
                if (window.showToast) window.showToast('Folder upload failed', 'error');
                else alert('Folder upload failed');
            }
        } catch (e) {
            console.error(e);
            if (window.showToast) window.showToast('Folder upload error', 'error');
            else alert('Folder upload error');
        }
    }

    handleDrop(e) {
        const files = e.dataTransfer.files;
        this.handleUpload(files);
    }

    filter(query) {
        if (!this.allItems) return;
        const q = query.toLowerCase();

        if (this.activeTab === 'library') {
            this.items = this.allItems.filter(i => i.name.toLowerCase().includes(q));
        } else if (this.activeTab === 'folders') {
            this.folders = this.allFolders.filter(f => f.name.toLowerCase().includes(q));
        }
        this.renderContent();
    }

    confirm() {
        if (this.selected.size === 0) return;

        const selectedItems = this.items.filter(i => this.selected.has(i.id));
        if (this.options.onSelect) {
            this.options.onSelect(selectedItems);
        }
        this.close();
    }
}

class HyprlockEditor {
    constructor() {
        this.config = null;
        this.widgets = []; // array of { id, type, data, element }
        this.selectedId = null;
        this.canvas = document.getElementById('editor-canvas');
        this.scale = 0.5;
        this.dragState = { active: false, startX: 0, startY: 0, initialLeft: 0, initialTop: 0 };

        // Preset management
        this.presets = [];
        this.activePreset = null;
        this.saveTimeout = null;

        this.init();
    }

    async init() {
        this.setupDragAndDrop();
        this.setupCanvasInteractions();
        this.setupCanvasControls();
        await Promise.all([
            this.loadConfig(),
            this.loadPresets()
        ]);
        this.render();
        this.renderPresetSelector();
        setTimeout(() => this.fitToContainer(), 100);
    }

    setupCanvasControls() {
        // Canvas size dropdown
        const sizeSelect = document.getElementById('canvas-size');
        if (sizeSelect) {
            sizeSelect.onchange = (e) => {
                const [w, h] = e.target.value.split('x').map(Number);
                this.setCanvasSize(w, h);
            };
        }

        // Zoom slider
        const zoomSlider = document.getElementById('zoom-slider');
        if (zoomSlider) {
            zoomSlider.value = this.scale * 100;
            zoomSlider.oninput = (e) => {
                this.setZoom(parseInt(e.target.value) / 100);
            };
        }

        // Zoom display
        this.updateZoomDisplay();
    }

    setCanvasSize(width, height) {
        this.canvasWidth = width;
        this.canvasHeight = height;
        this.canvas.style.width = `${width}px`;
        this.canvas.style.height = `${height}px`;
        this.render();
    }

    setZoom(scale) {
        this.scale = Math.max(0.1, Math.min(1.5, scale));
        this.canvas.style.transform = `scale(${this.scale})`;
        this.updateZoomDisplay();
    }

    updateZoomDisplay() {
        const display = document.getElementById('zoom-display');
        if (display) {
            display.textContent = `${Math.round(this.scale * 100)}%`;
        }
        const slider = document.getElementById('zoom-slider');
        if (slider) {
            slider.value = this.scale * 100;
        }
    }

    fitToContainer() {
        const container = document.getElementById('canvas-container');
        if (!container || !this.canvas) return;

        const padding = 10;
        const containerWidth = container.clientWidth - padding;
        const containerHeight = container.clientHeight - padding;

        const canvasWidth = parseInt(this.canvas.style.width) || 1920;
        const canvasHeight = parseInt(this.canvas.style.height) || 1080;

        const scaleX = containerWidth / canvasWidth;
        const scaleY = containerHeight / canvasHeight;

        const fitScale = Math.min(scaleX, scaleY, 1.5);

        this.setZoom(fitScale - 0.03);
    }

    resetZoom() {
        this.fitToContainer();
    }

    async loadConfig() {
        try {
            const res = await fetch('/hyprlock/config');
            this.config = await res.json();
            // Convert config to flat widget list
            this.flattenConfig();
        } catch (e) {
            console.error('Failed to load config', e);
        }
    }

    flattenConfig() {
        this.widgets = [];
        let idCounter = 0;

        const add = (list, type) => {
            if (!list) return;
            list.forEach(item => {
                this.widgets.push({
                    id: `w-${idCounter++}`,
                    type,
                    data: { ...item }
                });
            });
        };

        add(this.config.backgrounds, 'background');
        add(this.config.input_fields, 'input-field');
        add(this.config.labels, 'label');
        add(this.config.images, 'image');
        add(this.config.shapes, 'shape');
    }

    async saveConfig() {
        // Reconstruct config object
        const newConfig = {
            general: this.config.general || {},
            auth: this.config.auth || {},
            animations: this.config.animations || {},
            backgrounds: [],
            input_fields: [],
            labels: [],
            images: [],
            shapes: []
        };

        this.widgets.forEach(w => {
            const typeMap = {
                'background': 'backgrounds',
                'input-field': 'input_fields',
                'label': 'labels',
                'image': 'images',
                'shape': 'shapes'
            };
            if (typeMap[w.type]) {
                newConfig[typeMap[w.type]].push(w.data);
            }
        });

        try {
            const res = await fetch('/hyprlock/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newConfig)
            });

            if (res.ok) {
                showToast('Configuration saved!', 'success');
            } else {
                showToast('Failed to save configuration', 'error');
            }
        } catch (e) {
            console.error(e);
            showToast('Error saving configuration', 'error');
        }
    }

    // Debounced autosave (500ms delay)
    triggerAutosave() {
        if (this.isAutosaveEnabled()) {
            if (this.saveTimeout) clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(() => this.saveConfig(), 500);
        }
    }

    isAutosaveEnabled() {
        return typeof ArchBoard !== 'undefined' ? ArchBoard.settings.autosaveEnabled : false;
    }

    render() {
        const layer = document.getElementById('canvas-widgets-layer');
        const bgLayer = document.getElementById('canvas-background-layer');
        layer.innerHTML = '';
        bgLayer.innerHTML = '';

        // Sort by z-index (ascending - lower values render first/behind)
        const sortedWidgets = [...this.widgets].sort((a, b) => {
            const zA = a.data.zindex ?? (a.type === 'background' ? -1 : 0);
            const zB = b.data.zindex ?? (b.type === 'background' ? -1 : 0);
            return zA - zB;
        });

        sortedWidgets.forEach(widget => {
            const el = this.createWidgetElement(widget);
            widget.element = el;

            if (widget.type === 'background') {
                bgLayer.appendChild(el);
            } else {
                layer.appendChild(el);
            }
        });

        this.updateSelectionAttributes();
    }

    createWidgetElement(widget) {
        const el = document.createElement('div');
        el.id = widget.id;
        // pointer-events-auto to override parent's pointer-events-none
        el.className = 'absolute transition-shadow hover:ring-1 hover:ring-teal-500/50 cursor-pointer select-none pointer-events-auto';

        // Z-index: use the configured value, default backgrounds to -1, others to 0
        const zindex = widget.data.zindex ?? (widget.type === 'background' ? -1 : 0);
        el.style.zIndex = zindex + 10; // Offset by 10 so -1 becomes 9, 0 becomes 10, etc.

        const [posX, posY] = this.parseVec2(widget.data.position || "0, 0");
        const centerX = 1920 / 2;
        const centerY = 1080 / 2;

        // Apply alignment
        const halign = widget.data.halign || 'center';
        const valign = widget.data.valign || 'center';

        // Base Point based on align
        let baseX = centerX;
        let baseY = centerY;

        if (halign === 'left') baseX = 0;
        if (halign === 'right') baseX = 1920;
        if (valign === 'top') baseY = 0;
        if (valign === 'bottom') baseY = 1080;

        // Y coordinate flipper: Hyprlock Y is UP, CSS Y is Down
        const cssY = -posY;

        el.style.left = `${baseX + posX}px`;
        el.style.top = `${baseY + cssY}px`;

        // Transformations for anchor point
        let translateX = '0%';
        let translateY = '0%';

        if (halign === 'center') translateX = '-50%';
        if (halign === 'right') translateX = '-100%';

        if (valign === 'center') translateY = '-50%';
        if (valign === 'bottom') translateY = '-100%';

        el.style.transform = `translate(${translateX}, ${translateY})`;

        // Content Rendering
        this.renderWidgetContent(el, widget);

        // Events
        el.onmousedown = (e) => this.handleMouseDown(e, widget);

        return el;
    }

    renderWidgetContent(el, widget) {
        const d = widget.data;

        if (widget.type === 'label') {
            let text = d.text || "Label";

            // Text Parsing logic for preview
            if (text.startsWith('cmd[')) {
                // Extract the command part after ]
                const cmdMatch = text.match(/cmd\[.*?\](.*)/);
                if (cmdMatch) {
                    let cmdText = cmdMatch[1].trim();
                    // Try to extract echo content
                    const echoMatch = cmdText.match(/echo\s+["'](.*)["']/);
                    if (echoMatch) {
                        text = echoMatch[1];
                        // Unescape quotes
                        text = text.replace(/\\"/g, '"');
                        text = text.replace(/\\'/g, "'");
                    } else {
                        text = cmdText; // Fallback to raw command
                    }
                }
            }

            // Variable Substitution - use actual username from environment or "shash" as fallback
            text = text.replace(/\$USER/g, 'shash');

            // Date substitution - handle $(date ...) patterns
            text = text.replace(/\$\(date\s*\+?"([^"]+)"\)/g, (match, fmt) => {
                const now = new Date();
                // Basic format substitution
                let result = fmt;
                result = result.replace('%A', now.toLocaleDateString('en-US', { weekday: 'long' }));
                result = result.replace('%d', String(now.getDate()).padStart(2, '0'));
                result = result.replace('%m', String(now.getMonth() + 1).padStart(2, '0'));
                result = result.replace('%Y', now.getFullYear());
                result = result.replace('%-I', now.getHours() % 12 || 12);
                result = result.replace('%I', String(now.getHours() % 12 || 12).padStart(2, '0'));
                result = result.replace('%M', String(now.getMinutes()).padStart(2, '0'));
                result = result.replace('%p', now.getHours() >= 12 ? 'PM' : 'AM');
                return result;
            });

            // Also handle simpler $(date) or $TIME
            text = text.replace(/\$TIME12/g, new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }));
            text = text.replace(/\$TIME/g, new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }));

            // Strip pango span tags for simple preview, but keep the text
            text = text.replace(/<span[^>]*>/g, '').replace(/<\/span>/g, '');

            el.innerText = text; // Use innerText for safety, or innerHTML if you want span styling

            // Color
            el.style.color = this.parseColor(d.color);
            el.style.fontSize = `${d.font_size || 16}pt`;
            el.style.fontFamily = d.font_family || 'Sans';
            // Rotation - need to preserve existing transform
            const existingTransform = el.style.transform || '';
            if (d.rotate) el.style.transform = existingTransform + ` rotate(${d.rotate}deg)`;
            el.style.whiteSpace = 'nowrap';
            // Shadow
            if (d.shadow_passes > 0 && d.shadow_size > 0) {
                el.style.textShadow = `2px 2px ${d.shadow_size}px ${this.parseColor(d.shadow_color || 'black')}`;
            }

        } else if (widget.type === 'input-field') {
            const [w, h] = this.parseVec2(d.size || "200, 50");
            el.style.width = `${w}px`;
            el.style.height = `${h}px`;
            el.style.backgroundColor = this.parseColor(d.inner_color);
            el.style.border = `${d.outline_thickness || 0}px solid ${this.parseColor(d.outer_color)}`;
            el.style.borderRadius = d.rounding === -1 ? `${h / 2}px` : `${d.rounding}px`;

            el.classList.add('flex', 'items-center', 'justify-center', 'text-sm');
            if (d.placeholder_text) {
                const temp = document.createElement('div');
                temp.innerHTML = d.placeholder_text;
                el.innerText = temp.innerText || 'Input Password...';
            } else {
                el.innerText = 'Input Password...';
            }
            el.style.color = this.parseColor(d.font_color);

        } else if (widget.type === 'shape') {
            const [w, h] = this.parseVec2(d.size || "100, 100");
            el.style.width = `${w}px`;
            el.style.height = `${h}px`;
            el.style.backgroundColor = this.parseColor(d.color);

            if (d.rounding === -1) el.style.borderRadius = `${Math.min(w, h) / 2}px`;
            else if (d.rounding) el.style.borderRadius = `${d.rounding}px`;

            if (d.rotate) el.style.transform += ` rotate(${d.rotate}deg)`;

        } else if (widget.type === 'image') {
            const targetSize = parseInt(d.size) || 150;
            el.style.overflow = 'hidden';

            // Border on container
            if (d.border_size) {
                el.style.border = `${d.border_size}px solid ${this.parseColor(d.border_color)}`;
            }

            const img = document.createElement('img');

            // Build image URL
            let imgUrl = '/assets/placeholder.png';
            if (d.path) {
                if (d.path.includes('.archboard/images/')) {
                    const filename = d.path.split('/').pop();
                    const id = filename.split('.')[0];
                    imgUrl = `/images/raw/${id}`;
                } else {
                    imgUrl = `/hyprlock/images/preview?path=${encodeURIComponent(d.path)}`;
                }
            }
            img.src = imgUrl;

            // When image loads, calculate proper dimensions based on aspect ratio
            // Size = scale based on the lesser side of the image
            img.onload = () => {
                const naturalW = img.naturalWidth;
                const naturalH = img.naturalHeight;
                const lesserSide = Math.min(naturalW, naturalH);
                const scale = targetSize / lesserSide;

                const displayW = Math.round(naturalW * scale);
                const displayH = Math.round(naturalH * scale);

                el.style.width = `${displayW}px`;
                el.style.height = `${displayH}px`;

                // Apply rounding AFTER we know the dimensions
                // Rounding -1 means stadium/oval shape (half of lesser side creates pill shape)
                if (d.rounding === -1) {
                    const lesserDisplaySide = Math.min(displayW, displayH);
                    el.style.borderRadius = `${lesserDisplaySide / 2}px`;
                } else if (d.rounding !== undefined && d.rounding !== 0) {
                    el.style.borderRadius = `${d.rounding}px`;
                }

                img.style.width = '100%';
                img.style.height = '100%';
            };

            // Set initial size while loading
            el.style.width = `${targetSize}px`;
            el.style.height = `${targetSize}px`;
            el.style.borderRadius = `${targetSize / 2}px`; // Initial circular while loading
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.style.display = 'block';

            if (d.rotate) {
                const existingTransform = el.style.transform || '';
                el.style.transform = existingTransform + ` rotate(${d.rotate}deg)`;
            }

            el.appendChild(img);
        } else if (widget.type === 'background') {
            // Add classes without removing base classes (keeps it clickable/selectable)
            el.classList.add('inset-0', 'w-full', 'h-full', 'bg-black');
            el.style.position = 'absolute';
            el.style.cursor = 'pointer';

            if (d.path && d.path !== 'screenshot') {
                let url = '';
                if (d.path.includes('.archboard/images/')) {
                    const id = d.path.split('/').pop().split('.')[0];
                    url = `/images/raw/${id}`;
                } else {
                    url = `/hyprlock/images/preview?path=${encodeURIComponent(d.path)}`;
                }
                el.style.backgroundImage = `url('${url}')`;
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
            }
            el.style.backgroundColor = this.parseColor(d.color);
            // Blur effect simulation
            if (d.blur_passes > 0) el.style.filter = `blur(${d.blur_passes * (d.blur_size || 1)}px)`;
        }
    }

    parseVec2(str) {
        if (!str) return [0, 0];
        const parts = str.split(',').map(s => parseFloat(s.trim()));
        return [parts[0] || 0, parts[1] || 0];
    }

    parseColor(str) {
        if (!str) return 'transparent';
        // Handle "$variable" - common fallbacks
        if (str.startsWith('$')) {
            if (str === '$foreground') return '#ffffff';
            if (str === '$background') return '#000000';
            return '#aaaaaa'; // Generic variable fallback
        }
        // Handle custom hex "0xff..." -> "#..."
        if (str.startsWith('0x')) {
            return '#' + str.substring(2);
        }
        // rgba/rgb/hex are valid CSS, just return
        return str;
    }

    handleMouseDown(e, widget) {
        e.stopPropagation();
        this.selectedId = widget.id;
        this.render(); // update selection outline
        this.renderPropertiesPanel(widget);

        if (widget.type === 'background') return; // Can't drag BG

        // Drag Start
        this.dragState.active = true;
        this.dragState.startX = e.clientX;
        this.dragState.startY = e.clientY;

        // Store initial Hyprlock pos
        const [x, y] = this.parseVec2(widget.data.position || "0, 0");
        this.dragState.initialX = x;
        this.dragState.initialY = y; // Hyprlock Y

        // Global Move Listener
        const onMove = (em) => {
            if (!this.dragState.active) return;
            const dx = (em.clientX - this.dragState.startX) / this.scale;
            const dy = (em.clientY - this.dragState.startY) / this.scale;

            // Hyprlock Y is UP, so screen dy maps to -HyprlockY
            const newX = Math.round(this.dragState.initialX + dx);
            const newY = Math.round(this.dragState.initialY - dy);

            widget.data.position = `${newX}, ${newY}`;
            this.render();
            // Debounce property panel update?
            const panel = document.getElementById('properties-panel');
            // Updating inputs directly is hard without ID refs, just re-rendering panel on drop or throttling
        };

        const onUp = () => {
            this.dragState.active = false;
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            // Final update of properties panel
            this.renderPropertiesPanel(widget);
        };

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
    }

    setupDragAndDrop() {
        const toolboxItems = document.querySelectorAll('.draggable-widget');
        toolboxItems.forEach(item => {
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', item.dataset.type);
            });
        });

        this.canvas.addEventListener('dragover', (e) => e.preventDefault());
        this.canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            if (type) this.addWidget(type);
        });
    }

    addWidget(type) {
        const defaults = {
            'label': {
                monitor: '',
                text: 'Sample Text',
                text_align: 'center',
                color: 'rgba(254, 254, 254, 1.0)',
                font_size: 16,
                font_family: 'Sans',
                rotate: 0,
                shadow_passes: 0,
                shadow_size: 3,
                shadow_color: 'rgb(0,0,0)',
                shadow_boost: 1.2,
                zindex: 0
            },
            'input-field': {
                monitor: '',
                size: '400, 90',
                outline_thickness: 4,
                dots_size: 0.25,
                dots_spacing: 0.15,
                dots_center: true,
                dots_rounding: -1,
                outer_color: 'rgba(17, 17, 17, 1.0)',
                inner_color: 'rgba(200, 200, 200, 1.0)',
                font_color: 'rgba(10, 10, 10, 1.0)',
                font_family: 'Noto Sans',
                fade_on_empty: true,
                fade_timeout: 2000,
                placeholder_text: '<i>Input Password...</i>',
                hide_input: false,
                rounding: -1,
                check_color: 'rgba(204, 136, 34, 1.0)',
                fail_color: 'rgba(204, 34, 34, 1.0)',
                fail_text: '<i>$FAIL <b>($ATTEMPTS)</b></i>',
                shadow_passes: 0,
                shadow_size: 3,
                shadow_color: 'rgb(0,0,0)',
                shadow_boost: 1.2,
                zindex: 0
            },
            'shape': {
                monitor: '',
                size: '100, 100',
                color: 'rgba(17, 17, 17, 1.0)',
                rounding: -1,
                rotate: 0,
                border_size: 0,
                border_color: 'rgba(0, 207, 230, 1.0)',
                xray: false,
                shadow_passes: 0,
                shadow_size: 3,
                shadow_color: 'rgb(0,0,0)',
                shadow_boost: 1.2,
                zindex: 0
            },
            'image': {
                monitor: '',
                path: '',
                size: 150,
                rounding: -1,
                border_size: 4,
                border_color: 'rgba(221, 221, 221, 1.0)',
                rotate: 0,
                reload_time: -1,
                reload_cmd: '',
                shadow_passes: 0,
                shadow_size: 3,
                shadow_color: 'rgb(0,0,0)',
                shadow_boost: 1.2,
                zindex: 0
            },
            'background': {
                monitor: '',
                path: '',
                color: 'rgba(17, 17, 17, 1.0)',
                blur_passes: 0,
                blur_size: 7,
                noise: 0.0117,
                contrast: 0.8916,
                brightness: 0.8172,
                vibrancy: 0.1696,
                vibrancy_darkness: 0.05,
                reload_time: -1,
                reload_cmd: '',
                crossfade_time: -1.0,
                zindex: -1
            }
        };

        this.widgets.push({
            id: `w-${Date.now()}`,
            type,
            data: {
                ...defaults[type],
                position: '0, 0',
                halign: 'center',
                valign: 'center'
            }
        });
        this.render();
    }

    setupCanvasInteractions() {
        // Get the scrollable container (parent of centering wrapper)
        const container = this.canvas.closest('.overflow-auto');

        let isPanning = false;
        let panStartX = 0;
        let panStartY = 0;
        let scrollStartX = 0;
        let scrollStartY = 0;

        // Click to deselect - only if clicked on canvas layers directly, not on widgets
        this.canvas.onclick = (e) => {
            // Check if we clicked directly on the canvas or its layer containers (not a widget)
            const clickedLayerOrCanvas =
                e.target === this.canvas ||
                e.target.id === 'canvas-background-layer' ||
                e.target.id === 'canvas-widgets-layer';

            // Check if we clicked on a widget (including background widgets)
            const clickedWidget = e.target.closest('[id^="w-"]');

            if (clickedLayerOrCanvas && !clickedWidget) {
                this.selectedId = null;
                this.render();
                this.renderPropertiesPanel(null);
            }
        };

        // Pan on mouse drag in container
        if (container) {
            container.onmousedown = (e) => {
                // Only pan if clicking directly on container or canvas background, not widgets
                const isOnWidget = e.target.closest('.absolute.transition-shadow');
                if (isOnWidget) return;

                isPanning = true;
                panStartX = e.clientX;
                panStartY = e.clientY;
                scrollStartX = container.scrollLeft;
                scrollStartY = container.scrollTop;
                container.style.cursor = 'grabbing';
                e.preventDefault();
            };

            container.onmousemove = (e) => {
                if (!isPanning) return;
                const dx = e.clientX - panStartX;
                const dy = e.clientY - panStartY;
                container.scrollLeft = scrollStartX - dx;
                container.scrollTop = scrollStartY - dy;
            };

            container.onmouseup = () => {
                isPanning = false;
                container.style.cursor = 'default';
            };

            container.onmouseleave = () => {
                isPanning = false;
                container.style.cursor = 'default';
            };

            // Set default cursor
            container.style.cursor = 'grab';
        }
    }

    updateSelectionAttributes() {
        this.widgets.forEach(w => {
            if (this.selectedId === w.id) {
                w.element.classList.add('ring-2', 'ring-teal-500', 'z-50');
            } else {
                w.element.classList.remove('ring-2', 'ring-teal-500', 'z-50');
            }
        });
    }

    renderPropertiesPanel(widget) {
        const panel = document.getElementById('properties-panel');
        if (!widget) {
            panel.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-zinc-500 gap-2 opacity-60"><span class="text-4xl">👆</span><p class="text-sm">Select a widget to edit</p></div>`;
            return;
        }

        // Define property groups by widget type
        const propertyGroups = this.getPropertyGroups(widget.type);

        let html = `
            <div class="space-y-4">
                <div class="flex items-center justify-between pb-2 border-b border-zinc-800">
                     <span class="text-xs font-bold text-teal-500 uppercase">${widget.type}</span>
                     <button class="text-xs text-red-500 hover:text-red-400" onclick="hyprlockEditor.deleteWidget('${widget.id}')">Delete</button>
                </div>
        `;

        for (const group of propertyGroups) {
            const groupFields = group.fields.map(key => {
                const value = widget.data[key] ?? this.getDefaultValue(widget.type, key);
                return this.renderField(key, value, widget);
            }).join('');

            if (groupFields.trim()) {
                html += `
                    <div class="space-y-2">
                        <div class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">${group.name}</div>
                        ${groupFields}
                    </div>
                `;
            }
        }

        html += `</div>`;
        panel.innerHTML = html;
    }

    getPropertyGroups(type) {
        const common = [
            { name: 'Position', fields: ['position', 'halign', 'valign', 'zindex'] }
        ];

        const shadow = { name: 'Shadow', fields: ['shadow_passes', 'shadow_size', 'shadow_color', 'shadow_boost'] };

        switch (type) {
            case 'background':
                return [
                    { name: 'Appearance', fields: ['path', 'color'] },
                    { name: 'Blur', fields: ['blur_passes', 'blur_size', 'noise', 'contrast', 'brightness', 'vibrancy', 'vibrancy_darkness'] },
                    { name: 'Options', fields: ['reload_time', 'reload_cmd', 'crossfade_time', 'zindex'] }
                ];
            case 'image':
                return [
                    { name: 'Source', fields: ['path', 'size'] },
                    { name: 'Style', fields: ['rounding', 'border_size', 'border_color', 'rotate'] },
                    ...common, shadow
                ];
            case 'shape':
                return [
                    { name: 'Appearance', fields: ['size', 'color', 'rounding', 'rotate'] },
                    { name: 'Border', fields: ['border_size', 'border_color', 'xray'] },
                    ...common, shadow
                ];
            case 'input-field':
                return [
                    { name: 'Size & Shape', fields: ['size', 'outline_thickness', 'rounding'] },
                    { name: 'Colors', fields: ['outer_color', 'inner_color', 'font_color', 'check_color', 'fail_color'] },
                    { name: 'Dots', fields: ['dots_size', 'dots_spacing', 'dots_center', 'dots_rounding'] },
                    { name: 'Text', fields: ['font_family', 'placeholder_text', 'fail_text'] },
                    { name: 'Behavior', fields: ['fade_on_empty', 'fade_timeout', 'hide_input'] },
                    ...common, shadow
                ];
            case 'label':
                return [
                    { name: 'Content', fields: ['text', 'text_align'] },
                    { name: 'Style', fields: ['color', 'font_size', 'font_family', 'rotate'] },
                    ...common, shadow
                ];
            default:
                return [{ name: 'Properties', fields: Object.keys(this.widgets.find(w => w.type === type)?.data || {}) }];
        }
    }

    getDefaultValue(type, key) {
        const defaults = {
            'zindex': type === 'background' ? -1 : 0,
            'halign': 'center',
            'valign': 'center',
            'position': '0, 0',
            'rounding': -1,
            'shadow_passes': 0,
            'shadow_size': 3,
            'shadow_color': 'rgb(0,0,0)',
            'shadow_boost': 1.2,
            'blur_passes': 0,
            'blur_size': 7,
            'rotate': 0,
            'border_size': 0,
            'size': type === 'image' ? 150 : '100, 100',
        };
        return defaults[key] ?? '';
    }

    renderField(key, value, widget) {
        let input = '';
        const inputClass = "w-full bg-zinc-950 border border-zinc-700 rounded px-2 py-1 text-xs text-white focus:border-teal-500 outline-none";
        const val = value ?? '';

        // Color fields
        if (key.includes('color')) {
            input = `
                <div class="flex gap-2">
                    <input type="text" class="${inputClass} flex-1" value="${val}" onchange="hyprlockEditor.updateWidget('${widget.id}', '${key}', this.value)">
                    <input type="color" class="w-8 h-6 bg-transparent border-0 cursor-pointer rounded" value="${this.rgbToHex(val)}" onchange="hyprlockEditor.updateWidget('${widget.id}', '${key}', this.value)">
                </div>`;
        }
        // Path fields with image picker
        else if (key === 'path') {
            input = `
                <div class="flex gap-2">
                     <input type="text" class="${inputClass} flex-1" value="${val}" onchange="hyprlockEditor.updateWidget('${widget.id}', '${key}', this.value)">
                     <button class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 rounded border border-zinc-700 text-xs shrink-0" onclick="hyprlockEditor.openImagePicker('${widget.id}')">📁</button>
                </div>`;
        }
        // Text/multiline fields
        else if (key === 'text' || key === 'placeholder_text' || key === 'fail_text') {
            input = `<textarea class="${inputClass}" rows="2" onchange="hyprlockEditor.updateWidget('${widget.id}', '${key}', this.value)">${val}</textarea>`;
        }
        // Alignment dropdowns
        else if (key === 'halign') {
            input = this.renderSelect(widget.id, key, val, ['left', 'center', 'right', 'none']);
        }
        else if (key === 'valign') {
            input = this.renderSelect(widget.id, key, val, ['top', 'center', 'bottom', 'none']);
        }
        else if (key === 'text_align') {
            input = this.renderSelect(widget.id, key, val, ['left', 'center', 'right']);
        }
        // Boolean fields
        else if (['fade_on_empty', 'hide_input', 'dots_center', 'xray'].includes(key)) {
            input = `
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" class="w-4 h-4 accent-teal-500" ${val ? 'checked' : ''} onchange="hyprlockEditor.updateWidget('${widget.id}', '${key}', this.checked)">
                    <span class="text-xs text-zinc-300">${val ? 'Enabled' : 'Disabled'}</span>
                </label>`;
        }
        // Number fields
        else if (['zindex', 'rotate', 'font_size', 'border_size', 'outline_thickness', 'blur_passes', 'blur_size',
            'shadow_passes', 'shadow_size', 'shadow_boost', 'rounding', 'dots_rounding', 'fade_timeout',
            'contrast', 'brightness', 'vibrancy', 'vibrancy_darkness', 'noise', 'reload_time', 'crossfade_time',
            'dots_size', 'dots_spacing'].includes(key)) {
            input = `<input type="number" step="any" class="${inputClass}" value="${val}" onchange="hyprlockEditor.updateWidget('${widget.id}', '${key}', parseFloat(this.value) || 0)">`;
        }
        // Default text input
        else {
            input = `<input type="text" class="${inputClass}" value="${val}" onchange="hyprlockEditor.updateWidget('${widget.id}', '${key}', this.value)">`;
        }

        return `
            <div class="space-y-1">
                <label class="text-xs text-zinc-400 capitalize">${key.replace(/_/g, ' ')}</label>
                ${input}
            </div>
        `;
    }

    renderSelect(widgetId, key, value, options) {
        const inputClass = "w-full bg-zinc-950 border border-zinc-700 rounded px-2 py-1 text-xs text-white focus:border-teal-500 outline-none";
        return `
            <select class="${inputClass}" onchange="hyprlockEditor.updateWidget('${widgetId}', '${key}', this.value)">
                ${options.map(o => `<option value="${o}" ${value === o ? 'selected' : ''}>${o}</option>`).join('')}
            </select>`;
    }

    updateWidget(id, key, value) {
        const w = this.widgets.find(x => x.id === id);
        if (w) {
            // Auto-convert numbers (only if value is a string)
            if (typeof value === 'string' && !isNaN(value) && value.trim() !== '' &&
                !key.includes('color') && !key.includes('text') && !key.includes('position') && !key.includes('path')) {
                value = Number(value);
            }
            w.data[key] = value;
            this.render();
            // Re-render properties panel to show updated values
            this.renderPropertiesPanel(w);
            // Trigger autosave
            this.triggerAutosave();
        }
    }

    deleteWidget(id) {
        this.widgets = this.widgets.filter(w => w.id !== id);
        this.selectedId = null;
        this.render();
        this.renderPropertiesPanel(null);
        showToast('Widget deleted', 'info');
        this.triggerAutosave();
    }

    openImagePicker(widgetId) {
        ImagePicker.open({
            multiselect: false,
            onSelect: (items) => {
                if (items.length > 0) {
                    // We store the full path if possible, or ID if we want to resolve later?
                    // Config needs specific path.
                    // items[0] = { id, name, path }
                    this.updateWidget(widgetId, 'path', items[0].path);
                    // Force re-render properties to show new path
                    const w = this.widgets.find(x => x.id === widgetId);
                    this.renderPropertiesPanel(w);
                }
            }
        });
    }

    rgbToHex(str) {
        // Helper to convert rgba string to hex for color picker input
        if (!str) return '#000000';
        if (str.startsWith('#')) return str;
        // simplistic parser
        return '#ffffff';
    }

    // =========================================================================
    // PRESET MANAGEMENT
    // =========================================================================

    async loadPresets() {
        try {
            const response = await fetch('/presets/hyprlock');
            const data = await response.json();
            this.presets = data.presets || [];
            this.activePreset = data.active_preset;
        } catch (error) {
            console.error('Failed to load presets:', error);
            this.presets = [];
            this.activePreset = null;
        }
    }

    renderPresetSelector() {
        const container = document.getElementById('preset-selector');
        if (!container) return;

        const activePresetData = this.presets.find(p => p.id === this.activePreset);

        container.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-xs font-semibold text-zinc-500 uppercase">Preset:</span>
                <select id="preset-dropdown" onchange="hyprlockEditor.handlePresetChange(this.value)" 
                    class="bg-zinc-800 border-none text-zinc-200 text-sm rounded-md px-2 py-1 focus:ring-1 focus:ring-teal-500 cursor-pointer outline-none hover:bg-zinc-700">
                    <option value="">-- No Preset --</option>
                    ${this.presets.map(p => `
                        <option value="${p.id}" ${p.id === this.activePreset ? 'selected' : ''}>
                            ${p.name}
                        </option>
                    `).join('')}
                </select>
            </div>
            <div class="flex items-center gap-1">
                <button class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs rounded transition-colors" 
                    onclick="hyprlockEditor.showSavePresetModal()" title="Save as new preset">
                    💾 Save As
                </button>
                ${this.presets.length > 0 ? `
                    <button class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs rounded transition-colors"
                        onclick="hyprlockEditor.showManagePresetsModal()" title="Manage presets">
                        ⚙️
                    </button>
                ` : ''}
            </div>
        `;
    }

    async handlePresetChange(presetId) {
        if (!presetId) {
            // Deactivate current preset
            try {
                await fetch('/presets/hyprlock/deactivate', { method: 'POST' });
                this.activePreset = null;
                this.renderPresetSelector();
                showToast('Preset deactivated', 'info');
            } catch (e) {
                showToast('Failed to deactivate preset', 'error');
            }
            return;
        }

        await this.activatePreset(presetId);
    }

    async activatePreset(presetId) {
        try {
            const response = await fetch(`/presets/hyprlock/${presetId}/activate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ backup_current: true })
            });

            if (!response.ok) throw new Error('Activation failed');

            this.activePreset = presetId;

            // Reload config to reflect changes
            await this.loadConfig();
            this.render();
            this.renderPresetSelector();

            const preset = this.presets.find(p => p.id === presetId);
            showToast(`Preset "${preset?.name || presetId}" activated!`, 'success');
        } catch (e) {
            showToast('Failed to activate preset', 'error');
            document.getElementById('preset-dropdown').value = this.activePreset || '';
        }
    }

    showSavePresetModal() {
        openModal(`
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-zinc-100">Save Preset</h2>
                <button onclick="closeModal()" class="text-zinc-400 hover:text-white">✕</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-zinc-400 mb-1">Preset Name</label>
                    <input type="text" id="preset-name" placeholder="My Lockscreen Theme"
                        class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-3 py-2 text-zinc-100 focus:border-teal-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm text-zinc-400 mb-1">Description (optional)</label>
                    <textarea id="preset-description" placeholder="Dark theme with blurred background..."
                        class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-3 py-2 text-zinc-100 focus:border-teal-500 outline-none h-20 resize-none"></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button onclick="closeModal()" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg">Cancel</button>
                    <button onclick="hyprlockEditor.saveNewPreset()" class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white rounded-lg">Save Preset</button>
                </div>
            </div>
        `);
    }

    async saveNewPreset() {
        const name = document.getElementById('preset-name')?.value?.trim();
        const description = document.getElementById('preset-description')?.value?.trim() || '';

        if (!name) {
            showToast('Preset name is required', 'error');
            return;
        }

        try {
            // First save current config to file
            await this.saveConfig();

            // Then create preset from current config
            const response = await fetch('/presets/hyprlock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description })
            });

            if (!response.ok) throw new Error('Failed to create preset');

            const preset = await response.json();
            this.presets.push(preset);
            this.activePreset = preset.id;
            this.renderPresetSelector();

            closeModal();
            showToast(`Preset "${name}" saved!`, 'success');
        } catch (e) {
            showToast('Failed to save preset', 'error');
        }
    }

    showManagePresetsModal() {
        const presetRows = this.presets.map(p => `
            <div class="flex items-center justify-between p-3 bg-zinc-800/50 rounded-lg ${p.id === this.activePreset ? 'ring-1 ring-teal-500' : ''}">
                <div>
                    <div class="font-medium text-zinc-200">${p.name}</div>
                    <div class="text-xs text-zinc-500">${p.description || 'No description'}</div>
                </div>
                <div class="flex items-center gap-2">
                    ${p.id !== this.activePreset ? `
                        <button onclick="hyprlockEditor.activatePreset('${p.id}'); closeModal();" 
                            class="px-2 py-1 bg-teal-600 hover:bg-teal-500 text-white text-xs rounded">Activate</button>
                    ` : '<span class="text-xs text-teal-400">Active</span>'}
                    <button onclick="hyprlockEditor.deletePreset('${p.id}')" 
                        class="px-2 py-1 bg-red-900/50 hover:bg-red-800 text-red-300 text-xs rounded">Delete</button>
                </div>
            </div>
        `).join('');

        openModal(`
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-zinc-100">Manage Presets</h2>
                <button onclick="closeModal()" class="text-zinc-400 hover:text-white">✕</button>
            </div>
            <div class="space-y-2 max-h-80 overflow-y-auto">
                ${presetRows || '<p class="text-zinc-500 text-center py-4">No presets saved yet</p>'}
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal()" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg">Close</button>
            </div>
        `);
    }

    async deletePreset(presetId) {
        if (!confirm('Delete this preset? This cannot be undone.')) return;

        try {
            const response = await fetch(`/presets/hyprlock/${presetId}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Delete failed');

            this.presets = this.presets.filter(p => p.id !== presetId);
            if (this.activePreset === presetId) this.activePreset = null;

            this.renderPresetSelector();
            this.showManagePresetsModal(); // Refresh modal
            showToast('Preset deleted', 'success');
        } catch (e) {
            showToast('Failed to delete preset', 'error');
        }
    }
}

