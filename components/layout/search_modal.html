<!-- Search Modal (Command Palette) -->
<div id="search-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div id="search-backdrop"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0" aria-hidden="true"
        onclick="closeSearch()"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-start justify-center p-4 text-center sm:p-0 mt-20">
        <div id="search-panel"
            class="relative transform overflow-hidden rounded-xl bg-zinc-900 border border-zinc-800 text-left shadow-2xl transition-all duration-300 scale-95 opacity-0 sm:w-full sm:max-w-2xl ring-1 ring-white/10">
            <!-- Search Input -->
            <div class="relative flex items-center border-b border-zinc-800/50 p-4 sticky top-0 bg-zinc-900 z-10">
                <svg class="h-6 w-6 text-teal-500 pointer-events-none transition-colors duration-200" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="search-input"
                    class="h-full w-full bg-transparent border-0 focus:ring-0 focus:outline-none text-zinc-100 placeholder-zinc-500 pl-4 text-lg font-medium"
                    placeholder="Search settings, commands, pages..." autocomplete="off">
                <div class="ml-auto flex items-center gap-2">
                    <span class="text-xs text-zinc-500 font-medium">ESC</span>
                </div>
            </div>

            <!-- Results -->
            <div id="search-results"
                class="max-h-[60vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-zinc-900">
                <div id="search-empty" class="hidden py-16 text-center">
                    <svg class="mx-auto h-12 w-12 text-zinc-700 mb-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-zinc-500 text-sm">No results found.</p>
                </div>
                <!-- Categories will be grouped or flat list? Flat list with category badges looks modern -->
                <div id="search-list" class="p-2 space-y-1">
                    <!-- Results injected here -->
                </div>
            </div>

            <!-- Footer -->
            <div
                class="bg-zinc-900/80 px-4 py-2.5 border-t border-zinc-800/50 flex justify-between items-center text-xs text-zinc-500 select-none">
                <div class="flex gap-4">
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↑↓</kbd>
                        navigate</span>
                    <span class="flex items-center gap-1.5"><kbd
                            class="font-sans bg-zinc-800 border border-zinc-700 rounded px-1 min-w-[1.2rem] text-center">↵</kbd>
                        select</span>
                </div>
                <div class="text-zinc-600">ArchBoard Config</div>
            </div>
        </div>
    </div>
</div>

<!-- Fuse.js -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
    // Search Data
    const searchIndex = {{ search_index | tojson | safe }};
    let fuse;
    let selectedIndex = 0;

    // Elements
    const modal = document.getElementById('search-modal');
    const backdrop = document.getElementById('search-backdrop');
    const panel = document.getElementById('search-panel');
    const input = document.getElementById('search-input');
    const list = document.getElementById('search-list');
    const empty = document.getElementById('search-empty');

    // Initialize
    function initSearch() {
        const options = {
            includeScore: true,
            distance: 100, // Reduced distance for more precise prefix matching
            threshold: 0.3, // Lower threshold = stricter matching
            keys: [
                { name: 'title', weight: 0.5 }, // Title is important
                { name: 'description', weight: 0.3 }, // Description adds context
                { name: 'keywords', weight: 0.4 }, // Keywords match specific terms
                { name: 'category', weight: 0.1 } // Category is lowest priority
            ]
        };
        fuse = new Fuse(searchIndex, options);
    }

    // Toggle Modal
    function openSearch() {
        modal.classList.remove('hidden');
        // Animate in
        requestAnimationFrame(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        });

        input.value = '';
        renderResults([]);
        input.focus();
        document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
        // Animate out
        backdrop.classList.add('opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300); // Match transition duration
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            if (modal.classList.contains('hidden')) {
                openSearch();
            } else {
                closeSearch();
            }
        }

        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeSearch();
        }

        if (!modal.classList.contains('hidden')) {
            const items = list.querySelectorAll('.search-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const selected = items[selectedIndex];
                if (selected) {
                    selected.click();
                }
            }
        }
    });

    // Input Handling
    input.addEventListener('input', (e) => {
        const query = e.target.value;
        if (!query) {
            renderResults([]);
            return;
        }

        const results = fuse.search(query);
        // Take top 20 results for performance
        renderResults(results.slice(0, 20).map(r => r.item));
    });

    // Render
    function renderResults(items) {
        list.innerHTML = '';
        selectedIndex = 0;

        if (items.length === 0 && input.value) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');

        if (items.length === 0 && !input.value) {
            return;
        }

        items.forEach((item, index) => {
            const div = document.createElement('div');
            // Improved item styling
            div.className = `search-item group flex cursor-pointer select-none items-start gap-4 rounded-lg px-4 py-3 transition-colors duration-200`;

            div.onclick = () => {
                let url = item.url;
                if (item.selector) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}highlight=${encodeURIComponent(item.selector)}`;
                }
                window.location.href = url;
            };

            const isFirst = index === 0;

            // Icon based on category? Simplify to a generic arrow for now

            div.innerHTML = `
                <div class="mt-1 flex-none text-zinc-500 group-hover:text-teal-400 transition-colors">
                   ${getCategoryIcon(item.category)}
                </div>
                <div class="flex-auto overflow-hidden">
                    <div class="flex items-center gap-2 mb-0.5">
                        <span class="inline-flex items-center rounded-md bg-zinc-800/50 border border-zinc-700/50 px-1.5 py-0.5 text-[10px] font-medium text-zinc-400 uppercase tracking-wider group-hover:border-teal-500/30 group-hover:text-teal-400 transition-colors">
                            ${item.category}
                        </span>
                    </div>
                    <div class="truncate font-semibold text-sm text-zinc-200 group-hover:text-teal-400 pl-0.5">${item.title}</div>
                    ${item.description ? `<div class="mt-0.5 truncate text-xs text-zinc-500 pl-0.5 group-hover:text-zinc-400">${item.description}</div>` : ''}
                </div>
            `;
            list.appendChild(div);
        });

        if (list.children.length > 0) {
            updateSelection(list.querySelectorAll('.search-item'));
        }
    }

    function getCategoryIcon(category) {
        // Simple mapping for icons
        if (category.toLowerCase().includes('hyprland')) return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" /></svg>`;
        return `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`;
    }

    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-zinc-800');
                item.classList.remove('hover:bg-zinc-800'); // Prevent conflict
                // Ensure text colors pop
                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.add('text-teal-400');

                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('bg-zinc-800');
                item.classList.add('hover:bg-zinc-800/50'); // Subtle hover state for non-selected

                const title = item.querySelector('.text-zinc-200');
                if (title) title.classList.remove('text-teal-400');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initSearch);
</script>